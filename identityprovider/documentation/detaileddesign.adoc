= Detailed Design Documentation for Identity Provider Application

This document provides a comprehensive detailed design of the Identity Provider application implemented using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose*: Serves as the entry point for the Spring Boot application.

*Methods*:
- `public static void main(String[] args)`: Launches the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Indicates that this is a Spring Boot application.

=== JwtAuthFilter

*Purpose*: Filters incoming requests to validate JWT tokens.

*Methods*:
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters requests to check for valid JWT tokens before passing the request along the filter chain.

*Fields*:
- `userService : UserService`: Autowired service used for user-related operations.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@Component`: Indicates that the class is a Spring component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds the logger facility.

=== SecurityConfig

*Purpose*: Configuration for security aspects of the application, such as authentication and authorization.

*Methods*:
- `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Configures the authentication manager.
- `public AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
- `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Defines security filter chain.

*Fields*:
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has @Bean definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

=== UserController

*Purpose*: Controller to handle user-related operations such as registration and login.

*Methods*:
- `public ResponseEntity<Object> login(@RequestBody final User user)`: Handles user login.
- `public User registerUser(@RequestBody final User user)`: Handles user registration.

*Fields*:
- `authManager : AuthenticationManager`: Manages authentication.
- `jwtService : JWTService`: Service for JWT operations.
- `userService : UserService`: Service for user operations.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Annotation for mapping web requests onto methods in request-handling classes.
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.

=== AuthRequest

*Purpose*: DTO for authentication request data.

*Fields*:
- `password : String`: User's password.
- `username : String`: User's username.

*Annotations*:
- `@Data`: Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.

=== AuthResponse

*Purpose*: DTO for authentication response data.

=== UserPrincipal

*Purpose*: Principal object representing a user.

*Methods*:
- Various `@Override` methods to comply with UserDetails interface for Spring Security.

*Fields*:
- `user : final User`: The user entity associated with this principal.

*Annotations*:
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

=== Client

*Purpose*: Entity representing an OAuth client.

*Fields*:
- `clientName : String`: Name of the client.
- `clientSecret : String`: Secret for the client.
- `id : Long`: Primary key.
- `redirectUri : String`: URI to redirect after authentication.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate the getter methods for the fields.
- `@Id`: Specifies the primary key.
- `@Setter`: Lombok annotation to generate the setter methods for the fields.
- `@Table`: Specifies the primary table for the annotated entity.

=== Role

*Purpose*: Entity representing a user role.

*Methods*:
- Getters and setters for `id`, `name`, and `users`.

*Fields*:
- `id : Long`: Primary key.
- `name : String`: Name of the role.
- `users : Set<User>`: Users associated with this role.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Id`: Specifies the primary key.
- `@ManyToMany`: Defines a many-to-many relationship between the join Tables.
- `@Table`: Specifies the primary table for the annotated entity.

=== Token

*Purpose*: Entity representing an authentication token.

*Fields*:
- `accessToken : String`: Access token string.
- `client : Client`: Associated client.
- `id : Long`: Primary key.
- `refreshToken : String`: Refresh token string.
- `user : User`: Associated user.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate the getter methods for the fields.
- `@Id`: Specifies the primary key.
- `@JoinColumn`: Specifies a column for joining an entity association.
- `@ManyToOne`: Defines a many-to-one relationship between the join columns.
- `@Setter`: Lombok annotation to generate the setter methods for the fields.
- `@Table`: Specifies the primary table for the annotated entity.

=== User

*Purpose*: Entity representing a user.

*Fields*:
- `email : String`: Email of the user.
- `id : Long`: Primary key.
- `passwordHash : String`: Hashed password of the user.
- `roles : Set<Role>`: Roles assigned to the user.
- `username : String`: Username of the user.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Data`: Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate the getter methods for the fields.
- `@Id`: Specifies the primary key.
- `@JoinColumn`: Specifies a column for joining an entity association.
- `@JoinTable`: Specifies the table that is used for the relationship.
- `@ManyToMany`: Defines a many-to-many relationship between the join Tables.
- `@Setter`: Lombok annotation to generate the setter methods for the fields.
- `@Table`: Specifies the primary table for the annotated entity.

=== UserRepository

*Purpose*: Repository interface for CRUD operations on the User entity.

*Annotations*:
- `@Repository`: Indicates that the class is a repository, which encapsulates the storage, retrieval, and search behavior typically from a relational database.

=== AuditService

*Purpose*: Service for logging audit events.

*Methods*:
- `public void logEvent(String event)`: Logs an audit event.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.

=== EmailService

*Purpose*: Service for sending emails.

*Methods*:
- `public void sendWelcomeEmail(String to)`: Sends a welcome email to the specified recipient.

*Fields*:
- `notificationService : final NotificationService`: Service for sending notifications.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.

=== JWTService

*Purpose*: Service for handling JWT operations.

*Methods*:
- `public String extractUsername(String token)`: Extracts username from the given token.
- `public String generateToken(final String username)`: Generates a token for the given username.
- `public boolean validateToken(String token)`: Validates the given token.
- `public void invalidateToken(String token)`: Invalidates the given token.

*Fields*:
- `auditService : final AuditService`: Audit service for logging events.
- `secretKey : final Key`: Secret key used for token generation.
- `tokenBlacklistService : final TokenBlacklistService`: Service for blacklisting tokens.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.
- `@Slf4j`: Embeds the logger facility.

=== NotificationService

*Purpose*: Service for sending notifications.

*Methods*:
- `public void notifyUser(String user, String message)`: Notifies the user with the given message.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.

=== TokenBlacklistService

*Purpose*: Service for blacklisting tokens.

*Methods*:
- `public void blacklistToken(String token)`: Adds the given token to the blacklist.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.

=== UserService

*Purpose*: Service for user-related operations.

*Methods*:
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads user details by username.
- `public User register(final User user)`: Registers a new user.

*Fields*:
- `auditService : AuditService`: Service for auditing.
- `emailService : EmailService`: Service for email operations.
- `encoder : BCryptPasswordEncoder`: Password encoder.
- `userRepository : UserRepository`: Repository for user data access.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Indicates that the class is a service, which holds business logic.

=== IdentityproviderApplicationTests

*Purpose*: Contains tests for the Identity Provider application.

*Annotations*:
- `@SpringBootTest`: Indicates that the class should bootstrap the entire container for integration tests.
- `@Test`: Indicates that the method is a test method.

== Runtime View Diagrams

=== Sequence Diagrams

==== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService

User -> UserController : register(user)
activate UserController

UserController -> UserService : register(user)
activate UserService

UserService -> UserRepository : save(user)
activate UserRepository
UserRepository -> UserRepository : save()
deactivate UserRepository

UserService -> UserService : encodePassword(user)
UserService -> EmailService : sendWelcomeEmail(user.email)
deactivate UserService

UserController -> UserController : return user
deactivate UserController

@enduml
----

==== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant JWTService

User -> UserController : login(authRequest)
activate UserController

UserController -> UserService : loadUserByUsername(authRequest.username)
activate UserService
UserService -> UserService : validatePassword(authRequest.password)
deactivate UserService

UserController -> JWTService : generateToken(user.username)
activate JWTService
JWTService -> JWTService : createToken()
deactivate JWTService

UserController -> UserController : return token
deactivate UserController

@enduml
----

==== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
activate JwtAuthFilter

JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService
JWTService -> JWTService : checkValidity()
deactivate JWTService

JwtAuthFilter -> JwtAuthFilter : proceed(request)
deactivate JwtAuthFilter

@enduml
----

=== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "User" as User {
  *id : Long
  *username : String
  *passwordHash : String
  *email : String
  --
  *roles : Set<Role>
}

entity "Role" as Role {
  *id : Long
  *name : String
  --
  *users : Set<User>
}

entity "Client" as Client {
  *id : Long
  *clientName : String
  *clientSecret : String
  *redirectUri : String
}

entity "Token" as Token {
  *id : Long
  *accessToken : String
  *refreshToken : String
  --
  *user : User
  *client : Client
}

User "1" -- "n" Role : has >
Role "n" -- "1" User : belongs to <
User "1" -- "n" Token : has >
Token "n" -- "1" User : belongs to <
Client "1" -- "n" Token : has >
Token "n" -- "1" Client : belongs to <
@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

*UserController* interacts with *UserService* for user operations like registration and login. *UserService* further interacts with *UserRepository* to persist user data. For registration, *UserService* also interacts with *EmailService* to send a welcome email.

=== Data Flow Through Layers

Data flows from the controllers to services and then to repositories. For instance, user data flows from *UserController* to *UserService* and then to *UserRepository* for persistence.

=== Exception Propagation

Exceptions are thrown at the repository or service layer and are propagated up to the controllers where they are handled and appropriate responses are sent back to the client.

=== Transaction Boundaries

Transactions are typically started at the service layer to ensure data integrity and consistency. For example, during user registration, the transaction starts at *UserService* and encompasses the operations of saving the user and sending the welcome email.

== Conclusion

This detailed design document provides a comprehensive overview of the Identity Provider application, detailing the architecture, class design, interactions, and data flows. It serves as a guide for developers to understand and implement the system effectively.