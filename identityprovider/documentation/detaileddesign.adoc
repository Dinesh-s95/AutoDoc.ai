= Detailed Design Documentation: Identity Provider Application

This document provides a comprehensive detailed design for the Identity Provider Application. It includes class-by-class analysis, runtime view diagrams with sequence diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose*: Serves as the entry point for the Spring Boot application.

*Methods*:
- `main(String[] args)`: Launches the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

*Purpose*: Filter that intercepts requests to validate JWT tokens.

*Methods*:
- `doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)`: Intercepts HTTP requests to check for the presence of a valid JWT token.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected.
- `@Component`: Indicates that the class is a Spring component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds the logger capability.

*Fields*:
- `userService: UserService`: Injected service used for user-related operations.

=== SecurityConfig

*Purpose*: Configuration for security aspects of the application, such as authentication and authorization.

*Methods*:
- `authenticationManager(AuthenticationConfiguration authConfig)`: Bean definition for authentication manager.
- `authenticationProvider()`: Bean definition for authentication provider.
- `securityFilterChain(HttpSecurity http)`: Configures HTTP security for the application.

*Annotations*:
- `@Autowired`: Dependency injection.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has `@Bean` definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Fields*:
- `jwtAuthFilter: JwtAuthFilter`: JWT authentication filter.
- `userDetailsService: UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose*: Controller to handle user-related operations such as registration, login, and token refresh.

*Methods*:
- `login(User user)`: Handles user login requests.
- `refreshToken(Users user)`: Handles JWT token refresh requests.
- `registerUser(User user)`: Handles user registration.

*Annotations*:
- `@Autowired`: Dependency injection.
- `@PostMapping`: Mapping HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Maps HTTP requests to handler methods.
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.

*Fields*:
- `authManager: AuthenticationManager`: Manages authentication.
- `jwtService: JWTService`: Service for JWT operations.
- `userService: UserService`: Service for user operations.

=== AuthRequest

*Purpose*: DTO for authentication request data.

*Fields*:
- `password: String`: User's password.
- `username: String`: User's username.

*Annotations*:
- `@Data`: Lombok annotation to create getters, setters, `toString`, `equals`, `hashCode`, and `requiredArgsConstructor` automatically.

=== AuthResponse

*Purpose*: DTO for authentication response data.

=== UserPrincipal

*Purpose*: Principal object for Spring Security.

*Methods*:
- Implements methods from `UserDetails` interface to provide user information to Spring Security.

*Annotations*:
- `@Override`: Indicates overridden methods.

*Fields*:
- `user: final User`: The user details.

=== Client

*Purpose*: Entity representing an OAuth client.

*Fields*:
- `clientName: String`: Name of the client.
- `clientSecret: String`: Secret key for the client.
- `id: Long`: Primary key.
- `redirectUri: String`: URI to redirect after authentication.

*Annotations*:
- `@Entity`: Specifies that the class is an entity.
- `@Table`: Specifies the table in the database for this entity.
- `@Id`: Specifies the primary key.
- `@GeneratedValue`: Specifies the strategy for primary key generation.
- `@Column`: Specifies the column in the table.
- `@Getter`, `@Setter`: Lombok annotations to generate getters and setters.

=== Role

*Purpose*: Entity representing a user role.

*Methods*:
- `getId()`, `setId(Long id)`: Getter and setter for `id`.
- `getName()`, `setName(String name)`: Getter and setter for `name`.
- `getUsers()`, `setUsers(Set<User> users)`: Getter and setter for `users`.

*Fields*:
- `id: Long`: Primary key.
- `name: String`: Name of the role.
- `users: Set<User>`: Users associated with this role.

*Annotations*:
- `@Entity`, `@Table`, `@Id`, `@GeneratedValue`, `@Column`, `@ManyToMany`: Annotations for JPA and database mapping.

=== Token

*Purpose*: Entity representing an authentication token.

*Fields*:
- `accessToken: String`: Access token string.
- `client: Client`: Associated client.
- `id: Long`: Primary key.
- `refreshToken: String`: Refresh token string.
- `user: User`: Associated user.

*Annotations*:
- `@Entity`, `@Table`, `@Id`, `@GeneratedValue`, `@Column`, `@ManyToOne`, `@JoinColumn`, `@Getter`, `@Setter`: Annotations for JPA and database mapping.

=== User

*Purpose*: Entity representing a user.

*Fields*:
- `email: String`: User's email.
- `id: Long`: Primary key.
- `passwordHash: String`: Hash of the user's password.
- `roles: Set<Role>`: Roles associated with the user.
- `username: String`: User's username.

*Annotations*:
- `@Entity`, `@Table`, `@Id`, `@GeneratedValue`, `@Column`, `@Data`, `@Getter`, `@Setter`, `@ManyToMany`, `@JoinTable`, `@JoinColumn`: Annotations for JPA and database mapping.

=== UserRepository

*Purpose*: Repository for accessing user data.

*Annotations*:
- `@Repository`: Indicates that the class is a repository, which encapsulates storage, retrieval, and search behavior.

=== AuditService

*Purpose*: Service for logging audit events.

*Methods*:
- `logEvent(String event)`: Logs an audit event.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.

=== EmailService

*Purpose*: Service for sending emails.

*Methods*:
- `sendWelcomeEmail(String to)`: Sends a welcome email.

*Annotations*:
- `@Service`: Indicates that the class is a service.

*Fields*:
- `notificationService: final NotificationService`: Service for sending notifications.

=== JWTService

*Purpose*: Service for handling JWT operations.

*Methods*:
- `extractUsername(String token)`: Extracts the username from the token.
- `generateToken(String username)`: Generates a JWT token.
- `validateToken(String token)`: Validates a JWT token.
- `invalidateToken(String token)`: Invalidates a JWT token.

*Annotations*:
- `@Service`: Indicates that the class is a service.
- `@Slf4j`: Embeds the logger capability.

*Fields*:
- `auditService: final AuditService`: Audit service for logging.
- `secretKey: final Key`: Secret key used for token generation.
- `tokenBlacklistService: final TokenBlacklistService`: Service for blacklisting tokens.

=== NotificationService

*Purpose*: Service for sending notifications.

*Methods*:
- `notifyUser(String user, String message)`: Sends a notification to a user.

*Annotations*:
- `@Service`: Indicates that the class is a service.

=== TokenBlacklistService

*Purpose*: Service for blacklisting tokens.

*Methods*:
- `blacklistToken(String token)`: Adds a token to the blacklist.

*Annotations*:
- `@Service`: Indicates that the class is a service.

=== UserService

*Purpose*: Service for user-related operations.

*Methods*:
- `loadUserByUsername(String username)`: Loads user details by username.
- `register(User user)`: Registers a new user.

*Annotations*:
- `@Autowired`: Dependency injection.
- `@Override`: Indicates overridden methods.
- `@Service`: Indicates that the class is a service.

*Fields*:
- `auditService: AuditService`: Service for audit logging.
- `emailService: EmailService`: Service for email operations.
- `encoder: BCryptPasswordEncoder`: Password encoder.
- `userRepository: UserRepository`: Repository for user data.

=== IdentityproviderApplicationTests

*Purpose*: Class for application tests.

*Annotations*:
- `@SpringBootTest`: Indicates that the class should bootstrap with Spring Boot's support.
- `@Test`: Indicates that the method is a test method.

== 2. Runtime View Diagrams

=== Sequence Diagrams

Below are the sequence diagrams for key business flows using PlantUML.

==== User Registration Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant UserRepository

User -> UserController : register(user)
UserController -> UserService : register(user)
UserService -> UserRepository : save(user)
UserRepository --> UserService : user
UserService --> UserController : user
UserController --> User : user
@enduml
```

==== Authentication/Login Flow

```plantuml
@startuml
actor User
participant UserController
participant AuthenticationManager
participant JWTService

User -> UserController : login(authRequest)
UserController -> AuthenticationManager : authenticate(authRequest)
AuthenticationManager --> UserController : authentication
UserController -> JWTService : generateToken(authentication.principal)
JWTService --> UserController : token
UserController --> User : token
@enduml
```

==== JWT Token Validation Flow

```plantuml
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
JwtAuthFilter -> JWTService : validateToken(token)
JWTService --> JwtAuthFilter : isValid
JwtAuthFilter --> User : proceed / error
@enduml
```

==== Business Process Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant EmailService

User -> UserController : register(user)
UserController -> UserService : register(user)
UserService -> EmailService : sendWelcomeEmail(user.email)
EmailService --> UserService : emailSent
UserService --> UserController : user
UserController --> User : user
@enduml
```

==== Exception Handling Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService

User -> UserController : register(user)
alt validation error
    UserController -> UserService : validate(user)
    UserService --> UserController : ValidationError
    UserController --> User : errorResponse
else success
    UserController -> UserService : register(user)
    UserService --> UserController : user
    UserController --> User : user
end
@enduml
```

== 3. Entity Relationship Diagram

Below is the Entity Relationship Diagram (ERD) using PlantUML.

```plantuml
@startuml
entity User {
  * id : Long
  ---
  username : String
  email : String
  passwordHash : String
}

entity Role {
  * id : Long
  ---
  name : String
}

entity Client {
  * id : Long
  ---
  clientName : String
  clientSecret : String
  redirectUri : String
}

entity Token {
  * id : Long
  ---
  accessToken : String
  refreshToken : String
}

User "1" -- "0..*" Role : has >
Role "0..*" -- "1" User : belongs to <
User "1" -- "0..*" Token : has >
Token "1" -- "1" User : belongs to <
Token "1" -- "1" Client : uses >
Client "1" -- "0..*" Token : has >
@enduml
```

=== Detailed Entity Descriptions

*User*:
- Represents a user in the system.
- Fields include `id` (primary key), `username`, `email`, `passwordHash`.
- Relationships:
  - Many-to-many with `Role`: A user can have multiple roles, and a role can belong to multiple users.
  - One-to-many with `Token`: A user can have multiple tokens.

*Role*:
- Represents a role that can be assigned to a user.
- Fields include `id` (primary key) and `name`.
- Relationships:
  - Many-to-many with `User`: A role can belong to multiple users, and a user can have multiple roles.

*Client*:
- Represents an OAuth client in the system.
- Fields include `id` (primary key), `clientName`, `clientSecret`, `redirectUri`.
- Relationships:
  - One-to-many with `Token`: A client can have multiple tokens.

*Token*:
- Represents an authentication or refresh token.
- Fields include `id` (primary key), `accessToken`, `refreshToken`.
- Relationships:
  - Many-to-one with `User`: Each token is associated with one user.
  - Many-to-one with `Client`: Each token is used by one client.

== 4. Detailed Component Interactions

=== Controller-Service-Repository Interactions

*User Registration*:
- `UserController` receives the registration request and calls `UserService.register()`.
- `UserService` performs validation and then persists the user using `UserRepository.save()`.
- After the user is saved, `UserService` may trigger additional actions like sending a welcome email through `EmailService`.

*User Login*:
- `UserController` receives the login request and invokes `AuthenticationManager.authenticate()`.
- Upon successful authentication, `UserController` requests `JWTService` to generate a token.
- The token is then returned to the user.

*Token Validation*:
- `JwtAuthFilter` intercepts the request and extracts the token.
- The token is passed to `JWTService.validateToken()` to check its validity.
- If the token is valid, the request proceeds; otherwise, an error response is generated.

=== Data Flow Through Layers

Data flows from the controllers to services where business logic is executed. Services may interact with repositories to fetch or persist data. After processing, data flows back to the controllers and then to the clients.

=== Exception Propagation

Exceptions can be thrown at any layer (repository, service, controller). Typically, services handle business logic exceptions, which are then caught and handled (or transformed) by controllers to return appropriate HTTP responses.

=== Transaction Boundaries

Transactions are typically started at the service layer. This ensures that all operations within a service method are completed successfully or rolled back in case of an error, maintaining data integrity.

This detailed design document should provide developers with a clear understanding of the application's architecture, data flow, and interactions.