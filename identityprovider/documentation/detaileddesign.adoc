= Detailed Design Documentation for Identity Provider Application

This document provides a comprehensive detailed design for the Identity Provider Application. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose*: Serves as the entry point for the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Indicates that this is a Spring Boot application.

*Methods*:
- `public static void main(String[] args)`: Launches the Spring Boot application.

=== JwtAuthFilter

*Purpose*: Filters incoming requests to check for a valid JSON Web Token (JWT).

*Annotations*:
- `@Autowired`: Automatically injects the required beans.
- `@Component`: Marks the class as a Spring component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Provides a Simple Logging Facade for Java (SLF4J) logger.

*Methods*:
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters requests to check for JWT in the header.

*Fields*:
- `userService : UserService`: Service for user-related operations.

=== SecurityConfig

*Purpose*: Configuration for security aspects of the application, such as authentication and authorization.

*Annotations*:
- `@Autowired`: Automatically injects the required beans.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has @Bean definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Methods*:
- `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Configures the authentication manager.
- `public AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
- `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Configures the security filter chain.

*Fields*:
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose*: Controller to handle user-related operations such as registration and login.

*Annotations*:
- `@Autowired`: Automatically injects the required beans.
- `@PostMapping`: Handles HTTP POST requests.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the web request.
- `@RequestMapping`: Maps HTTP requests to handler methods.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Methods*:
- `public ResponseEntity<Object> refreshToken(@RequestBody User user)`: Handles token refresh requests.
- `public ResponseEntity<Object> login(@RequestBody final User user)`: Handles login requests.
- `public User registerUser(@RequestBody final User user)`: Handles user registration.

*Fields*:
- `authManager : AuthenticationManager`: Authentication manager for handling authentication.
- `jwtService : JWTService`: Service for JWT operations.
- `userService : UserService`: Service for user-related operations.

=== AuthRequest

*Purpose*: DTO for authentication request data.

*Annotations*:
- `@Data`: Lombok annotation to generate getters, setters, toString, equals, and hashCode methods.

*Fields*:
- `password : String`: User's password.
- `username : String`: User's username.

=== AuthResponse

*Purpose*: DTO for authentication response data.

=== UserPrincipal

*Purpose*: Principal details implementation for Spring Security.

*Annotations*:
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

*Methods*:
- `public Collection<? extends GrantedAuthority> getAuthorities()`: Returns the authorities granted to the user.
- `public String getPassword()`: Returns the user's password.
- `public String getUsername()`: Returns the user's username.
- `public boolean isAccountNonExpired()`: Indicates whether the user's account has expired.
- `public boolean isAccountNonLocked()`: Indicates whether the user is locked or unlocked.
- `public boolean isCredentialsNonExpired()`: Indicates whether the user's credentials (password) has expired.
- `public boolean isEnabled()`: Indicates whether the user is enabled or disabled.

*Fields*:
- `user : final User`: User entity associated with this principal.

=== Client

*Purpose*: Entity representing a client application that can request tokens.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate the getter method.
- `@Id`: Specifies the primary key of an entity.
- `@Setter`: Lombok annotation to generate the setter method.
- `@Table`: Specifies the primary table for the annotated entity.

*Fields*:
- `clientName : String`: Name of the client.
- `clientSecret : String`: Secret used for client authentication.
- `id : Long`: Primary key.
- `redirectUri : String`: URI to redirect after authentication.

=== Role

*Purpose*: Entity representing a security role.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Id`: Specifies the primary key of an entity.
- `@ManyToMany`: Defines a many-to-many relationship between the join table and the target entity.
- `@Table`: Specifies the primary table for the annotated entity.

*Methods*:
- `public Long getId()`: Returns the role ID.
- `public Set<User> getUsers()`: Returns the set of users with this role.
- `public String getName()`: Returns the role name.
- `public void setId(Long id)`: Sets the role ID.
- `public void setName(String name)`: Sets the role name.
- `public void setUsers(Set<User> users)`: Sets the users with this role.

*Fields*:
- `id : Long`: Primary key.
- `name : String`: Name of the role.
- `users : Set<User>`: Users having this role.

=== Token

*Purpose*: Entity representing an authentication token.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate the getter method.
- `@Id`: Specifies the primary key of an entity.
- `@JoinColumn`: Specifies a column for joining an entity association or element collection.
- `@ManyToOne`: Defines a many-to-one relationship between the join column and the target entity.
- `@Setter`: Lombok annotation to generate the setter method.
- `@Table`: Specifies the primary table for the annotated entity.

*Fields*:
- `accessToken : String`: Access token string.
- `client : Client`: Client associated with this token.
- `id : Long`: Primary key.
- `refreshToken : String`: Refresh token string.
- `user : User`: User associated with this token.

=== User

*Purpose*: Entity representing a user.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Data`: Lombok annotation to generate getters, setters, toString, equals, and hashCode methods.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate the getter method.
- `@Id`: Specifies the primary key of an entity.
- `@JoinColumn`: Specifies a column for joining an entity association or element collection.
- `@JoinTable`: Specifies the join table for a many-to-many relationship.
- `@ManyToMany`: Defines a many-to-many relationship between the join table and the target entity.
- `@Setter`: Lombok annotation to generate the setter method.
- `@Table`: Specifies the primary table for the annotated entity.

*Fields*:
- `email : String`: Email address of the user.
- `id : Long`: Primary key.
- `passwordHash : String`: Hashed password of the user.
- `roles : Set<Role>`: Security roles of the user.
- `username : String`: Username of the user.

=== UserRepository

*Purpose*: Repository for accessing user data.

*Annotations*:
- `@Repository`: Indicates that the class is a repository, which encapsulates the logic required to access data sources.

=== AuditService

*Purpose*: Service for logging audit events.

*Annotations*:
- `@Service`: Marks the class as a service, which holds business logic.

*Methods*:
- `public void logEvent(String event)`: Logs an audit event.

=== EmailService

*Purpose*: Service for sending emails.

*Annotations*:
- `@Service`: Marks the class as a service, which holds business logic.

*Methods*:
- `public void sendWelcomeEmail(String to)`: Sends a welcome email to a new user.

*Fields*:
- `notificationService : final NotificationService`: Service for sending notifications.

=== JWTService

*Purpose*: Service for handling JWT operations.

*Annotations*:
- `@Service`: Marks the class as a service, which holds business logic.
- `@Slf4j`: Provides a Simple Logging Facade for Java (SLF4J) logger.

*Methods*:
- `public String extractUsername(String token)`: Extracts the username from the token.
- `public String generateToken(final String username)`: Generates a new token.
- `public boolean validateToken(String token)`: Validates the token.
- `public void invalidateToken(String token)`: Invalidates the token.

*Fields*:
- `auditService : final AuditService`: Service for logging audit events.
- `secretKey : final Key`: Secret key used for signing the token.
- `tokenBlacklistService : final TokenBlacklistService`: Service for handling token blacklisting.

=== NotificationService

*Purpose*: Service for sending notifications.

*Annotations*:
- `@Service`: Marks the class as a service, which holds business logic.

*Methods*:
- `public void notifyUser(String user, String message)`: Sends a notification to a user.

=== TokenBlacklistService

*Purpose*: Service for blacklisting tokens.

*Annotations*:
- `@Service`: Marks the class as a service, which holds business logic.

*Methods*:
- `public void blacklistToken(String token)`: Adds a token to the blacklist.

=== UserService

*Purpose*: Service for handling user-related operations.

*Annotations*:
- `@Autowired`: Automatically injects the required beans.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Marks the class as a service, which holds business logic.

*Methods*:
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads user details by username.
- `public User register(final User user)`: Registers a new user.

*Fields*:
- `auditService : AuditService`: Service for logging audit events.
- `emailService : EmailService`: Service for sending emails.
- `encoder : BCryptPasswordEncoder`: Encoder for hashing passwords.
- `userRepository : UserRepository`: Repository for accessing user data.

=== IdentityproviderApplicationTests

*Purpose*: Provides test cases for the Identity Provider Application.

*Annotations*:
- `@SpringBootTest`: Indicates that the class should bootstrap with Spring Boot's support.
- `@Test`: Indicates that the method is a test method.

== Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business flows in the application using PlantUML.

==== User Registration Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService
participant AuditService

User -> UserController : register(user)
UserController -> UserService : register(user)
UserService -> UserRepository : save(user)
UserRepository -> UserService : user
UserService -> EmailService : sendWelcomeEmail(user.email)
EmailService -> UserService : emailSent
UserService -> AuditService : logEvent("User registered")
AuditService -> UserService : logged
UserService -> UserController : user
UserController -> User : user
@enduml
```

==== Authentication/Login Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant JWTService
participant AuditService

User -> UserController : login(authRequest)
UserController -> UserService : loadUserByUsername(authRequest.username)
UserService -> UserController : userDetails
UserController -> JWTService : generateToken(userDetails.username)
JWTService -> UserController : token
UserController -> AuditService : logEvent("User logged in")
AuditService -> UserController : logged
UserController -> User : token
@enduml
```

==== JWT Token Validation Flow

```plantuml
@startuml
actor User
participant JwtAuthFilter
participant JWTService
participant AuditService

User -> JwtAuthFilter : request(resource)
JwtAuthFilter -> JWTService : validateToken(token)
JWTService -> JwtAuthFilter : isValid
alt isValid
    JwtAuthFilter -> User : proceed
else notValid
    JwtAuthFilter -> AuditService : logEvent("Invalid token attempt")
    AuditService -> JwtAuthFilter : logged
    JwtAuthFilter -> User : errorResponse
end
@enduml
```

==== Business Process Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant JWTService
participant AuditService

User -> UserController : performAction()
UserController -> UserService : checkPermission(user, action)
UserService -> UserController : isAllowed
alt isAllowed
    UserController -> JWTService : performAction()
    JWTService -> UserController : result
    UserController -> User : result
else notAllowed
    UserController -> User : accessDenied
end
@enduml
```

==== Exception Handling Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant ErrorHandlingComponent

User -> UserController : request()
UserController -> UserService : processRequest()
alt success
    UserService -> UserController : response
    UserController -> User : response
else error
    UserService -> ErrorHandlingComponent : handleError(error)
    ErrorHandlingComponent -> UserService : errorResponse
    UserService -> UserController : errorResponse
    UserController -> User : errorResponse
end
@enduml
```

== Entity Relationship Diagram

The following diagram illustrates the relationships between entities in the application.

```plantuml
@startuml
entity "User" as User {
  *id : Long
  *username : String
  *passwordHash : String
  *email : String
  --
  +roles : Set<Role>
}

entity "Role" as Role {
  *id : Long
  *name : String
  --
  +users : Set<User>
}

entity "Client" as Client {
  *id : Long
  *clientName : String
  *clientSecret : String
  *redirectUri : String
}

entity "Token" as Token {
  *id : Long
  *accessToken : String
  *refreshToken : String
  --
  +user : User
  +client : Client
}

User ||--o{ Role : has
Role ||--o{ User : belongs to
User ||--o{ Token : owns
Client ||--o{ Token : issued
@enduml
```

=== Entity Descriptions

- **User**: Represents a user of the system. Each user has a unique ID, a username, a hashed password, and an email address. Users are associated with roles that grant them permissions within the system.
- **Role**: Represents a security role within the system. Each role has a unique ID and a name. Roles are associated with multiple users.
- **Client**: Represents a client application that can request tokens for accessing secured resources. Each client has a unique ID, a name, a secret for authentication, and a redirect URI for redirecting after authentication.
- **Token**: Represents an authentication token issued to a user by a client. Each token has a unique ID, an access token string, and a refresh token string. Tokens are associated with a user and a client that issued the token.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserController** interacts with **UserService** to handle user-related operations such as registration and login.
- **UserService** interacts with **UserRepository** to perform data access operations on user data.
- **UserService** also interacts with **EmailService** and **AuditService** to perform operations related to email sending and audit logging.

=== Data Flow Through Layers

- Data flows from controllers to services where business logic is applied. Services may interact with repositories for data persistence.
- Services may also call other services (e.g., **EmailService** or **AuditService**) to perform specific operations that are orthogonal to the main business logic.

=== Exception Propagation

- Exceptions are typically thrown by services or repositories and are caught by controllers. Controllers may handle exceptions directly or delegate to an exception handling component.
- An exception handling component centralizes exception handling logic, such as logging and responding with appropriate HTTP status codes.

=== Transaction Boundaries

- Transactions are typically started at the service layer. This ensures that all operations within a single business process are completed successfully or rolled back entirely in case of an error.
- Transaction boundaries are defined using the `@Transactional` annotation on service methods.

This detailed design document provides a comprehensive overview of the Identity Provider Application, enabling developers to understand and contribute to the project effectively.