= Identity Provider System Detailed Design Documentation

== Introduction

This document provides a detailed design overview of the Identity Provider System implemented using Java Spring Boot. It covers the class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

`IdentityproviderApplication` is the entry point of the Spring Boot application.

- **Annotations**:
  - `@SpringBootApplication`: Marks this class as a Spring Boot application.

- **Methods**:
  - `public static void main(String[] args)`: Launches the Spring Boot application.

=== JwtAuthFilter

`JwtAuthFilter` is a component that intercepts HTTP requests to validate JWT tokens.

- **Annotations**:
  - `@Autowired`: Automatically injects the required dependencies.
  - `@Component`: Marks this class as a Spring-managed component.
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
  - `@Slf4j`: Provides a logger.

- **Methods**:
  - `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests and checks for valid JWT tokens.

- **Fields**:
  - `userService : UserService`: Service used for user-related operations.

=== SecurityConfig

`SecurityConfig` configures security-related aspects such as authentication and authorization.

- **Annotations**:
  - `@Autowired`: Automatically injects the required dependencies.
  - `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
  - `@Configuration`: Indicates that the class has @Bean definition methods.
  - `@EnableWebSecurity`: Enables Spring Security's web security support.

- **Methods**:
  - `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Configures the authentication manager.
  - `public AuthenticationProvider authenticationProvider()`: Defines the authentication provider.
  - `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Configures the security filter chain.

- **Fields**:
  - `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
  - `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

`UserController` handles all user-related HTTP requests.

- **Annotations**:
  - `@Autowired`: Automatically injects the required dependencies.
  - `@GetMapping`, `@PostMapping`: Annotations for mapping HTTP GET and POST requests, respectively.
  - `@RequestBody`: Annotation indicating a method parameter should be bound to the body of the HTTP request.
  - `@RequestMapping`: Annotation for mapping web requests onto methods in request-handling classes.
  - `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

- **Methods**:
  - `public ResponseEntity<Object> login(@RequestBody final Users user)`: Handles the login request.
  - `public String greet()`, `public String greet2()`: Simple greeting methods.
  - `public Users registerUser(@RequestBody final Users user)`: Handles user registration.

- **Fields**:
  - `authManager : AuthenticationManager`: Authentication manager for handling authentication.
  - `jwtService : JWTService`: Service for JWT operations.
  - `userService : UserService`: Service for user-related operations.

=== AuthRequest

`AuthRequest` is a data transfer object (DTO) for authentication requests.

- **Annotations**:
  - `@Data`: Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.

- **Fields**:
  - `password : String`: User's password.
  - `username : String`: User's username.

=== AuthResponse

`AuthResponse` is a DTO for carrying authentication response data.

=== UserPrincipal

`UserPrincipal` implements UserDetails and is used for storing user information which is later encapsulated into Authentication objects.

- **Annotations**:
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

- **Methods**:
  - `public Collection<? extends GrantedAuthority> getAuthorities()`: Returns the authorities granted to the user.
  - `public String getPassword()`: Returns the user's password.
  - `public String getUsername()`: Returns the user's username.
  - `public boolean isAccountNonExpired()`, `public boolean isAccountNonLocked()`, `public boolean isCredentialsNonExpired()`, `public boolean isEnabled()`: Security related properties.

- **Fields**:
  - `user : final Users`: The user entity associated with this principal.

=== Users

`Users` represents the user entity.

- **Annotations**:
  - `@Data`, `@Entity`, `@GeneratedValue`, `@Getter`, `@Id`, `@Setter`: Various JPA and Lombok annotations for entity and data handling.

- **Methods**:
  - `public String getPassword()`: Returns the user's password.
  - `public String getUsername()`: Returns the user's username.

- **Fields**:
  - `password : String`: User's password.
  - `userId : Long`: User's ID.
  - `username : String`: User's username.

=== UserRepository

`UserRepository` is the repository interface for user entities.

- **Annotations**:
  - `@Repository`: Marks the interface as a Spring Data repository.

=== JWTService

`JWTService` handles all JWT operations.

- **Annotations**:
  - `@Service`: Marks the class as a Spring service.
  - `@Slf4j`: Provides a logger.

- **Methods**:
  - `public String extractUsername(String token)`: Extracts username from the token.
  - `public String generateToken(final String username)`: Generates a new token.
  - `public boolean validateToken(String token)`: Validates the provided token.

- **Fields**:
  - `secretKey : final Key`: The key used for signing the JWT.

=== UserService

`UserService` handles all user-related business logic.

- **Annotations**:
  - `@Autowired`: Automatically injects the required dependencies.
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
  - `@Service`: Marks the class as a Spring service.

- **Methods**:
  - `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads the user details.
  - `public Users register(final Users user)`: Registers a new user.

- **Fields**:
  - `encoder : BCryptPasswordEncoder`: Password encoder.
  - `userRepository : UserRepository`: Repository for user entities.

=== IdentityproviderApplicationTests

`IdentityproviderApplicationTests` contains test cases for the application.

- **Annotations**:
  - `@SpringBootTest`: Indicates that the class should bootstrap with Spring Boot's support.
  - `@Test`: Marks the method as a test method.

== Runtime View Diagrams

=== User Registration Flow

```plantuml
@startuml
actor "User" as user
participant "UserController" as controller
participant "UserService" as service
participant "UserRepository" as repository

user -> controller : registerUser(user)
controller -> service : register(user)
service -> repository : save(user)
repository -> service : userSaved
service -> controller : userSaved
controller -> user : registrationSuccess
@enduml
```

=== Authentication/Login Flow

```plantuml
@startuml
actor "User" as user
participant "UserController" as controller
participant "UserService" as service
participant "JWTService" as jwt

user -> controller : login(authRequest)
controller -> service : loadUserByUsername(username)
service -> controller : userDetails
controller -> jwt : generateToken(username)
jwt -> controller : token
controller -> user : authResponse(token)
@enduml
```

=== JWT Token Validation Flow

```plantuml
@startuml
actor "User" as user
participant "JwtAuthFilter" as filter
participant "JWTService" as jwt

user -> filter : doFilterInternal(request, response, chain)
filter -> jwt : validateToken(token)
jwt -> filter : isValid
filter -> filter : filterChain.doFilter(request, response)
@enduml
```

=== Exception Handling Flow

```plantuml
@startuml
actor "User" as user
participant "UserController" as controller
participant "UserService" as service

user -> controller : action()
alt success
  controller -> service : performAction()
  service -> controller : successResponse
  controller -> user : successResponse
else exception
  controller -> service : handleError()
  service -> controller : errorResponse
  controller -> user : errorResponse
end
@enduml
```

== Entity Relationship Diagram

```plantuml
@startuml
entity "Users" {
  * userId : Long <<generated>>
  --
  * username : String
  * password : String
}

@enduml
```

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserController**:
  - Interacts with **UserService** for user registration and login.
  - Receives user data from the client and passes it to **UserService**.
  - Receives responses from **UserService** and sends back to the client.

- **UserService**:
  - Interacts with **UserRepository** for saving and retrieving user data.
  - Handles business logic for user registration and authentication.
  - Uses **BCryptPasswordEncoder** for password encoding.

- **UserRepository**:
  - Interacts with the database to perform CRUD operations on the **Users** entity.

=== Data Flow Through Layers

- Data flows from **UserController** to **UserService** and then to **UserRepository**.
- After processing, data flows back from **UserRepository** to **UserService** and then to **UserController**.

=== Exception Propagation

- Exceptions are thrown at the repository or service layer.
- Caught and handled in the controller layer.
- Appropriate error responses are sent back to the client.

=== Transaction Boundaries

- Transactions are managed at the service layer.
- **UserService** defines transaction boundaries which ensure that database operations either complete entirely or rollback in case of an error.

== Conclusion

This detailed design document provides a comprehensive overview of the Identity Provider System, including class descriptions, runtime processes, entity relationships, and component interactions. It serves as a guide for developers to understand and maintain the system effectively.