= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design for the Identity Provider application built using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

This class is the entry point of the Spring Boot application.

- *Annotations*:
  - `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

- *Methods*:
  - `public static void main(String[] args)`: The main method which Spring Boot uses to start the application.

=== JwtAuthFilter

A filter class for JWT authentication.

- *Annotations*:
  - `@Autowired`: Marks a dependency which Spring resolves and injects.
  - `@Component`: Indicates that an annotated class is a "component".
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
  - `@Slf4j`: Lombok annotation to autogenerate an SLF4J Logger.

- *Methods*:
  - `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests and validates JWT tokens.

- *Fields*:
  - `userService : UserService`: Service used for user-related operations.

=== SecurityConfig

Configuration class for security settings.

- *Annotations*:
  - `@Autowired`: Marks a dependency which Spring resolves and injects.
  - `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
  - `@Configuration`: Indicates that the class has `@Bean` definition methods.
  - `@EnableWebSecurity`: Adds Spring Security configuration.

- *Methods*:
  - `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Configures the authentication manager.
  - `public AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
  - `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Defines the security filter chain.

- *Fields*:
  - `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
  - `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

Controller for user-related operations.

- *Annotations*:
  - `@Autowired`: Marks a dependency which Spring resolves and injects.
  - `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.
  - `@RequestBody`: Annotation indicating a method parameter should be bound to the body of the HTTP request.
  - `@RequestMapping`: Annotation for mapping web requests onto methods in request-handling classes.
  - `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.

- *Methods*:
  - `public ResponseEntity<Object> login(@RequestBody final Users user)`: Handles the login request.
  - `public Users registerUser(@RequestBody final Users user)`: Handles user registration.

- *Fields*:
  - `authManager : AuthenticationManager`: Authentication manager for security.
  - `jwtService : JWTService`: Service for JWT operations.
  - `userService : UserService`: Service used for user-related operations.

=== AuthRequest

Data transfer object for authentication requests.

- *Annotations*:
  - `@Data`: Lombok annotation to generate getters, setters, toString, equals, and hashCode methods.

- *Fields*:
  - `password : String`: User's password.
  - `username : String`: User's username.

=== AuthResponse

Data transfer object for authentication responses.

=== UserPrincipal

Principal class representing a logged-in user.

- *Annotations*:
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

- *Methods*:
  - `public Collection<? extends GrantedAuthority> getAuthorities()`: Returns the authorities granted to the user.
  - `public String getPassword()`: Returns the user's password.
  - `public String getUsername()`: Returns the user's username.
  - `public boolean isAccountNonExpired()`: Indicates whether the user's account has expired.
  - `public boolean isAccountNonLocked()`: Indicates whether the user is locked or unlocked.
  - `public boolean isCredentialsNonExpired()`: Indicates whether the user's credentials (password) have expired.
  - `public boolean isEnabled()`: Indicates whether the user is enabled or disabled.

- *Fields*:
  - `user : final Users`: The user entity associated with this principal.

=== Client

Entity representing a client application.

- *Annotations*:
  - `@Column`: Marks a field as a column in a database table.
  - `@Entity`: Specifies that the class is an entity.
  - `@GeneratedValue`: Specifies the strategy for generating primary key values.
  - `@Getter`: Lombok annotation to generate the getter method for the field.
  - `@Id`: Specifies the primary key of an entity.
  - `@Setter`: Lombok annotation to generate the setter method for the field.
  - `@Table`: Specifies the primary table for the annotated entity.

- *Fields*:
  - `clientName : String`: Name of the client.
  - `clientSecret : String`: Secret key for the client.
  - `id : Long`: Primary key.
  - `redirectUri : String`: URI to redirect after authentication.

=== Role

Entity representing a user role.

- *Annotations*:
  - `@Column`: Marks a field as a column in a database table.
  - `@Entity`: Specifies that the class is an entity.
  - `@GeneratedValue`: Specifies the strategy for generating primary key values.
  - `@Id`: Specifies the primary key of an entity.
  - `@ManyToMany`: Defines a many-to-many relationship between the entities.
  - `@Table`: Specifies the primary table for the annotated entity.

- *Methods*:
  - `public Long getId()`: Returns the role ID.
  - `public Set<User> getUsers()`: Returns the users associated with this role.
  - `public String getName()`: Returns the role name.
  - `public void setId(Long id)`: Sets the role ID.
  - `public void setName(String name)`: Sets the role name.
  - `public void setUsers(Set<User> users)`: Sets the users associated with this role.

- *Fields*:
  - `id : Long`: Primary key.
  - `name : String`: Name of the role.
  - `users : Set<User>`: Users associated with this role.

=== Token

Entity representing an authentication token.

- *Annotations*:
  - `@Column`: Marks a field as a column in a database table.
  - `@Entity`: Specifies that the class is an entity.
  - `@GeneratedValue`: Specifies the strategy for generating primary key values.
  - `@Getter`: Lombok annotation to generate the getter method for the field.
  - `@Id`: Specifies the primary key of an entity.
  - `@JoinColumn`: Specifies a column for joining an entity association.
  - `@ManyToOne`: Defines a many-to-one relationship between the entities.
  - `@Setter`: Lombok annotation to generate the setter method for the field.
  - `@Table`: Specifies the primary table for the annotated entity.

- *Fields*:
  - `accessToken : String`: Access token string.
  - `client : Client`: The client associated with this token.
  - `id : Long`: Primary key.
  - `refreshToken : String`: Refresh token string.
  - `user : User`: The user associated with this token.

=== User

Entity representing a user.

- *Annotations*:
  - `@Column`: Marks a field as a column in a database table.
  - `@Data`: Lombok annotation to generate getters, setters, toString, equals, and hashCode methods.
  - `@Entity`: Specifies that the class is an entity.
  - `@GeneratedValue`: Specifies the strategy for generating primary key values.
  - `@Getter`: Lombok annotation to generate the getter method for the field.
  - `@Id`: Specifies the primary key of an entity.
  - `@JoinColumn`: Specifies a column for joining an entity association.
  - `@JoinTable`: Specifies the table that is used for the relationship.
  - `@ManyToMany`: Defines a many-to-many relationship between the entities.
  - `@Setter`: Lombok annotation to generate the setter method for the field.
  - `@Table`: Specifies the primary table for the annotated entity.

- *Fields*:
  - `email : String`: Email of the user.
  - `id : Long`: Primary key.
  - `passwordHash : String`: Hashed password of the user.
  - `roles : Set<Role>`: Roles associated with the user.
  - `username : String`: Username of the user.

=== UserRepository

Repository for accessing user data.

- *Annotations*:
  - `@Repository`: Indicates that the class is a repository.

=== AuditService

Service for logging audit events.

- *Annotations*:
  - `@Service`: Indicates that the class is a service.

- *Methods*:
  - `public void logEvent(String event)`: Logs an audit event.

=== EmailService

Service for sending emails.

- *Annotations*:
  - `@Service`: Indicates that the class is a service.

- *Methods*:
  - `public void sendWelcomeEmail(String to)`: Sends a welcome email.

- *Fields*:
  - `notificationService : final NotificationService`: Service for sending notifications.

=== JWTService

Service for handling JWT operations.

- *Annotations*:
  - `@Service`: Indicates that the class is a service.
  - `@Slf4j`: Lombok annotation to autogenerate an SLF4J Logger.

- *Methods*:
  - `public String extractUsername(String token)`: Extracts the username from the token.
  - `public String generateToken(final String username)`: Generates a token for the given username.
  - `public boolean validateToken(String token)`: Validates the given token.
  - `public void invalidateToken(String token)`: Invalidates the given token.

- *Fields*:
  - `auditService : final AuditService`: Audit service for logging events.
  - `secretKey : final Key`: Secret key used for token generation.
  - `tokenBlacklistService : final TokenBlacklistService`: Service for blacklisting tokens.

=== NotificationService

Service for sending notifications.

- *Annotations*:
  - `@Service`: Indicates that the class is a service.

- *Methods*:
  - `public void notifyUser(String user, String message)`: Notifies a user with a message.

=== TokenBlacklistService

Service for blacklisting tokens.

- *Annotations*:
  - `@Service`: Indicates that the class is a service.

- *Methods*:
  - `public void blacklistToken(String token)`: Adds a token to the blacklist.

=== UserService

Service for user-related operations.

- *Annotations*:
  - `@Autowired`: Marks a dependency which Spring resolves and injects.
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
  - `@Service`: Indicates that the class is a service.

- *Methods*:
  - `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads user details by username.
  - `public Users register(final Users user)`: Registers a new user.

- *Fields*:
  - `auditService : AuditService`: Service for logging audit events.
  - `emailService : EmailService`: Service for sending emails.
  - `encoder : BCryptPasswordEncoder`: Encoder for password hashing.
  - `userRepository : UserRepository`: Repository for accessing user data.

=== IdentityproviderApplicationTests

Class for application tests.

- *Annotations*:
  - `@SpringBootTest`: Indicates that the class should bootstrap with Spring Boot's support.
  - `@Test`: Indicates that the method is a test method.

== Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business flows using PlantUML.

==== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService
participant AuditService

User -> UserController : register(user)
activate UserController

UserController -> UserService : register(user)
activate UserService

UserService -> UserRepository : save(user)
activate UserRepository
UserRepository -> UserRepository : saveUserToDB()
deactivate UserRepository

UserService -> EmailService : sendWelcomeEmail(user.email)
activate EmailService
EmailService -> EmailService : sendEmail()
deactivate EmailService

UserService -> AuditService : logEvent("User registered")
activate AuditService
AuditService -> AuditService : logToAudit()
deactivate AuditService

UserService -> UserController : return user
deactivate UserService

UserController -> User : return user
deactivate UserController
@enduml
----

==== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant JWTService
participant AuditService

User -> UserController : login(authRequest)
activate UserController

UserController -> UserService : loadUserByUsername(authRequest.username)
activate UserService
UserService -> UserService : verifyCredentials()
UserService -> UserController : userDetails
deactivate UserService

UserController -> JWTService : generateToken(userDetails.username)
activate JWTService
JWTService -> JWTService : createJWT()
JWTService -> UserController : return token
deactivate JWTService

UserController -> AuditService : logEvent("User logged in")
activate AuditService
AuditService -> AuditService : logToAudit()
deactivate AuditService

UserController -> User : return token
deactivate UserController
@enduml
----

==== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService
participant AuditService

User -> JwtAuthFilter : accessResource(token)
activate JwtAuthFilter

JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService
JWTService -> JWTService : checkTokenValidity()
JWTService -> JwtAuthFilter : isValid
deactivate JWTService

alt isValid
    JwtAuthFilter -> User : allowAccess()
else not isValid
    JwtAuthFilter -> AuditService : logEvent("Invalid token attempt")
    activate AuditService
    AuditService -> AuditService : logToAudit()
    deactivate AuditService
    JwtAuthFilter -> User : denyAccess()
end

deactivate JwtAuthFilter
@enduml
----

=== Entity Relationship Diagram

The following ER diagram represents the database schema with proper entity relationships using PlantUML.

[plantuml, er-diagram, png]
----
@startuml
entity "User" {
  * id : Long
  --
  * username : String
  * passwordHash : String
  * email : String
  --
  * roles : Set<Role>
}

entity "Role" {
  * id : Long
  --
  * name : String
  --
  * users : Set<User>
}

entity "Client" {
  * id : Long
  --
  * clientName : String
  * clientSecret : String
  * redirectUri : String
}

entity "Token" {
  * id : Long
  --
  * accessToken : String
  * refreshToken : String
  --
  * user : User
  * client : Client
}

User ||--o{ Role : has
Role ||--o{ User : belongs_to
User ||--o{ Token : has
Client ||--o{ Token : has
@enduml
----

==== Entity Descriptions

- *User*: Represents an individual user of the system. Each user has a unique ID, a username, a hashed password, an email address, and a set of roles.
- *Role*: Represents a role that can be assigned to a user. Each role has a unique ID and a name. Roles are used to control access to various parts of the system.
- *Client*: Represents a client application that can request tokens. Each client has a unique ID, a name, a secret key, and a redirect URI.
- *Token*: Represents an authentication token issued to a user. Each token has a unique ID, an access token string, a refresh token string, and is associated with a user and a client.

== Detailed Component Interactions

The interactions between components in the Identity Provider application are crucial for understanding the data flow and processing within the system.

=== Controller-Service-Repository Interactions

- *UserController* interacts with *UserService* to handle user registration and login.
- *UserService* uses *UserRepository* to persist user data.
- *UserService* also interacts with *EmailService* to send welcome emails upon user registration.
- *JwtAuthFilter* uses *JWTService* to validate tokens during HTTP requests.

=== Data Flow Through Layers

- Data flows from *Controllers* to *Services* where business logic is applied. Then, data is either returned back to the controller or persisted/retrieved from the database through *Repositories*.
- *Services* may also interact with other services like *EmailService* or *AuditService* to perform operations that are orthogonal to the main business logic, such as sending notifications or logging.

=== Exception Propagation

- Exceptions are typically thrown from the service layer, which are then caught and handled in the controllers. This allows for centralized error handling and response formatting.

=== Transaction Boundaries

- Transactions are managed at the service layer, ensuring that database operations either complete fully or rollback in case of an error, maintaining data integrity.

This detailed design document provides a comprehensive overview of the Identity Provider application, covering class responsibilities, interactions, data flow, and database schema. It serves as a guide for developers to understand and contribute to the project effectively.