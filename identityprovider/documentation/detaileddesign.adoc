= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design of the Identity Provider application, focusing on class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose*: Serves as the entry point for the Spring Boot application.

*Methods*:
- `public static void main(String[] args)`: Initializes the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

*Purpose*: Filter that intercepts requests to validate JWT tokens.

*Methods*:
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)`: Intercepts HTTP requests to check for JWT in the Authorization header and validates it.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@Component`: Indicates that the class is a Spring component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds the logger functionality.

*Fields*:
- `userService : UserService`: Service for user-related operations.

=== SecurityConfig

*Purpose*: Configuration for security aspects of the application, such as authentication and authorization.

*Methods*:
- `AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig)`: Provides the authentication manager bean.
- `AuthenticationProvider authenticationProvider()`: Provides the authentication provider bean.
- `SecurityFilterChain securityFilterChain(HttpSecurity http)`: Configures HTTP security, setting up rules and permissions.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class is a source of bean definitions.
- `@EnableWebSecurity`: Adds Spring Security configuration.

*Fields*:
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose*: Controller to handle user-related operations such as registration, login, and token refresh.

*Methods*:
- `login(User user)`: Handles user login.
- `refreshToken(User user)`: Refreshes the authentication token.
- `registerUser(User user)`: Registers a new user.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@PostMapping`: Mapping for POST requests.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Maps HTTP requests to handler methods.
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body.

*Fields*:
- `authManager : AuthenticationManager`: Authentication manager.
- `jwtService : JWTService`: Service for JWT operations.
- `userService : UserService`: Service for user-related operations.

=== AuthRequest

*Purpose*: DTO for authentication request data.

*Fields*:
- `password : String`: User's password.
- `username : String`: User's username.

*Annotations*:
- `@Data`: Lombok annotation to create getters, setters, toString, equals, and hashCode methods.

=== AuthResponse

*Purpose*: DTO for authentication response data.

=== UserPrincipal

*Purpose*: Principal object representing a user.

*Methods*:
- Various `@Override` methods to comply with Spring Security's `UserDetails` interface.

*Fields*:
- `user : final User`: User entity associated with this principal.

*Annotations*:
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

=== Client

*Purpose*: Entity representing a client application.

*Fields*:
- `clientName : String`: Name of the client.
- `clientSecret : String`: Secret key for the client.
- `id : Long`: Unique identifier for the client.
- `redirectUri : String`: URI to redirect after authentication.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Specifies the generation strategy for the primary key.
- `@Getter`: Lombok annotation to generate the getter method.
- `@Id`: Specifies the primary key of an entity.
- `@Setter`: Lombok annotation to generate the setter method.
- `@Table`: Specifies the table that will be used for mapping the entity.

=== Role

*Purpose*: Entity representing a security role.

*Methods*:
- Getters and setters for properties.

*Fields*:
- `id : Long`: Unique identifier for the role.
- `name : String`: Name of the role.
- `users : Set<User>`: Users associated with this role.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Specifies the generation strategy for the primary key.
- `@Id`: Specifies the primary key of an entity.
- `@ManyToMany`: Defines a many-to-many relationship with another entity.
- `@Table`: Specifies the table that will be used for mapping the entity.

=== Token

*Purpose*: Entity representing an authentication token.

*Fields*:
- `accessToken : String`: The access token string.
- `client : Client`: The client associated with this token.
- `id : Long`: Unique identifier for the token.
- `refreshToken : String`: The refresh token string.
- `user : User`: The user associated with this token.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Specifies the generation strategy for the primary key.
- `@Getter`: Lombok annotation to generate the getter method.
- `@Id`: Specifies the primary key of an entity.
- `@JoinColumn`: Specifies a column for joining an entity association.
- `@ManyToOne`: Defines a many-to-one relationship with another entity.
- `@Setter`: Lombok annotation to generate the setter method.
- `@Table`: Specifies the table that will be used for mapping the entity.

=== User

*Purpose*: Entity representing a user.

*Fields*:
- `email : String`: Email address of the user.
- `id : Long`: Unique identifier for the user.
- `passwordHash : String`: Hashed password of the user.
- `roles : Set<Role>`: Security roles associated with the user.
- `username : String`: Username of the user.

*Annotations*:
- `@Column`: Specifies the mapped column for a persistent property.
- `@Data`: Lombok annotation to create getters, setters, toString, equals, and hashCode methods.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Specifies the generation strategy for the primary key.
- `@Getter`: Lombok annotation to generate the getter method.
- `@Id`: Specifies the primary key of an entity.
- `@JoinColumn`: Specifies a column for joining an entity association.
- `@JoinTable`: Specifies the table used for mapping many-to-many associations.
- `@ManyToMany`: Defines a many-to-many relationship with another entity.
- `@Setter`: Lombok annotation to generate the setter method.
- `@Table`: Specifies the table that will be used for mapping the entity.

=== UserRepository

*Purpose*: Repository for accessing `User` entities from the database.

*Annotations*:
- `@Repository`: Indicates that the class is a repository, which encapsulates the logic required to access data sources.

=== AuditService

*Purpose*: Service for logging audit events.

*Methods*:
- `logEvent(String event)`: Logs an audit event.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.

=== EmailService

*Purpose*: Service for sending emails.

*Methods*:
- `sendWelcomeEmail(String to)`: Sends a welcome email to a new user.

*Fields*:
- `notificationService : final NotificationService`: Service for sending notifications.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.

=== JWTService

*Purpose*: Service for handling JWT operations such as creation, extraction, and validation.

*Methods*:
- `extractUsername(String token)`: Extracts the username from the token.
- `generateToken(final String username)`: Generates a new token.
- `validateToken(String token)`: Validates the token.
- `invalidateToken(String token)`: Invalidates the token.

*Fields*:
- `auditService : final AuditService`: Audit service for logging events.
- `secretKey : final Key`: Secret key used for signing tokens.
- `tokenBlacklistService : final TokenBlacklistService`: Service for blacklisting tokens.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.
- `@Slf4j`: Embeds the logger functionality.

=== NotificationService

*Purpose*: Service for sending notifications.

*Methods*:
- `notifyUser(String user, String message)`: Sends a notification to a user.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.

=== TokenBlacklistService

*Purpose*: Service for blacklisting tokens.

*Methods*:
- `blacklistToken(String token)`: Adds a token to the blacklist.

*Annotations*:
- `@Service`: Indicates that the class is a service, which holds business logic.

=== UserService

*Purpose*: Service for user-related operations.

*Methods*:
- `loadUserByUsername(final String username)`: Loads user details by username.
- `register(final User user)`: Registers a new user.

*Fields*:
- `auditService : AuditService`: Service for logging audit events.
- `emailService : EmailService`: Service for sending emails.
- `encoder : BCryptPasswordEncoder`: Password encoder for hashing passwords.
- `userRepository : UserRepository`: Repository for accessing user entities.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Indicates that the class is a service, which holds business logic.

=== IdentityproviderApplicationTests

*Purpose*: Class for conducting tests on the Identity Provider application.

*Annotations*:
- `@SpringBootTest`: Indicates that the class should bootstrap the entire container for integration tests.
- `@Test`: Indicates that the method is a test method.

== 2. Runtime View Diagrams

=== User Registration Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService
participant AuditService

User -> UserController : register(User)
UserController -> UserService : register(User)
UserService -> UserRepository : save(User)
UserRepository -> UserService : User
UserService -> EmailService : sendWelcomeEmail(User.email)
EmailService -> UserService : EmailSent
UserService -> AuditService : logEvent("User registered")
AuditService -> UserService : LogComplete
UserService -> UserController : User
UserController -> User : User
@enduml
```

=== Authentication/Login Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant JWTService
participant AuditService

User -> UserController : login(AuthRequest)
UserController -> UserService : loadUserByUsername(AuthRequest.username)
UserService -> UserController : UserPrincipal
UserController -> JWTService : generateToken(UserPrincipal.username)
JWTService -> UserController : Token
UserController -> AuditService : logEvent("User logged in")
AuditService -> UserController : LogComplete
UserController -> User : AuthResponse(Token)
@enduml
```

=== JWT Token Validation Flow

```plantuml
@startuml
actor User
participant JwtAuthFilter
participant JWTService
participant AuditService

User -> JwtAuthFilter : Request(Resource)
JwtAuthFilter -> JWTService : validateToken(Token)
JWTService -> JwtAuthFilter : isValid
alt isValid
    JwtAuthFilter -> User : Proceed
else not isValid
    JwtAuthFilter -> AuditService : logEvent("Invalid token attempt")
    AuditService -> JwtAuthFilter : LogComplete
    JwtAuthFilter -> User : Unauthorized(Error)
end
@enduml
```

=== Exception Handling Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant AuditService

User -> UserController : request(Action)
alt success
    UserController -> UserService : performAction()
    UserService -> UserController : Result
    UserController -> User : Result
else exception
    UserController -> AuditService : logEvent("Exception occurred")
    AuditService -> UserController : LogComplete
    UserController -> User : ErrorResponse
end
@enduml
```

== 3. Entity Relationship Diagram

```plantuml
@startuml
entity User {
    * id : Long
    * username : String
    * email : String
    * passwordHash : String
    --
    * roles : Set<Role>
}

entity Role {
    * id : Long
    * name : String
    --
    * users : Set<User>
}

entity Client {
    * id : Long
    * clientName : String
    * clientSecret : String
    * redirectUri : String
}

entity Token {
    * id : Long
    * accessToken : String
    * refreshToken : String
    --
    * user : User
    * client : Client
}

User "1" -- "0..*" Role
Role "1" -- "0..*" User
User "1" -- "0..*" Token
Client "1" -- "0..*" Token
@enduml
```

=== Entity Descriptions

- **User**: Represents a user in the system with attributes such as `id`, `username`, `email`, and `passwordHash`. It has a many-to-many relationship with `Role` and a one-to-many relationship with `Token`.
- **Role**: Represents a security role with attributes such as `id` and `name`. It has a many-to-many relationship with `User`.
- **Client**: Represents a client application with attributes such as `id`, `clientName`, `clientSecret`, and `redirectUri`. It has a one-to-many relationship with `Token`.
- **Token**: Represents an authentication token with attributes such as `id`, `accessToken`, and `refreshToken`. It is associated with a `User` and a `Client`.

== 4. Detailed Component Interactions

=== Controller-Service-Repository Interactions

*UserController* interacts with *UserService* to handle user-related operations. *UserService* in turn interacts with *UserRepository* to perform database operations. Results or exceptions are propagated back to the controller which then formats the response to the client.

=== Data Flow Through Layers

Data flows from the controllers to services where business logic is applied. Services interact with repositories to persist or retrieve data. Services may also interact with other services like *EmailService* or *AuditService* for specific operations. Data is then passed back up to the controllers which send responses to the clients.

=== Exception Propagation

Exceptions can occur at any layer of the application. Typically, they are caught in the service layer, logged using *AuditService*, and then propagated back to the controllers where an appropriate HTTP response is generated based on the exception type.

=== Transaction Boundaries

Transactions are managed at the service layer, ensuring that database operations either complete fully or rollback in case of an error, maintaining data integrity.

This detailed design document provides a comprehensive overview of the Identity Provider application, suitable for developers to understand the implementation and interactions within the application.