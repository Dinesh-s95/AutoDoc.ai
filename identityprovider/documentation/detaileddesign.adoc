= Detailed Design Documentation for Identity Provider Application

This document provides a comprehensive detailed design of the Identity Provider Application built using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose*: Serves as the entry point of the Spring Boot application.

*Methods*:
- `public static void main(String[] args)`: Bootstraps the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

*Purpose*: Filters incoming requests and manages authentication using JWT tokens.

*Methods*:
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters requests to check for the presence of a valid JWT token.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected by Spring's dependency injection facilities.
- `@Component`: Indicates that the class is a Spring component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds a logger into the class.

*Fields*:
- `userService : UserService`: Dependency to manage user-related operations.

=== SecurityConfig

*Purpose*: Configures security settings for the application, including authentication and authorization mechanisms.

*Methods*:
- `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Configures the authentication manager.
- `public AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
- `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Defines security rules and paths that are secured.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has `@Bean` definition methods.
- `@EnableWebSecurity`: Enables Spring Securityâ€™s web security support.

*Fields*:
- `jwtAuthFilter : JwtAuthFilter`: The JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose*: Manages user-related operations such as registration and login.

*Methods*:
- `public ResponseEntity<Object> login(@RequestBody final Users user)`: Handles user login requests.
- `public String greet()`: A simple greeting method.
- `public String greet2()`: Another simple greeting method.
- `public Users registerUser(@RequestBody final Users user)`: Handles user registration.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected.
- `@GetMapping`: Annotation for mapping HTTP GET requests onto specific handler methods.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Provides routing information.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Fields*:
- `authManager : AuthenticationManager`: Manages authentication.
- `jwtService : JWTService`: Service to handle JWT operations.
- `userService : UserService`: Service to manage user operations.

=== AuthRequest

*Purpose*: Represents an authentication request holding username and password.

*Annotations*:
- `@Data`: A convenient shortcut annotation that bundles the features of `@ToString`, `@EqualsAndHashCode`, `@Getter` on all fields, `@Setter` on all non-final fields, and `@RequiredArgsConstructor`.

*Fields*:
- `password : String`: User's password.
- `username : String`: User's username.

=== AuthResponse

*Purpose*: Represents the response returned after authentication.

*Annotations*:
- None

*Fields*:
- None

=== UserPrincipal

*Purpose*: Provides user details to Spring Security, which are later encapsulated into Authentication objects.

*Methods*:
- `public Collection<? extends GrantedAuthority> getAuthorities()`: Returns the authorities granted to the user.
- `public String getPassword()`: Returns the user's hashed password.
- `public String getUsername()`: Returns the user's username.
- `public boolean isAccountNonExpired()`: Indicates whether the user's account has expired.
- `public boolean isAccountNonLocked()`: Indicates whether the user is locked or unlocked.
- `public boolean isCredentialsNonExpired()`: Indicates whether the user's credentials (password) has expired.
- `public boolean isEnabled()`: Indicates whether the user is enabled or disabled.

*Annotations*:
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

*Fields*:
- `user : final Users`: The user details.

=== Users

*Purpose*: Represents the user entity in the database.

*Methods*:
- `public String getPassword()`: Returns the user's password.
- `public String getUsername()`: Returns the user's username.

*Annotations*:
- `@Data`: Bundles the features of `@ToString`, `@EqualsAndHashCode`, `@Getter` on all fields, `@Setter` on all non-final fields, and `@RequiredArgsConstructor`.
- `@Entity`: Specifies that the class is an entity.
- `@GeneratedValue`: Specifies the strategy of generation for the primary key.
- `@Getter`: Generates getters for all fields.
- `@Id`: Specifies the primary key of an entity.
- `@Setter`: Generates setters for all fields.

*Fields*:
- `password : String`: The user's hashed password.
- `userId : Long`: The unique ID of the user.
- `username : String`: The user's username.

=== UserRepository

*Purpose*: Interface for CRUD operations on the Users entity.

*Annotations*:
- `@Repository`: Indicates that the class is a repository, which encapsulates the storage, retrieval, and search behavior typically from a relational database.

=== JWTService

*Purpose*: Manages operations related to JWT such as creation and validation.

*Methods*:
- `public String extractUsername(String token)`: Extracts the username from the JWT token.
- `public String generateToken(final String username)`: Generates a JWT token for a given username.
- `public boolean validateToken(String token)`: Validates the provided JWT token.

*Annotations*:
- `@Service`: Indicates that the class is a service.
- `@Slf4j`: Embeds a logger into the class.

*Fields*:
- `secretKey : final Key`: The key used for signing the JWT.

=== UserService

*Purpose*: Manages user-related business logic.

*Methods*:
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads user details by username.
- `public Users register(final Users user)`: Registers a new user.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Indicates that the class is a service.

*Fields*:
- `encoder : BCryptPasswordEncoder`: Encoder for hashing passwords.
- `userRepository : UserRepository`: Repository for CRUD operations on Users.

=== IdentityproviderApplicationTests

*Purpose*: Contains test cases for the application.

*Annotations*:
- `@SpringBootTest`: Provides Spring Boot test features.
- `@Test`: Marks a method as a test method.

== 2. Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business flows in the application using PlantUML.

==== User Registration Flow

```plantuml
@startuml
actor Client
participant UserController
participant UserService
participant UserRepository

Client -> UserController : registerUser(user)
activate UserController

UserController -> UserService : register(user)
activate UserService

UserService -> UserRepository : save(user)
activate UserRepository

UserRepository --> UserService : user
deactivate UserRepository

UserService --> UserController : user
deactivate UserService

UserController --> Client : user
deactivate UserController
@enduml
```

==== Authentication/Login Flow

```plantuml
@startuml
actor Client
participant UserController
participant AuthenticationManager
participant JWTService

Client -> UserController : login(authRequest)
activate UserController

UserController -> AuthenticationManager : authenticate(authRequest)
activate AuthenticationManager

AuthenticationManager --> UserController : authentication
deactivate AuthenticationManager

UserController -> JWTService : generateToken(authentication)
activate JWTService

JWTService --> UserController : token
deactivate JWTService

UserController --> Client : token
deactivate UserController
@enduml
```

==== JWT Token Validation Flow

```plantuml
@startuml
actor Client
participant JwtAuthFilter
participant JWTService

Client -> JwtAuthFilter : doFilterInternal(request, response, filterChain)
activate JwtAuthFilter

JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService

JWTService --> JwtAuthFilter : isValid
deactivate JWTService

JwtAuthFilter --> Client : continue / block
deactivate JwtAuthFilter
@enduml
```

==== Exception Handling Flow

```plantuml
@startuml
actor Client
participant UserController
participant UserService
participant ExceptionHandler

Client -> UserController : performAction()
activate UserController

UserController -> UserService : riskyOperation()
activate UserService

alt success
    UserService --> UserController : result
    deactivate UserService
else error
    UserService -> ExceptionHandler : handleException(e)
    activate ExceptionHandler

    ExceptionHandler --> UserService : ErrorResponse
    deactivate ExceptionHandler

    UserService --> UserController : ErrorResponse
    deactivate UserService
end

UserController --> Client : response
deactivate UserController
@enduml
```

== 3. Entity Relationship Diagram

The following diagram illustrates the entity relationship in the application.

```plantuml
@startuml
entity "Users" {
  * userId : Long
  --
  * username : String
  * password : String
}

@enduml
```

== 4. Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserController** interacts with **UserService** to handle user-related operations such as registration and login.
- **UserService** uses **UserRepository** for database operations like saving a new user or fetching user details.

=== Data Flow Through Layers

- Data flows from **Controllers** to **Services** where business logic is applied. Then it moves to **Repositories** for database operations. The results are sent back the same route to the client.

=== Exception Propagation

- Exceptions are caught in the **Services** and handled by an **ExceptionHandler**. This handler is responsible for converting exceptions into user-friendly responses.

=== Transaction Boundaries

- Transactions are managed at the service layer, ensuring that database operations either complete fully or roll back in case of an error, maintaining data integrity.

This detailed design document provides a comprehensive overview of the Identity Provider Application, enabling developers to understand and contribute effectively to the project.