= Identity Provider Application Detailed Design Documentation

This document provides a comprehensive detailed design of the Identity Provider Application, focusing on class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose*: Serves as the entry point for the Spring Boot application.

*Methods*:
- `public static void main(String[] args)`: Initializes and runs the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

*Purpose*: Intercepts HTTP requests to validate JWT tokens.

*Methods*:
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests and checks for valid JWT tokens.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@Component`: Indicates that the class is a Spring component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds the logger facility.

*Fields*:
- `userService : UserService`: Service used to interact with user data.

=== SecurityConfig

*Purpose*: Configures security settings for the application.

*Methods*:
- `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Defines the authentication manager bean.
- `public AuthenticationProvider authenticationProvider()`: Defines the authentication provider.
- `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Configures the security filter chain.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has `@Bean` definition methods.
- `@EnableWebSecurity`: Adds Spring Security configuration.

*Fields*:
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose*: Handles all user-related operations.

*Methods*:
- `public ResponseEntity<Object> login(@RequestBody final Users user)`: Handles the user login.
- `public Users registerUser(@RequestBody final Users user)`: Registers a new user.
- `public String greet()`, `public String greet2()`: Sample methods to demonstrate controller functionality.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@GetMapping`, `@PostMapping`: Annotations for mapping HTTP GET and POST requests on specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Maps HTTP requests to handler methods.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Fields*:
- `authManager : AuthenticationManager`: Authentication manager for handling authentication.
- `jwtService : JWTService`: Service for JWT operations.
- `userService : UserService`: Service used to interact with user data.

=== AuthRequest

*Purpose*: Represents the authentication request.

*Annotations*:
- `@Data`: Lombok annotation to create all the getters, setters, equals, hash, and toString methods, based on the fields.

*Fields*:
- `password : String`: User's password.
- `username : String`: User's username.

=== AuthResponse

*Purpose*: Represents the authentication response.

*Annotations*: None

*Fields*: None

=== UserPrincipal

*Purpose*: Implements Spring Security's UserDetails interface, providing user information to Spring Security.

*Methods*:
- Various getter methods for user attributes and account status.

*Annotations*:
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

*Fields*:
- `user : final Users`: User details.

=== Users

*Purpose*: Represents the user entity.

*Methods*:
- `public String getPassword()`, `public String getUsername()`: Accessors for user credentials.

*Annotations*:
- `@Data`, `@Entity`, `@GeneratedValue`, `@Getter`, `@Id`, `@Setter`: Annotations for defining an entity model, including automatic handling of getter/setter methods, and database primary key generation.

*Fields*:
- `password : String`: User's password.
- `userId : Long`: User's identifier.
- `username : String`: User's username.

=== UserRepository

*Purpose*: Interface for database operations related to `Users`.

*Annotations*:
- `@Repository`: Indicates that the class is a repository, which abstracts the interaction with the data layer.

=== JWTService

*Purpose*: Provides services related to JWT operations.

*Methods*:
- `public String extractUsername(String token)`: Extracts username from the token.
- `public String generateToken(final String username)`: Generates a JWT token.
- `public boolean validateToken(String token)`: Validates a JWT token.

*Annotations*:
- `@Service`: Marks the class as a service.
- `@Slf4j`: Embeds the logger facility.

*Fields*:
- `secretKey : final Key`: The secret key used for signing the JWT.

=== UserService

*Purpose*: Provides user-related services.

*Methods*:
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads user details.
- `public Users register(final Users user)`: Registers a new user.

*Annotations*:
- `@Autowired`: Marks the dependency injection.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Marks the class as a service.

*Fields*:
- `encoder : BCryptPasswordEncoder`: Password encoder.
- `userRepository : UserRepository`: Repository for user data access.

=== IdentityproviderApplicationTests

*Purpose*: Contains application tests.

*Annotations*:
- `@SpringBootTest`: Indicates that the class should bootstrap with Spring Boot's support.
- `@Test`: Marks methods as test methods.

== 2. Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-flow, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository

User -> UserController : registerUser(user)
UserController -> UserService : register(user)
UserService -> UserRepository : save(user)
UserRepository -> UserService : userSaved
UserService -> UserController : userSaved
UserController -> User : userResponse
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-flow, png]
----
@startuml
actor User
participant UserController
participant AuthenticationManager
participant JWTService

User -> UserController : login(authRequest)
UserController -> AuthenticationManager : authenticate(authRequest)
AuthenticationManager -> UserController : authenticationInfo
UserController -> JWTService : generateToken(authenticationInfo)
JWTService -> UserController : token
UserController -> User : tokenResponse
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-flow, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
JwtAuthFilter -> JWTService : validateToken(token)
JWTService -> JwtAuthFilter : isValid
JwtAuthFilter -> User : proceed / errorResponse
@enduml
----

=== Exception Handling Flow

[plantuml, exception-handling-flow, png]
----
@startuml
actor User
participant UserController
participant UserService
participant ExceptionHandler

User -> UserController : action()
alt success
  UserController -> UserService : process()
  UserService -> UserController : response
  UserController -> User : successResponse
else exception
  UserController -> ExceptionHandler : handleException(e)
  ExceptionHandler -> UserController : errorResponse
  UserController -> User : errorResponse
end
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity Users {
  * userId : Long
  --
  * username : String
  * password : String
}

@enduml
----

== 4. Detailed Component Interactions

=== Controller-Service-Repository Interactions

*UserController* -> *UserService*:
- UserController uses UserService to handle the logic of user registration and login.

*UserService* -> *UserRepository*:
- UserService interacts with UserRepository to perform database operations like saving a new user or fetching user details.

=== Data Flow Through Layers

1. **Controller Layer**: Receives HTTP requests and delegates business operations to the service layer.
2. **Service Layer**: Handles business logic and interacts with the repository layer for data persistence.
3. **Repository Layer**: Directly interacts with the database to perform CRUD operations.

=== Exception Propagation

Exceptions are caught in the service layer and propagated up to the controller layer, where they are handled by a centralized exception handler, which then sends an appropriate HTTP response to the client.

=== Transaction Boundaries

Transactions are managed at the service layer, ensuring that database operations are completed successfully before committing the transaction. If an exception occurs, the transaction is rolled back.

This detailed design document provides a comprehensive overview of the Identity Provider Application, enabling developers to understand and implement the detailed implementation design effectively.