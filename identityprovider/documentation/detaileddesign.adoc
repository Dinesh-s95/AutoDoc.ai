= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design of the Identity Provider application, focusing on class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose:* Serves as the entry point for the Spring Boot application.

*Annotations:*
- `@SpringBootApplication`: Marks this class as a Spring Boot application.

*Methods:*
- `public static void main(String[] args)`: Launches the Spring Boot application.

=== JwtAuthFilter

*Purpose:* A filter in the security chain that handles JWT authentication.

*Annotations:*
- `@Autowired`: Automatically injects the `UserService`.
- `@Component`: Marks this class as a Spring-managed component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds a logger into this class.

*Methods:*
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests to validate JWT tokens.

*Fields:*
- `userService : UserService`: Service used to interact with user data.

=== SecurityConfig

*Purpose:* Configuration for security aspects of the application.

*Annotations:*
- `@Autowired`: Automatically injects dependencies.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has @Bean definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Methods:*
- `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Configures the authentication manager.
- `public AuthenticationProvider authenticationProvider()`: Defines the authentication provider.
- `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Configures the security filter chain.

*Fields:*
- `jwtAuthFilter : JwtAuthFilter`: The JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose:* Controller to handle user-related operations.

*Annotations:*
- `@Autowired`: Automatically injects dependencies.
- `@GetMapping`: Annotation for mapping HTTP GET requests onto specific handler methods.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.
- `@RequestBody`: Annotation indicating a method parameter should be bound to the body of the web request.
- `@RequestMapping`: Annotation for mapping web requests onto methods in request-handling classes.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Methods:*
- `public ResponseEntity<Object> login(@RequestBody final Users user)`: Handles user login.
- `public String greet()`: Test method to greet users.
- `public String greet2()`: Another test method to greet users.
- `public Users registerUser(@RequestBody final Users user)`: Handles user registration.

*Fields:*
- `authManager : AuthenticationManager`: Manages authentication.
- `jwtService : JWTService`: Service to handle JWT operations.
- `userService : UserService`: Service to handle user operations.

=== AuthRequest

*Purpose:* DTO for authentication request data.

*Annotations:*
- `@Data`: Lombok annotation to create getters, setters, toString, equals, hashCode, and required constructors.

*Fields:*
- `password : String`: User's password.
- `username : String`: User's username.

=== AuthResponse

*Purpose:* DTO for authentication response data.

=== UserPrincipal

*Purpose:* Principal representation of a logged-in user.

*Annotations:*
- `@Override`: Indicates overriding a method.

*Methods:*
- `public Collection<? extends GrantedAuthority> getAuthorities()`: Returns the authorities granted to the user.
- `public String getPassword()`: Returns the user's password.
- `public String getUsername()`: Returns the user's username.
- `public boolean isAccountNonExpired()`: Checks if the account is non-expired.
- `public boolean isAccountNonLocked()`: Checks if the account is non-locked.
- `public boolean isCredentialsNonExpired()`: Checks if the credentials are non-expired.
- `public boolean isEnabled()`: Checks if the user is enabled.

*Fields:*
- `user : final Users`: The user entity associated with this principal.

=== Users

*Purpose:* Entity representing a user.

*Annotations:*
- `@Data`: Lombok annotation to create getters, setters, toString, equals, hashCode, and required constructors.
- `@Entity`: Marks the class as a JPA entity.
- `@GeneratedValue`: Specifies the generation strategy for the primary key.
- `@Getter`: Lombok annotation to generate getters.
- `@Id`: Marks a field as the primary key of an entity.
- `@Setter`: Lombok annotation to generate setters.

*Methods:*
- `public String getPassword()`: Returns the user's password.
- `public String getUsername()`: Returns the user's username.

*Fields:*
- `password : String`: User's password.
- `userId : Long`: User's ID.
- `username : String`: User's username.

=== UserRepository

*Purpose:* Repository for accessing user data.

*Annotations:*
- `@Repository`: Marks the class as a repository, which encapsulates the logic required to access data sources.

=== JWTService

*Purpose:* Service to handle JWT operations.

*Annotations:*
- `@Service`: Marks the class as a business service facade.
- `@Slf4j`: Embeds a logger into this class.

*Methods:*
- `public String extractUsername(String token)`: Extracts username from the given token.
- `public String generateToken(final String username)`: Generates a JWT token for the given username.
- `public boolean validateToken(String token)`: Validates the given JWT token.

*Fields:*
- `secretKey : final Key`: The key used for signing JWT tokens.

=== UserService

*Purpose:* Service to handle user-related operations.

*Annotations:*
- `@Autowired`: Automatically injects dependencies.
- `@Override`: Indicates overriding a method.
- `@Service`: Marks the class as a business service facade.

*Methods:*
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads user details by username.
- `public Users register(final Users user)`: Registers a new user.

*Fields:*
- `encoder : BCryptPasswordEncoder`: Encoder for hashing passwords.
- `userRepository : UserRepository`: Repository to access user data.

=== IdentityproviderApplicationTests

*Purpose:* Test class for the application.

*Annotations:*
- `@SpringBootTest`: Indicates that the class should bootstrap with Spring Boot's support.
- `@Test`: Marks a method as a test method.

== 2. Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository

User -> UserController : registerUser(user)
activate UserController
UserController -> UserService : register(user)
activate UserService
UserService -> UserRepository : save(user)
activate UserRepository
UserRepository --> UserService : user
deactivate UserRepository
UserService --> UserController : user
deactivate UserService
UserController --> User : user
deactivate UserController
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserController
participant AuthenticationManager
participant JWTService

User -> UserController : login(authRequest)
activate UserController
UserController -> AuthenticationManager : authenticate(username, password)
activate AuthenticationManager
AuthenticationManager --> UserController : authentication
deactivate AuthenticationManager
UserController -> JWTService : generateToken(username)
activate JWTService
JWTService --> UserController : token
deactivate JWTService
UserController --> User : token
deactivate UserController
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
activate JwtAuthFilter
JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService
JWTService --> JwtAuthFilter : isValid
deactivate JWTService
JwtAuthFilter --> User : proceed / error
deactivate JwtAuthFilter
@enduml
----

=== Exception Handling Flow

[plantuml, exception-handling-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant ExceptionHandler

User -> UserController : action()
activate UserController
UserController -> UserService : process()
activate UserService
alt success
  UserService --> UserController : result
  UserController --> User : successResponse(result)
else exception
  UserService --> UserController : throw new CustomException()
  UserController -> ExceptionHandler : handleException(CustomException)
  ExceptionHandler --> UserController : errorResponse
  UserController --> User : errorResponse
end
deactivate UserService
deactivate UserController
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity Users {
  * userId : Long
  --
  * username : String
  * password : String
}

@enduml
----

== 4. Detailed Component Interactions

=== Controller-Service-Repository Interactions

*UserController -> UserService -> UserRepository:*
- UserController receives HTTP requests and delegates to UserService for business processing.
- UserService performs the business logic and interacts with UserRepository to access or modify user data.

=== Data Flow Through Layers

*Data flows from Controller to Service to Repository:*
- Data received at the Controller layer is passed to the Service layer where business logic is applied.
- The Service layer interacts with the Repository layer to fetch or persist data.

=== Exception Propagation

*Exception handling is centralized in the Controller layer:*
- Services throw exceptions that are caught by Controllers.
- Controllers handle exceptions by returning appropriate HTTP responses.

=== Transaction Boundaries

*Transactions are managed at the Service layer:*
- Each service method that modifies data is annotated with `@Transactional` to ensure database changes are committed or rolled back together.

This detailed design document provides a clear and comprehensive understanding of the Identity Provider application, suitable for developers involved in maintaining or enhancing the system.