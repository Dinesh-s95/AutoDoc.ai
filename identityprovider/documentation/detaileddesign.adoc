= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design of the Identity Provider system developed using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose:* Serves as the entry point for the Spring Boot application.

*Methods:*
- `public static void main(String[] args)`: Launches the Spring Boot application.

*Annotations:*
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

*Purpose:* Custom filter for JWT authentication in the security chain.

*Methods:*
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests and validates JWT tokens.

*Annotations:*
- `@Autowired`: Automatically injects the dependent beans.
- `@Component`: Marks the class as a Spring component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds the logger facility.

*Fields:*
- `userService : UserService`: Service for user-related operations.

=== SecurityConfig

*Purpose:* Configuration for security aspects of the application, such as authentication and authorization.

*Methods:*
- `public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception`: Defines the authentication manager.
- `public AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
- `public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception`: Configures the security filter chain.

*Annotations:*
- `@Autowired`: Injects other components.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has `@Bean` definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Fields:*
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose:* Controller to handle user-related actions like registration and login.

*Methods:*
- `public ResponseEntity<Object> login(@RequestBody final Users user)`: Handles user login.
- `public Users registerUser(@RequestBody final Users user)`: Handles user registration.

*Annotations:*
- `@Autowired`: Injects other components.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Provides routing information.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Fields:*
- `authManager : AuthenticationManager`: Authentication manager for handling authentication.
- `jwtService : JWTService`: Service for JWT operations.
- `userService : UserService`: Service for user-related operations.

=== AuthRequest

*Purpose:* Represents an authentication request with necessary credentials.

*Annotations:*
- `@Data`: Generates boilerplate code like getters/setters and toString.

*Fields:*
- `password : String`: User's password.
- `username : String`: User's username.

=== AuthResponse

*Purpose:* Represents the response after a successful authentication.

*Annotations:*
- None

*Fields:*
- None

=== UserPrincipal

*Purpose:* Principal object representing a user in Spring Security.

*Methods:*
- Various `@Override` methods to comply with Spring Security's `UserDetails` interface.

*Annotations:*
- `@Override`: Indicates overridden methods.

*Fields:*
- `user : final Users`: The user entity associated with this principal.

=== Client

*Purpose:* Represents a client application that can make requests to the server.

*Annotations:*
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database with which this entity is mapped.

*Fields:*
- `clientName : String`: Name of the client.
- `clientSecret : String`: Secret key for the client.
- `id : Long`: Primary key.
- `redirectUri : String`: URI to redirect after authentication.

=== Role

*Purpose:* Represents a security role that can be granted to users.

*Annotations:*
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database with which this entity is mapped.
- `@ManyToMany`: Defines a many-to-many relationship with the `User` entity.

*Methods:*
- Getters and setters for the properties.

*Fields:*
- `id : Long`: Primary key.
- `name : String`: Name of the role.
- `users : Set<User>`: Users that have this role.

=== Token

*Purpose:* Represents an authentication token.

*Annotations:*
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database with which this entity is mapped.
- `@ManyToOne`: Defines a many-to-one relationship with the `User` entity.

*Fields:*
- `accessToken : String`: Access token string.
- `client : Client`: The client this token is associated with.
- `id : Long`: Primary key.
- `refreshToken : String`: Refresh token string.
- `user : User`: The user this token is associated with.

=== User

*Purpose:* Represents a user of the system.

*Annotations:*
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database with which this entity is mapped.
- `@ManyToMany`: Defines a many-to-many relationship with the `Role` entity.

*Fields:*
- `email : String`: User's email.
- `id : Long`: Primary key.
- `passwordHash : String`: Hash of the user's password.
- `roles : Set<Role>`: Security roles of the user.
- `username : String`: User's username.

=== UserRepository

*Purpose:* Repository for performing database operations related to `User` entities.

*Annotations:*
- `@Repository`: Indicates that the class is a repository.

*Fields:*
- None

=== AuditService

*Purpose:* Service for logging audit events.

*Methods:*
- `public void logEvent(String event)`: Logs an audit event.

*Annotations:*
- `@Service`: Marks the class as a service component.

*Fields:*
- None

=== EmailService

*Purpose:* Service for sending emails.

*Methods:*
- `public void sendWelcomeEmail(String to)`: Sends a welcome email.

*Annotations:*
- `@Service`: Marks the class as a service component.

*Fields:*
- `notificationService : final NotificationService`: Service for sending notifications.

=== JWTService

*Purpose:* Service for handling JWT operations.

*Methods:*
- `public String extractUsername(String token)`: Extracts username from the token.
- `public String generateToken(final String username)`: Generates a new token.
- `public boolean validateToken(String token)`: Validates a token.
- `public void invalidateToken(String token)`: Invalidates a token.

*Annotations:*
- `@Service`: Marks the class as a service component.
- `@Slf4j`: Embeds the logger facility.

*Fields:*
- `auditService : final AuditService`: Audit service for logging.
- `secretKey : final Key`: Secret key used for signing tokens.
- `tokenBlacklistService : final TokenBlacklistService`: Service for handling blacklisted tokens.

=== NotificationService

*Purpose:* Service for sending notifications.

*Methods:*
- `public void notifyUser(String user, String message)`: Sends a notification to a user.

*Annotations:*
- `@Service`: Marks the class as a service component.

*Fields:*
- None

=== TokenBlacklistService

*Purpose:* Service for handling blacklisted tokens.

*Methods:*
- `public void blacklistToken(String token)`: Adds a token to the blacklist.

*Annotations:*
- `@Service`: Marks the class as a service component.

*Fields:*
- None

=== UserService

*Purpose:* Service for handling user-related operations.

*Methods:*
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads user details by username.
- `public Users register(final Users user)`: Registers a new user.

*Annotations:*
- `@Autowired`: Automatically injects the dependent beans.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Marks the class as a service component.

*Fields:*
- `auditService : AuditService`: Service for logging audit events.
- `emailService : EmailService`: Service for sending emails.
- `encoder : BCryptPasswordEncoder`: Password encoder for hashing passwords.
- `userRepository : UserRepository`: Repository for user-related database operations.

=== IdentityproviderApplicationTests

*Purpose:* Contains tests for the IdentityproviderApplication.

*Annotations:*
- `@SpringBootTest`: Indicates that the class should bootstrap with Spring Boot's support.
- `@Test`: Indicates that the method is a test method.

*Fields:*
- None

== Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business flows in the system.

==== User Registration Flow

[plantuml, user-registration-flow, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService
participant JWTService

User -> UserController : register(user)
activate UserController

UserController -> UserService : register(user)
activate UserService

UserService -> UserRepository : save(user)
activate UserRepository
UserRepository --> UserService : user
deactivate UserRepository

UserService -> EmailService : sendWelcomeEmail(user.email)
activate EmailService
EmailService --> UserService
deactivate EmailService

UserService -> JWTService : generateToken(user.username)
activate JWTService
JWTService --> UserService : token
deactivate JWTService

UserService --> UserController : user
deactivate UserService

UserController --> User : user
deactivate UserController
@enduml
----

==== Authentication/Login Flow

[plantuml, authentication-login-flow, png]
----
@startuml
actor User
participant UserController
participant UserService
participant JWTService

User -> UserController : login(authRequest)
activate UserController

UserController -> UserService : loadUserByUsername(authRequest.username)
activate UserService
UserService --> UserController : userDetails
deactivate UserService

UserController -> JWTService : generateToken(userDetails.username)
activate JWTService
JWTService --> UserController : token
deactivate JWTService

UserController --> User : token
deactivate UserController
@enduml
----

==== JWT Token Validation Flow

[plantuml, jwt-token-validation-flow, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
activate JwtAuthFilter

JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService
JWTService --> JwtAuthFilter : isValid
deactivate JWTService

JwtAuthFilter --> User : proceed / error
deactivate JwtAuthFilter
@enduml
----

==== Business Process Flow

[plantuml, business-process-flow, png]
----
@startuml
actor User
participant UserController
participant UserService
participant AuditService
participant NotificationService

User -> UserController : performAction()
activate UserController

UserController -> UserService : processAction()
activate UserService

UserService -> AuditService : logEvent("Action performed")
activate AuditService
AuditService --> UserService
deactivate AuditService

UserService -> NotificationService : notifyUser(user, "Action completed")
activate NotificationService
NotificationService --> UserService
deactivate NotificationService

UserService --> UserController : result
deactivate UserService

UserController --> User : result
deactivate UserController
@enduml
----

==== Exception Handling Flow

[plantuml, exception-handling-flow, png]
----
@startuml
actor User
participant UserController
participant UserService
participant AuditService

User -> UserController : request()
activate UserController

alt success
  UserController -> UserService : processRequest()
  activate UserService
  UserService --> UserController : response
  deactivate UserService
else exception
  UserController -> AuditService : logEvent("Exception occurred")
  activate AuditService
  AuditService --> UserController
  deactivate AuditService
  UserController --> User : errorResponse
end

UserController --> User : response
deactivate UserController
@enduml
----

== Entity Relationship Diagram

The following diagram shows the entity relationships in the system.

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "User" {
  *id : Long
  *username : String
  *passwordHash : String
  *email : String
  --
  *roles : Set<Role>
}

entity "Role" {
  *id : Long
  *name : String
  --
  *users : Set<User>
}

entity "Client" {
  *id : Long
  *clientName : String
  *clientSecret : String
  *redirectUri : String
}

entity "Token" {
  *id : Long
  *accessToken : String
  *refreshToken : String
  --
  *user : User
  *client : Client
}

User ||--o{ Role : "has"
Role ||--o{ User : "belongs to"
User ||--o{ Token : "has"
Token }o--|| Client : "belongs to"
@enduml
----

=== Detailed Description of Entities and Relationships

*User:* Represents a system user with attributes such as username, password hash, and email. Each user can have multiple roles and tokens.

*Role:* Represents a security role within the system. Roles can be assigned to multiple users.

*Client:* Represents a client application that can request tokens for accessing resources. Each token is linked to a specific client.

*Token:* Represents an authentication or authorization token that is issued to a user. Each token is associated with a user and a client.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

*UserController* interacts with *UserService* to handle user-related operations such as registration and login. *UserService* uses *UserRepository* to persist user information in the database. For operations like sending emails or logging events, *UserService* interacts with *EmailService* and *AuditService* respectively.

=== Data Flow Through Layers

Data flows from the controllers to services and then to repositories. Data is often transformed between these layers using DTOs (Data Transfer Objects) and entities.

=== Exception Propagation

Exceptions are typically thrown by the service layer and are caught by controllers. Controllers handle exceptions by returning appropriate HTTP responses.

=== Transaction Boundaries

Transactions are managed at the service layer. Each transactional method in the service layer starts a new transaction and commits it when the operation completes successfully or rolls it back if an exception occurs.

== Conclusion

This detailed design document provides a comprehensive overview of the Identity Provider system, including its architecture, class design, interactions, and data management. This document should assist developers in understanding, maintaining, and enhancing the system.