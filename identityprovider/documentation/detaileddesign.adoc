= Detailed Design Documentation for Identity Provider Application

This document provides a comprehensive detailed design of the Identity Provider Application developed using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

*Purpose*: Entry point of the Spring Boot application.

*Methods*:
- `public static void main(String[] args)`: Launches the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

*Purpose*: Filter to intercept requests and perform JWT token validation.

*Methods*:
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Intercepts the request to check for the presence of a JWT token, validates it, and sets the authentication in the security context if the token is valid.

*Annotations*:
- `@Autowired`: Marks a dependency to be injected by Spring.
- `@Component`: Indicates that the class is a Spring component.
- `@Slf4j`: Lombok annotation to provide a logger.

*Fields*:
- `userService: UserService`: Service used to interact with user data.

=== SecurityConfig

*Purpose*: Configuration for security aspects of the application, such as authentication and authorization.

*Methods*:
- `public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception`: Defines the authentication manager bean.
- `public AuthenticationProvider authenticationProvider()`: Defines the authentication provider bean.
- `public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception`: Configures HTTP security, setting up rules for protected resources.

*Annotations*:
- `@Configuration`: Indicates that the class is a source of bean definitions.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Fields*:
- `jwtAuthFilter: JwtAuthFilter`: The JWT authentication filter.
- `userDetailsService: UserDetailsService`: Service to load user-specific data.

=== UserController

*Purpose*: Controller to handle user-related operations such as registration and login.

*Methods*:
- `public ResponseEntity<Object> login(@RequestBody final User user)`: Handles user login requests.
- `public User registerUser(@RequestBody final User user)`: Handles user registration.
- `public ResponseEntity<Object> refreshToken(@RequestBody User user)`: Handles JWT token refresh requests.

*Annotations*:
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps HTTP requests to handler methods.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.

*Fields*:
- `authManager: AuthenticationManager`: Authentication manager for handling login.
- `jwtService: JWTService`: Service for handling JWT operations.
- `userService: UserService`: Service for user-related operations.

=== AuthRequest

*Purpose*: Data transfer object for authentication requests.

*Fields*:
- `username: String`: Username of the user.
- `password: String`: Password of the user.

*Annotations*:
- `@Data`: Lombok annotation to generate getters, setters, `toString`, `equals`, and `hashCode` methods.

=== AuthResponse

*Purpose*: Data transfer object for authentication responses.

=== UserPrincipal

*Purpose*: Principal object representing a user.

*Methods*:
- Implements methods from `UserDetails` interface such as `getAuthorities`, `getPassword`, etc., to be used by Spring Security.

*Fields*:
- `user: final User`: The user entity associated with this principal.

=== Client

*Purpose*: Entity representing an OAuth client.

*Fields*:
- `clientName: String`: Name of the client.
- `clientSecret: String`: Secret key of the client.
- `id: Long`: Identifier of the client.
- `redirectUri: String`: URI to redirect after authentication.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

=== Role

*Purpose*: Entity representing a user role.

*Fields*:
- `id: Long`: Identifier of the role.
- `name: String`: Name of the role.
- `users: Set<User>`: Users associated with this role.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

=== Token

*Purpose*: Entity representing an authentication token.

*Fields*:
- `accessToken: String`: The access token.
- `refreshToken: String`: The refresh token.
- `user: User`: The user associated with this token.
- `client: Client`: The client associated with this token.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

=== User

*Purpose*: Entity representing a user.

*Fields*:
- `email: String`: Email of the user.
- `username: String`: Username of the user.
- `passwordHash: String`: Hashed password of the user.
- `roles: Set<Role>`: Roles assigned to the user.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

=== UserRepository

*Purpose*: Repository for accessing user data.

*Annotations*:
- `@Repository`: Indicates that the class is a repository, a mechanism for encapsulating storage, retrieval, and search behavior.

=== AuditService

*Purpose*: Service for logging audit events.

*Methods*:
- `public void logEvent(String event)`: Logs an audit event.

*Annotations*:
- `@Service`: Marks the class as a service, indicating it's a business service facet.

=== EmailService

*Purpose*: Service for sending emails.

*Methods*:
- `public void sendWelcomeEmail(String to)`: Sends a welcome email to the specified recipient.

*Fields*:
- `notificationService: final NotificationService`: Service used for notification purposes.

*Annotations*:
- `@Service`: Marks the class as a service.

=== JWTService

*Purpose*: Service for handling JWT operations.

*Methods*:
- `public String extractUsername(String token)`: Extracts the username from the token.
- `public String generateToken(final String username)`: Generates a JWT token for the specified username.
- `public boolean validateToken(String token)`: Validates the specified JWT token.
- `public void invalidateToken(String token)`: Invalidates the specified JWT token.

*Fields*:
- `auditService: final AuditService`: Audit service for logging events.
- `secretKey: final Key`: The secret key used for signing JWT tokens.
- `tokenBlacklistService: final TokenBlacklistService`: Service for handling token blacklisting.

*Annotations*:
- `@Service`: Marks the class as a service.
- `@Slf4j`: Lombok annotation to provide a logger.

=== NotificationService

*Purpose*: Service for sending notifications to users.

*Methods*:
- `public void notifyUser(String user, String message)`: Sends a notification to the specified user.

*Annotations*:
- `@Service`: Marks the class as a service.

=== TokenBlacklistService

*Purpose*: Service for blacklisting tokens.

*Methods*:
- `public void blacklistToken(String token)`: Adds the specified token to the blacklist.

*Annotations*:
- `@Service`: Marks the class as a service.

=== UserService

*Purpose*: Service for handling user-related operations.

*Methods*:
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads the user details by username.
- `public User register(final User user)`: Registers a new user.

*Fields*:
- `auditService: AuditService`: Service for logging audit events.
- `emailService: EmailService`: Service for sending emails.
- `encoder: BCryptPasswordEncoder`: Encoder for hashing passwords.
- `userRepository: UserRepository`: Repository for accessing user data.

*Annotations*:
- `@Service`: Marks the class as a service.

=== IdentityproviderApplicationTests

*Purpose*: Class for application tests.

*Annotations*:
- `@SpringBootTest`: Indicates that the class should bootstrap the application for integration tests.
- `@Test`: Indicates that the method is a test method.

== Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate the key business flows in the application using PlantUML.

==== User Registration Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService

User -> UserController : register(user)
UserController -> UserService : register(user)
UserService -> UserRepository : save(user)
UserRepository -> UserService : userSaved
UserService -> EmailService : sendWelcomeEmail(user.email)
EmailService -> UserService : emailSent
UserService -> UserController : userRegistered
UserController -> User : registrationSuccess
@enduml
```

==== Authentication/Login Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant JWTService

User -> UserController : login(authRequest)
UserController -> UserService : loadUserByUsername(authRequest.username)
UserService -> UserController : userDetails
UserController -> JWTService : generateToken(userDetails.username)
JWTService -> UserController : token
UserController -> User : loginSuccess(token)
@enduml
```

==== JWT Token Validation Flow

```plantuml
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
JwtAuthFilter -> JWTService : validateToken(token)
JWTService -> JwtAuthFilter : validationSuccess
JwtAuthFilter -> User : proceed
@enduml
```

==== Business Process Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant JWTService
participant AuditService

User -> UserController : performAction
UserController -> UserService : validateUser
UserService -> UserController : userValid
UserController -> JWTService : checkToken
JWTService -> UserController : tokenValid
UserController -> AuditService : logAction
AuditService -> UserController : logged
UserController -> User : actionPerformed
@enduml
```

==== Exception Handling Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService

User -> UserController : request(invalidData)
alt valid request
  UserController -> UserService : processData
  UserService -> UserController : processed
  UserController -> User : successResponse
else invalid request
  UserController -> User : errorResponse(exceptionMessage)
end
@enduml
```

== Entity Relationship Diagram

The following ER diagram illustrates the relationships between entities in the application using PlantUML.

```plantuml
@startuml
entity User {
  * id : Long
  * username : String
  * email : String
  * passwordHash : String
  --
  * roles : Set<Role>
}

entity Role {
  * id : Long
  * name : String
  --
  * users : Set<User>
}

entity Client {
  * id : Long
  * clientName : String
  * clientSecret : String
  * redirectUri : String
}

entity Token {
  * id : Long
  * accessToken : String
  * refreshToken : String
  --
  * user : User
  * client : Client
}

User ||--o{ Role : has
Role ||--o{ User : belongs to
User ||--o{ Token : owns
Client ||--o{ Token : issued
@enduml
```

=== Detailed Description of Entities and Relationships

*User*: Represents a user in the system. Each user has a unique ID, a username, an email, and a hashed password. Users are associated with roles through a many-to-many relationship, indicating the roles assigned to each user.

*Role*: Represents a role in the system. Each role has a unique ID and a name. Roles are associated with users through a many-to-many relationship, indicating the users who are assigned each role.

*Client*: Represents an OAuth client. Each client has a unique ID, a name, a secret key, and a redirect URI.

*Token*: Represents an authentication token. Each token has a unique ID, an access token, and a refresh token. Tokens are associated with a user and a client, indicating which user owns the token and which client issued it.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

*UserController* interacts with *UserService* to handle user-related operations such as registration and login. *UserService* in turn interacts with *UserRepository* to persist user data. For example, during user registration, *UserController* calls *UserService.register()*, which then calls *UserRepository.save()* to save the user data.

=== Data Flow Through Layers

Data flows from the controllers to services and then to repositories. For instance, user data flows from *UserController* to *UserService* and then to *UserRepository* during the registration process. The flow is generally initiated by a controller method call, processed in the service layer, and then persisted or retrieved from the database in the repository layer.

=== Exception Propagation

Exceptions are typically thrown in the service layer (e.g., when a required data validation fails) and are propagated up to the controller layer where they are caught and handled. Controllers may return an appropriate HTTP response based on the exception type.

=== Transaction Boundaries

Transactions are managed at the service layer. This ensures that all operations within a service method are completed successfully before the transaction is committed. If an exception occurs during the execution of a service method, the transaction is rolled back.

This detailed design document provides a comprehensive overview of the Identity Provider Application, enabling developers to understand and work effectively with the codebase.