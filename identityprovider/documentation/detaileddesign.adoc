= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design of the Identity Provider application, including class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions. This design is intended to guide developers through the application's architecture and functionalities.

== 1. Class-by-Class Analysis

=== 1.1 IdentityproviderApplication

*Purpose*: Serves as the entry point for the Spring Boot application.

*Methods*:
- `public static void main(String[] args)`: Bootstraps the Spring application.

*Annotations*:
- `@SpringBootApplication`: Marks the class as a Spring Boot application, enabling auto-configuration, component scanning, and property support.

=== 1.2 JwtAuthFilter

*Purpose*: Intercepts HTTP requests to validate JWT tokens.

*Methods*:
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests and checks for valid JWT tokens.

*Annotations*:
- `@Autowired`: Automatically injects the required dependencies.
- `@Component`: Marks the class as a Spring component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds a logger into the class.

*Fields*:
- `userService : UserService`: Service for user-related operations.

=== 1.3 SecurityConfig

*Purpose*: Configures security settings for the application.

*Methods*:
- `AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig)`: Provides the authentication manager bean.
- `AuthenticationProvider authenticationProvider()`: Provides the authentication provider bean.
- `SecurityFilterChain securityFilterChain(HttpSecurity http)`: Configures HTTP security.

*Annotations*:
- `@Autowired`: Injects dependencies automatically.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has @Bean definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Fields*:
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== 1.4 UserController

*Purpose*: Handles user-related HTTP requests.

*Methods*:
- `ResponseEntity<Object> login(Users user)`: Handles the login request.
- `Users registerUser(Users user)`: Handles the user registration request.

*Annotations*:
- `@Autowired`: Injects dependencies automatically.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Maps HTTP requests to handler methods.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Fields*:
- `authManager : AuthenticationManager`: Authentication manager for handling authentication.
- `jwtService : JWTService`: Service for JWT operations.
- `userService : UserService`: Service for user-related operations.

=== 1.5 AuthRequest

*Purpose*: Represents an authentication request with username and password.

*Annotations*:
- `@Data`: Generates getters, setters, toString, and hashCode/equality methods.

*Fields*:
- `password : String`: User's password.
- `username : String`: User's username.

=== 1.6 AuthResponse

*Purpose*: Represents an authentication response, typically containing a JWT token.

*Fields*: None.

=== 1.7 UserPrincipal

*Purpose*: Provides user details to Spring Security.

*Methods*:
- Various `@Override` methods to provide user details and authentication status.

*Fields*:
- `user : final Users`: The user entity associated with the principal.

=== 1.8 Client

*Purpose*: Represents a client application that can request tokens.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

*Fields*:
- `clientName : String`: Name of the client.
- `clientSecret : String`: Secret key for the client.
- `id : Long`: Primary key.
- `redirectUri : String`: URI to redirect after authentication.

=== 1.9 Role

*Purpose*: Represents a security role.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

*Methods*:
- Getters and setters for role properties.

*Fields*:
- `id : Long`: Primary key.
- `name : String`: Name of the role.
- `users : Set<User>`: Users associated with this role.

=== 1.10 Token

*Purpose*: Represents an authentication token.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

*Fields*:
- `accessToken : String`: Access token string.
- `client : Client`: Associated client.
- `id : Long`: Primary key.
- `refreshToken : String`: Refresh token string.
- `user : User`: Associated user.

=== 1.11 User

*Purpose*: Represents a user.

*Annotations*:
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.

*Fields*:
- `email : String`: Email of the user.
- `id : Long`: Primary key.
- `passwordHash : String`: Hashed password.
- `roles : Set<Role>`: Security roles of the user.
- `username : String`: Username.

=== 1.12 UserRepository

*Purpose*: Repository for accessing user data.

*Annotations*:
- `@Repository`: Marks the class as a Spring Data repository.

=== 1.13 AuditService

*Purpose*: Provides auditing capabilities.

*Methods*:
- `void logEvent(String event)`: Logs an event.

*Annotations*:
- `@Service`: Marks the class as a Spring service.

=== 1.14 EmailService

*Purpose*: Handles email sending functionalities.

*Methods*:
- `void sendWelcomeEmail(String to)`: Sends a welcome email.

*Annotations*:
- `@Service`: Marks the class as a Spring service.

*Fields*:
- `notificationService : final NotificationService`: Service for sending notifications.

=== 1.15 JWTService

*Purpose*: Manages JWT operations.

*Methods*:
- `String extractUsername(String token)`: Extracts username from the token.
- `String generateToken(String username)`: Generates a new token.
- `boolean validateToken(String token)`: Validates a token.
- `void invalidateToken(String token)`: Invalidates a token.

*Annotations*:
- `@Service`: Marks the class as a Spring service.
- `@Slf4j`: Embeds a logger into the class.

*Fields*:
- `auditService : final AuditService`: Audit service for logging.
- `secretKey : final Key`: Secret key for token generation.
- `tokenBlacklistService : final Token Blacklist Service`: Service for blacklisting tokens.

=== 1.16 NotificationService

*Purpose*: Provides notification functionalities.

*Methods*:
- `void notifyUser(String user, String message)`: Notifies a user.

*Annotations*:
- `@Service`: Marks the class as a Spring service.

=== 1.17 TokenBlacklistService

*Purpose*: Manages blacklisting of tokens.

*Methods*:
- `void blacklistToken(String token)`: Adds a token to the blacklist.

*Annotations*:
- `@Service`: Marks the class as a Spring service.

=== 1.18 UserService

*Purpose*: Provides user-related services.

*Methods*:
- `UserDetails loadUserByUsername(String username) throws UsernameNotFoundException`: Loads user details by username.
- `Users register(Users user)`: Registers a new user.

*Annotations*:
- `@Autowired`: Injects dependencies automatically.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Marks the class as a Spring service.

*Fields*:
- `auditService : AuditService`: Service for auditing.
- `emailService : EmailService`: Service for email functionalities.
- `encoder : BCryptPasswordEncoder`: Password encoder.
- `userRepository : UserRepository`: Repository for user data.

=== 1.19 IdentityproviderApplicationTests

*Purpose*: Provides test functionalities for the application.

*Annotations*:
- `@SpringBootTest`: Indicates that the class should bootstrap the application for testing.
- `@Test`: Indicates that the method is a test method.

== 2. Runtime View Diagrams

=== 2.1 User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService
participant AuditService

User -> UserController : register(user)
activate UserController

UserController -> UserService : register(user)
activate UserService

UserService -> UserRepository : save(user)
activate UserRepository
UserRepository --> UserService : user
deactivate UserRepository

UserService -> EmailService : sendWelcomeEmail(user.email)
activate EmailService
EmailService --> UserService
deactivate EmailService

UserService -> AuditService : logEvent("User registered")
activate AuditService
AuditService --> UserService
deactivate AuditService

UserService --> UserController : user
deactivate UserService

UserController --> User : user
deactivate UserController
@enduml
----

=== 2.2 Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserController
participant AuthenticationManager
participant JWTService
participant AuditService

User -> UserController : login(authRequest)
activate UserController

UserController -> AuthenticationManager : authenticate(authRequest)
activate AuthenticationManager
AuthenticationManager --> UserController : authentication
deactivate AuthenticationManager

UserController -> JWTService : generateToken(authentication.name)
activate JWTService
JWTService --> UserController : token
deactivate JWTService

UserController -> AuditService : logEvent("User logged in")
activate AuditService
AuditService --> UserController
deactivate AuditService

UserController --> User : token
deactivate UserController
@enduml
----

=== 2.3 JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService
participant AuditService

User -> JwtAuthFilter : request(resource)
activate JwtAuthFilter

JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService
JWTService --> JwtAuthFilter : isValid
deactivate JWTService

alt isValid
    JwtAuthFilter -> AuditService : logEvent("Token validated")
    activate AuditService
    AuditService --> JwtAuthFilter
    deactivate AuditService

    JwtAuthFilter --> User : proceed
else
    JwtAuthFilter -> AuditService : logEvent("Invalid token")
    activate AuditService
    AuditService --> JwtAuthFilter
    deactivate AuditService

    JwtAuthFilter --> User : error
end
deactivate JwtAuthFilter
@enduml
----

=== 2.4 Business Process Flow

[plantuml, business-process-flow, png]
----
@startuml
actor User
participant UserController
participant UserService
participant AuditService

User -> UserController : performAction()
activate UserController

UserController -> UserService : processAction()
activate UserService
UserService --> UserController : result
deactivate UserService

UserController -> AuditService : logEvent("Action performed")
activate AuditService
AuditService --> UserController
deactivate AuditService

UserController --> User : result
deactivate UserController
@enduml
----

=== 2.5 Exception Handling Flow

[plantuml, exception-handling-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant AuditService

User -> UserController : request()
activate UserController

alt success
    UserController -> UserService : process()
    activate UserService
    UserService --> UserController : response
    deactivate UserService

    UserController --> User : response
else exception
    UserController -> AuditService : logEvent("Exception occurred")
    activate AuditService
    AuditService --> UserController
    deactivate AuditService

    UserController --> User : errorResponse
end
deactivate UserController
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "User" {
    * id : Long
    --
    * username : String
    * passwordHash : String
    * email : String
    --
    * roles : Set<Role>
}

entity "Role" {
    * id : Long
    --
    * name : String
    --
    * users : Set<User>
}

entity "Client" {
    * id : Long
    --
    * clientName : String
    * clientSecret : String
    * redirectUri : String
}

entity "Token" {
    * id : Long
    --
    * accessToken : String
    * refreshToken : String
    --
    * user : User
    * client : Client
}

User ||--o{ Role : has
Role ||--o{ User : belongs to
User ||--o{ Token : has
Client ||--o{ Token : issued
@enduml
----

=== 3.1 Entity Descriptions

*User*: Represents a user in the system. Each user has a unique ID, a username, a hashed password, an email, and a set of roles.

*Role*: Represents a security role in the system. Each role has a unique ID and a name. Roles are associated with multiple users.

*Client*: Represents a client application that can request tokens. Each client has a unique ID, a name, a secret, and a redirect URI.

*Token*: Represents an authentication token issued to a user by a client. Each token has a unique ID, an access token, a refresh token, and is associated with a user and a client.

== 4. Detailed Component Interactions

=== 4.1 Controller-Service-Repository Interactions

*UserController* interacts with *UserService* for user management tasks. *UserService* in turn interacts with *UserRepository* to persist user data. *UserService* also interacts with *EmailService* to send emails and *AuditService* to log events.

=== 4.2 Data Flow Through Layers

Data flows from the controllers to services and then to repositories. Data transformations and business logic are applied in the services before the data is persisted or updated in the database via repositories.

=== 4.3 Exception Propagation

Exceptions are thrown at the service layer, which are caught and handled in the controllers. Controllers may log these exceptions using *AuditService* and return appropriate error responses to the client.

=== 4.4 Transaction Boundaries

Transactions are managed at the service layer. This ensures that all operations within a single service method are completed successfully before the transaction is committed. If an exception occurs, the transaction is rolled back.

This detailed design document provides a comprehensive overview of the Identity Provider application, guiding developers through the architecture, functionalities, and interactions within the application.