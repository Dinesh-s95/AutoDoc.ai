= Identity Provider Detailed Design Documentation

== Introduction

This document provides a comprehensive detailed design for the Identity Provider application developed using Java Spring Boot. The design includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

`IdentityproviderApplication` is the entry point of the Spring Boot application.

- **Annotations:**
  - `@SpringBootApplication`: Marks this class as a Spring Boot application.

- **Methods:**
  - `public static void main(String[] args)`: Launches the Spring Boot application.

=== JwtAuthFilter

`JwtAuthFilter` is a component that intercepts HTTP requests to perform JWT authentication.

- **Annotations:**
  - `@Component`: Marks this class as a Spring-managed component.
  - `@Slf4j`: Embeds a logger into this class.

- **Fields:**
  - `userService : UserService`: Injected service for user-related operations.

- **Methods:**
  - `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests to validate JWT tokens.

=== SecurityConfig

`SecurityConfig` configures security-related aspects such as authentication and authorization.

- **Annotations:**
  - `@Configuration`: Marks this class as a source of bean definitions.
  - `@EnableWebSecurity`: Enables Spring Security's web security support.

- **Fields:**
  - `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
  - `userDetailsService : UserDetailsService`: Service to load user-specific data.

- **Methods:**
  - `public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig)`: Defines the authentication manager.
  - `public AuthenticationProvider authenticationProvider()`: Defines the authentication provider.
  - `public SecurityFilterChain securityFilterChain(HttpSecurity http)`: Configures the security filter chain.

=== UserController

`UserController` handles all user-related HTTP requests.

- **Annotations:**
  - `@RestController`: Marks this class as a controller where every method returns a domain object instead of a view.
  - `@RequestMapping`: Maps HTTP requests to handler methods.

- **Fields:**
  - `authManager : AuthenticationManager`: Authentication manager for user authentication.
  - `jwtService : JWTService`: Service for JWT operations.
  - `userService : UserService`: Service for user-related operations.

- **Methods:**
  - `public ResponseEntity<Object> login(@RequestBody final User user)`: Handles user login.
  - `public ResponseEntity<Object> refreshToken(@RequestBody User user)`: Handles JWT refresh token generation.
  - `public User registerUser(@RequestBody final User user)`: Registers a new user.

=== AuthRequest

`AuthRequest` is a simple data transfer object (DTO) for authentication requests.

- **Annotations:**
  - `@Data`: Lombok annotation to create getters, setters, toString, equals, and hashCode methods.

- **Fields:**
  - `password : String`: User's password.
  - `username : String`: User's username.

=== AuthResponse

`AuthResponse` is a simple DTO for authentication responses.

=== UserPrincipal

`UserPrincipal` implements Spring Security's `UserDetails` interface, providing user information to Spring Security.

- **Annotations:**
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

- **Fields:**
  - `user : final User`: The user entity associated with this principal.

- **Methods:**
  - `public Collection<? extends GrantedAuthority> getAuthorities()`: Returns the authorities granted to the user.
  - `public String getPassword()`: Returns the user's hashed password.
  - `public String getUsername()`: Returns the username used to authenticate the user.
  - `public boolean isAccountNonExpired()`: Indicates whether the user's account has expired.
  - `public boolean isAccountNonLocked()`: Indicates whether the user is locked or unlocked.
  - `public boolean isCredentialsNonExpired()`: Indicates whether the user's credentials (password) have expired.
  - `public boolean isEnabled()`: Indicates whether the user is enabled or disabled.

=== Client

`Client` represents an OAuth2 client in the system.

- **Annotations:**
  - `@Entity`: Marks this class as a JPA entity.
  - `@Table(name = "clients")`: Specifies the table in the database to which this entity is mapped.
  - `@Id`: Specifies the primary key of an entity.
  - `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
  - `@Column`: Specifies the mapped column for a persistent property or field.
  - `@Getter`: Lombok annotation to generate the getter methods for the fields.
  - `@Setter`: Lombok annotation to generate the setter methods for the fields.

- **Fields:**
  - `id : Long`: The primary key.
  - `clientName : String`: The name of the client.
  - `clientSecret : String`: The secret used for client authentication.
  - `redirectUri : String`: The URI to redirect to after authentication.

=== Role

`Role` represents a user role in the system.

- **Annotations:**
  - `@Entity`: Marks this class as a JPA entity.
  - `@Table(name = "roles")`: Specifies the table in the database to which this entity is mapped.
  - `@Id`: Specifies the primary key of an entity.
  - `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
  - `@Column`: Specifies the mapped column for a persistent property or field.
  - `@ManyToMany`: Defines a many-to-many relationship between two entity classes.

- **Fields:**
  - `id : Long`: The primary key.
  - `name : String`: The name of the role.
  - `users : Set<User>`: The users that have this role.

- **Methods:**
  - `public Long getId()`: Returns the role's ID.
  - `public Set<User> getUsers()`: Returns the users with this role.
  - `public String getName()`: Returns the role's name.
  - `public void setId(Long id)`: Sets the role's ID.
  - `public void setName(String name)`: Sets the role's name.
  - `public void setUsers(Set<User> users)`: Sets the users with this role.

=== Token

`Token` represents an OAuth2 token in the system.

- **Annotations:**
  - `@Entity`: Marks this class as a JPA entity.
  - `@Table(name = "tokens")`: Specifies the table in the database to which this entity is mapped.
  - `@Id`: Specifies the primary key of an entity.
  - `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
  - `@Column`: Specifies the mapped column for a persistent property or field.
  - `@ManyToOne`: Defines a many-to-one relationship between two entity classes.
  - `@JoinColumn`: Specifies a column for joining an entity association or element collection.
  - `@Getter`: Lombok annotation to generate the getter methods for the fields.
  - `@Setter`: Lombok annotation to generate the setter methods for the fields.

- **Fields:**
  - `id : Long`: The primary key.
  - `accessToken : String`: The access token string.
  - `refreshToken : String`: The refresh token string.
  - `client : Client`: The client to which the token is issued.
  - `user : User`: The user to whom the token is issued.

=== User

`User` represents a user in the system.

- **Annotations:**
  - `@Entity`: Marks this class as a JPA entity.
  - `@Table(name = "users")`: Specifies the table in the database to which this entity is mapped.
  - `@Id`: Specifies the primary key of an entity.
  - `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
  - `@Column`: Specifies the mapped column for a persistent property or field.
  - `@ManyToMany`: Defines a many-to-many relationship between two entity classes.
  - `@JoinTable`: Specifies the join table for a many-to-many relationship.
  - `@JoinColumn`: Specifies a column for joining an entity association or element collection.
  - `@Getter`: Lombok annotation to generate the getter methods for the fields.
  - `@Setter`: Lombok annotation to generate the setter methods for the fields.

- **Fields:**
  - `id : Long`: The primary key.
  - `username : String`: The user's username.
  - `email : String`: The user's email address.
  - `passwordHash : String`: The hash of the user's password.
  - `roles : Set<Role>`: The roles assigned to the user.

=== UserRepository

`UserRepository` is a Spring Data repository for `User` entities.

- **Annotations:**
  - `@Repository`: Marks the interface as a Spring Data repository.

=== AuditService

`AuditService` provides functionality to log audit events.

- **Annotations:**
  - `@Service`: Marks this class as a Spring-managed service.

- **Methods:**
  - `public void logEvent(String event)`: Logs an audit event.

=== EmailService

`EmailService` provides functionality to send emails.

- **Annotations:**
  - `@Service`: Marks this class as a Spring-managed service.

- **Fields:**
  - `notificationService : final NotificationService`: The service used for notifications.

- **Methods:**
  - `public void sendWelcomeEmail(String to)`: Sends a welcome email to the specified address.

=== JWTService

`JWTService` provides functionality related to JWT operations.

- **Annotations:**
  - `@Service`: Marks this class as a Spring-managed service.
  - `@Slf4j`: Embeds a logger into this class.

- **Fields:**
  - `auditService : final AuditService`: The audit service for logging.
  - `secretKey : final Key`: The secret key used for signing JWTs.
  - `tokenBlacklistService : final TokenBlacklistService`: The service for blacklisting tokens.

- **Methods:**
  - `public String extractUsername(String token)`: Extracts the username from the specified token.
  - `public String generateToken(final String username)`: Generates a JWT for the specified username.
  - `public boolean validateToken(String token)`: Validates the specified token.
  - `public void invalidateToken(String token)`: Invalidates the specified token.

=== NotificationService

`NotificationService` provides functionality to send notifications to users.

- **Annotations:**
  - `@Service`: Marks this class as a Spring-managed service.

- **Methods:**
  - `public void notifyUser(String user, String message)`: Sends a notification to the specified user.

=== TokenBlacklistService

`TokenBlacklistService` provides functionality to blacklist tokens.

- **Annotations:**
  - `@Service`: Marks this class as a Spring-managed service.

- **Methods:**
  - `public void blacklistToken(String token)`: Blacklists the specified token.

=== UserService

`UserService` provides user-related services and implements Spring Security's `UserDetailsService`.

- **Annotations:**
  - `@Service`: Marks this class as a Spring-managed service.
  - `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

- **Fields:**
  - `auditService : AuditService`: The audit service for logging.
  - `emailService : EmailService`: The email service for sending emails.
  - `encoder : BCryptPasswordEncoder`: The password encoder.
  - `userRepository : UserRepository`: The repository for user data.

- **Methods:**
  - `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads the user details by username.
  - `public User register(final User user)`: Registers a new user.

=== IdentityproviderApplicationTests

`IdentityproviderApplicationTests` includes tests for the Identity Provider application.

- **Annotations:**
  - `@SpringBootTest`: Marks the class as a Spring Boot test, which provides Spring Boot support.
  - `@Test`: Marks a method as a test method.

== Runtime View Diagrams

=== User Registration Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService
participant AuditService

User -> UserController : register(user)
UserController -> UserService : register(user)
UserService -> UserRepository : save(user)
UserRepository -> UserService : userSaved
UserService -> EmailService : sendWelcomeEmail(user.email)
EmailService -> UserService : emailSent
UserService -> AuditService : logEvent("User registered")
AuditService -> UserService : eventLogged
UserService -> UserController : user
UserController -> User : user
@enduml
```

=== Authentication/Login Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant JWTService
participant AuditService

User -> UserController : login(authRequest)
UserController -> UserService : loadUserByUsername(authRequest.username)
UserService -> UserController : userDetails
UserController -> JWTService : generateToken(userDetails.username)
JWTService -> UserController : token
UserController -> AuditService : logEvent("User logged in")
AuditService -> UserController : eventLogged
UserController -> User : token
@enduml
```

=== JWT Token Validation Flow

```plantuml
@startuml
actor User
participant JwtAuthFilter
participant JWTService
participant AuditService

User -> JwtAuthFilter : request(resource)
JwtAuthFilter -> JWTService : validateToken(token)
JWTService -> JwtAuthFilter : isValid
alt isValid
    JwtAuthFilter -> AuditService : logEvent("Token validated")
    AuditService -> JwtAuthFilter : eventLogged
    JwtAuthFilter -> User : proceed
else not isValid
    JwtAuthFilter -> AuditService : logEvent("Invalid token")
    AuditService -> JwtAuthFilter : eventLogged
    JwtAuthFilter -> User : error(response)
end
@enduml
```

=== Exception Handling Flow

```plantuml
@startuml
actor User
participant UserController
participant UserService
participant AuditService

User -> UserController : request(action)
alt success
    UserController -> UserService : performAction()
    UserService -> UserController : result
    UserController -> User : result
else exception
    UserController -> AuditService : logEvent("Exception occurred")
    AuditService -> UserController : eventLogged
    UserController -> User : errorResponse
end
@enduml
```

== Entity Relationship Diagram

```plantuml
@startuml
entity User {
    * id : Long
    --
    * username : String
    * email : String
    * passwordHash : String
    --
    * roles : Set<Role>
}

entity Role {
    * id : Long
    --
    * name : String
    --
    * users : Set<User>
}

entity Client {
    * id : Long
    --
    * clientName : String
    * clientSecret : String
    * redirectUri : String
}

entity Token {
    * id : Long
    --
    * accessToken : String
    * refreshToken : String
    --
    * client : Client
    * user : User
}

User "1" -- "0..*" Role : has >
Role "1" -- "0..*" User : has >
User "1" -- "0..*" Token : has >
Token "1" -- "1" Client : has >
Token "1" -- "1" User : has >
@enduml
```

=== Entity Descriptions

- **User**: Represents a user in the system with attributes such as username, email, and password hash. A user can have multiple roles and tokens.
- **Role**: Represents a role in the system with a name attribute. A role can be assigned to multiple users.
- **Client**: Represents an OAuth2 client with attributes such as client name, client secret, and redirect URI.
- **Token**: Represents an OAuth2 token with attributes such as access token and refresh token. Each token is associated with a user and a client.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserController** interacts with **UserService** to handle user registration, login, and token refresh operations.
- **UserService** interacts with **UserRepository** to persist user data.
- **UserService** also interacts with **EmailService** and **AuditService** to send welcome emails and log events, respectively.

=== Data Flow Through Layers

- Data flows from the **Controller** layer to the **Service** layer where business logic is executed. Then, data flows to the **Repository** layer where it is persisted in the database. The service layer may also interact with other services like **EmailService** and **AuditService** for operations like sending emails and logging.

=== Exception Propagation

- Exceptions are caught in the **Controller** layer where they are logged and an appropriate error response is returned to the client.

=== Transaction Boundaries

- Transactions are managed at the **Service** layer, ensuring that database operations are completed successfully before committing the transaction. If an exception occurs, the transaction is rolled back.

== Conclusion

This detailed design document provides a comprehensive overview of the Identity Provider application, including class descriptions, interactions, and processes. It serves as a guide for developers to understand and implement the system according to the specified design.