= Identity Provider Application Detailed Design Documentation

== Overview

This document provides a detailed design analysis of the Identity Provider Application, focusing on its Java Spring Boot implementation. The application is structured around the core functionalities of user authentication, registration, and JWT token management.

== Class-by-Class Analysis

=== IdentityproviderApplication

==== Purpose
The main entry point for the Spring Boot application.

==== Methods
- `public static void main(String[] args)`: Bootstraps the Spring Boot application.

==== Annotations
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== JwtAuthFilter

==== Purpose
A filter in the security chain that intercepts requests for JWT authentication.

==== Methods
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests and checks for JWT in the Authorization header.

==== Annotations
- `@Autowired`: Marks a dependency to be injected by Spring.
- `@Component`: Indicates that the class is a Spring-managed component.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Embeds a logger into the class using Lombok.

==== Fields
- `userService : UserService`: Service for user-related operations.

=== SecurityConfig

==== Purpose
Configuration for security aspects of the application, such as authentication and authorization.

==== Methods
- `public AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig) throws Exception`: Defines the authentication manager.
- `public AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
- `public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception`: Configures the security filter chain.

==== Annotations
- `@Autowired`: Marks a dependency to be injected by Spring.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has `@Bean` definition methods.
- `@EnableWebSecurity`: Enables Spring Securityâ€™s web security support.

==== Fields
- `jwtAuthFilter : JwtAuthFilter`: JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

==== Purpose
Controller to handle user-related operations like login and registration.

==== Methods
- `public ResponseEntity<Object> login(@RequestBody final Users user)`: Handles user login.
- `public String greet()`: A simple greeting endpoint.
- `public String greet2()`: Another simple greeting endpoint.
- `public Users registerUser(@RequestBody final Users user)`: Handles user registration.

==== Annotations
- `@Autowired`: Marks a dependency to be injected by Spring.
- `@GetMapping`: Annotation for mapping HTTP GET requests onto specific handler methods.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.
- `@RequestBody`: Annotation indicating a method parameter should be bound to the body of the web request.
- `@RequestMapping`: Annotation for mapping web requests onto methods in request-handling classes.
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.

==== Fields
- `authManager : AuthenticationManager`: Authentication manager for handling authentication.
- `jwtService : JWTService`: Service for JWT operations.
- `userService : UserService`: Service for user-related operations.

=== AuthRequest

==== Purpose
Data transfer object for authentication requests.

==== Fields
- `password : String`: User's password.
- `username : String`: User's username.

==== Annotations
- `@Data`: Lombok annotation to create getters, setters, `toString`, `equals`, `hashCode`, and `requiredArgsConstructor` automatically.

=== AuthResponse

==== Purpose
Data transfer object for authentication responses.

=== UserPrincipal

==== Purpose
Spring Security principal that represents a user.

==== Methods
- `public Collection<? extends GrantedAuthority> getAuthorities()`: Returns the authorities granted to the user.
- `public String getPassword()`: Returns the user's hashed password.
- `public String getUsername()`: Returns the username.
- `public boolean isAccountNonExpired()`: Checks if the user's account is non-expired.
- `public boolean isAccountNonLocked()`: Checks if the user's account is non-locked.
- `public boolean isCredentialsNonExpired()`: Checks if the user's credentials are non-expired.
- `public boolean isEnabled()`: Checks if the user is enabled.

==== Annotations
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.

==== Fields
- `user : final Users`: The user entity associated with this principal.

=== Users

==== Purpose
Entity representing a user in the system.

==== Methods
- `public String getPassword()`: Returns the user's hashed password.
- `public String getUsername()`: Returns the username.

==== Annotations
- `@Data`: Lombok annotation to create getters, setters, `toString`, `equals`, `hashCode`, and `requiredArgsConstructor` automatically.
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@GeneratedValue`: Specifies the generation strategy for the primary key.
- `@Getter`: Lombok annotation to generate getters.
- `@Id`: Specifies the primary key of an entity.
- `@Setter`: Lombok annotation to generate setters.

==== Fields
- `password : String`: The hashed password of the user.
- `userId : Long`: The unique ID of the user.
- `username : String`: The username of the user.

=== UserRepository

==== Purpose
Repository for handling CRUD operations on user entities.

==== Annotations
- `@Repository`: Indicates that the class is a repository, which encapsulates the logic required to access data sources.

=== JWTService

==== Purpose
Service for handling JWT creation and validation.

==== Methods
- `public String extractUsername(String token)`: Extracts the username from the JWT.
- `public String generateToken(final String username)`: Generates a JWT for the given username.
- `public boolean validateToken(String token)`: Validates the given JWT.

==== Annotations
- `@Service`: Indicates that the class is a service, a business logic or service layer.
- `@Slf4j`: Embeds a logger into the class using Lombok.

==== Fields
- `secretKey : final Key`: The key used for signing the JWT.

=== UserService

==== Purpose
Service for handling user-related operations.

==== Methods
- `public UserDetails loadUserByUsername(final String username) throws UsernameNotFoundException`: Loads the user details by username.
- `public Users register(final Users user)`: Registers a new user.

==== Annotations
- `@Autowired`: Marks a dependency to be injected by Spring.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Service`: Indicates that the class is a service, a business logic or service layer.

==== Fields
- `encoder : BCryptPasswordEncoder`: Encoder for hashing passwords.
- `userRepository : UserRepository`: Repository for user entities.

=== IdentityproviderApplicationTests

==== Purpose
Class for conducting Spring Boot tests.

==== Annotations
- `@SpringBootTest`: Indicates that the class should bootstrap the application for testing.
- `@Test`: Indicates that the method is a test method.

== Runtime View Diagrams

=== Sequence Diagrams

==== User Registration Flow

[plantuml, user-registration-flow, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository

User -> UserController : registerUser(user)
activate UserController

UserController -> UserService : register(user)
activate UserService

UserService -> UserRepository : save(user)
activate UserRepository

UserRepository --> UserService : user
deactivate UserRepository

UserService --> UserController : user
deactivate UserService

UserController --> User : user
deactivate UserController
@enduml
----

==== Authentication/Login Flow

[plantuml, authentication-flow, png]
----
@startuml
actor User
participant UserController
participant UserService
participant JWTService

User -> UserController : login(authRequest)
activate UserController

UserController -> UserService : loadUserByUsername(username)
activate UserService

UserService --> UserController : userDetails
deactivate UserService

UserController -> JWTService : generateToken(username)
activate JWTService

JWTService --> UserController : token
deactivate JWTService

UserController --> User : token
deactivate UserController
@enduml
----

==== JWT Token Validation Flow

[plantuml, jwt-validation-flow, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : Request (with JWT)
activate JwtAuthFilter

JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService

JWTService --> JwtAuthFilter : isValid
deactivate JWTService

JwtAuthFilter --> User : Proceed / Error
deactivate JwtAuthFilter
@enduml
----

=== Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "Users" {
  * userId : Long <<generated>>
  --
  * username : String
  * password : String
}

@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserController**:
  - Interacts with **UserService** to handle user registration and loading user details.
  - Uses **JWTService** to generate JWTs post-authentication.

- **UserService**:
  - Interacts with **UserRepository** to save and retrieve user data.
  - Uses **BCryptPasswordEncoder** to hash passwords before saving to the database.

- **JwtAuthFilter**:
  - Uses **JWTService** to validate JWTs in incoming requests.

=== Data Flow Through Layers

- Data flows from Controllers to Services and then to Repositories for database operations.
- Data then flows back from Repositories to Services and finally to Controllers to be sent as responses.

=== Exception Propagation

- Exceptions in Repositories are caught and handled in Services.
- Services may throw exceptions that are caught and handled in Controllers.

=== Transaction Boundaries

- Transactions are typically started at the Service layer where business logic begins, and are committed when the business process completes successfully or rolled back in case of exceptions.

== Conclusion

This detailed design document provides a comprehensive overview of the Identity Provider Application, detailing its class structures, interactions, and key processes. It serves as a guide for developers to understand and contribute to the project effectively.