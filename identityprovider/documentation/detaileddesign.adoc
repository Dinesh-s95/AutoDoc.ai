= Detailed Design Documentation for Identity Provider Application

This document provides a comprehensive detailed design of an Identity Provider Application developed using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

Purpose::
This class serves as the entry point for the Spring Boot application.

Methods::
- `public static void main(String[] args)`: This method launches the Spring Boot application.

Annotations::
- `@SpringBootApplication`: Indicates that this class is the primary configuration class and triggers Spring Boot auto-configuration and component scanning.

=== JwtAuthFilter

Purpose::
This class is responsible for JWT authentication filtering in the security chain.

Methods::
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException`: Filters incoming requests and validates JWT tokens.

Annotations::
- `@Autowired`: Automatically injects the required dependencies.
- `@Component`: Marks this class as a Spring component.
- `@Override`: Indicates that this method overrides a superclass method.
- `@Slf4j`: Embeds a logger into this class.

Fields::
- `userService : UserService`: Dependency to interact with user data.

=== SecurityConfig

Purpose::
Configures security settings for the application, such as authentication mechanisms and security filters.

Methods::
- `AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig)`: Configures the authentication manager.
- `AuthenticationProvider authenticationProvider()`: Defines the authentication provider.
- `SecurityFilterChain securityFilterChain(HttpSecurity http)`: Configures the security filter chain.

Annotations::
- `@Autowired`: Injects dependencies automatically.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has @Bean definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

Fields::
- `jwtAuthFilter : JwtAuthFilter`: The JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

Purpose::
Handles all user-related operations such as registration, login, and token refresh.

Methods::
- `ResponseEntity<Object> login(@RequestBody final User user)`: Authenticates a user and returns a login response.
- `ResponseEntity<Object> refreshToken(@RequestBody User user)`: Refreshes the authentication token.
- `User registerUser(@RequestBody final User user)`: Registers a new user.

Annotations::
- `@Autowired`: Injects dependencies.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.
- `@RequestMapping`: Maps HTTP requests to handler methods.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

Fields::
- `authManager : AuthenticationManager`: Manages authentication.
- `jwtService : JWTService`: Service for handling JWT operations.
- `userService : UserService`: Service for user-related operations.

=== AuthRequest

Purpose::
Represents an authentication request containing username and password.

Annotations::
- `@Data`: Generates getters, setters, toString, equals, and hashCode methods.

Fields::
- `password : String`: The user's password.
- `username : String`: The user's username.

=== AuthResponse

Purpose::
Represents an authentication response, typically containing a JWT token.

=== UserPrincipal

Purpose::
Implements the UserDetails interface providing user information to Spring Security.

Methods::
- Implements all required methods from `UserDetails` such as `getAuthorities`, `getPassword`, etc.

Annotations::
- `@Override`: Indicates overridden methods.

Fields::
- `user : final User`: The user data.

=== Client

Purpose::
Represents a client entity in the system.

Annotations::
- `@Entity`: Marks this class as a JPA entity.
- `@Table`: Specifies the table in the database for this entity.
- `@Column`: Specifies the column mappings.
- `@GeneratedValue`: Specifies the strategy for primary key generation.
- `@Id`: Marks a field as the primary key.
- `@Getter/@Setter`: Generates getters and setters.

Fields::
- `clientName : String`: Name of the client.
- `clientSecret : String`: Secret key for the client.
- `id : Long`: Unique identifier.
- `redirectUri : String`: URI to redirect after authentication.

=== Role

Purpose::
Represents a role entity which can be assigned to users.

Annotations::
- `@Entity`: Marks this class as a JPA entity.
- `@Table`: Specifies the table in the database.
- `@Column`: Column mappings.
- `@GeneratedValue`: Primary key generation strategy.
- `@Id`: Primary key field.
- `@ManyToMany`: Specifies a many-to-many relationship with the User entity.

Methods::
- Standard getters and setters.

Fields::
- `id : Long`: Unique identifier.
- `name : String`: Name of the role.
- `users : Set<User>`: Users associated with this role.

=== Token

Purpose::
Represents a token entity for storing access and refresh tokens.

Annotations::
- `@Entity`: Marks as a JPA entity.
- `@Table`: Specifies the table.
- `@Column`: Column mappings.
- `@GeneratedValue`: Primary key generation.
- `@Id`: Primary key.
- `@ManyToOne`: Specifies a many-to-one relationship with User.
- `@JoinColumn`: Specifies the column for joining an entity association.

Fields::
- `accessToken : String`: The access token.
- `client : Client`: The client associated with this token.
- `id : Long`: Unique identifier.
- `refreshToken : String`: The refresh token.
- `user : User`: The user associated with this token.

=== User

Purpose::
Represents a user entity in the system.

Annotations::
- `@Entity`: Marks as a JPA entity.
- `@Table`: Specifies the table.
- `@Column`: Column mappings.
- `@GeneratedValue`: Primary key generation.
- `@Id`: Primary key.
- `@ManyToMany`: Specifies a many-to-many relationship with Role.
- `@JoinTable`: Specifies the join table for a many-to-many relationship.
- `@JoinColumn`: Join column for a many-to-many relationship.
- `@Data`: Generates getters, setters, and other methods.

Fields::
- `email : String`: Email of the user.
- `id : Long`: Unique identifier.
- `passwordHash : String`: Hashed password.
- `roles : Set<Role>`: Roles assigned to the user.
- `username : String`: Username.

=== UserRepository

Purpose::
Interface for database operations related to the User entity.

Annotations::
- `@Repository`: Marks the interface as a repository which is an abstraction of data access and storage.

=== AuditService

Purpose::
Provides functionality to log different events within the application.

Methods::
- `void logEvent(String event)`: Logs an event.

Annotations::
- `@Service`: Marks the class as a service which holds business logic.

=== EmailService

Purpose::
Handles sending emails to users.

Methods::
- `void sendWelcomeEmail(String to)`: Sends a welcome email to a new user.

Annotations::
- `@Service`: Indicates that this class is a service.

Fields::
- `notificationService : final NotificationService`: Service for sending notifications.

=== JWTService

Purpose::
Handles all operations related to JWT including creation, extraction, and validation.

Methods::
- `String extractUsername(String token)`: Extracts username from the token.
- `String generateToken(String username)`: Generates a new token.
- `boolean validateToken(String token)`: Validates the given token.
- `void invalidateToken(String token)`: Invalidates the token.

Annotations::
- `@Service`: Marks the class as a service.
- `@Slf4j`: Embeds a logger into this class.

Fields::
- `auditService : final AuditService`: Audit service for logging.
- `secretKey : final Key`: The secret key used for token generation.
- `tokenBlacklistService : final TokenBlacklistService`: Service to blacklist tokens.

=== NotificationService

Purpose::
Provides notification services to the application, such as notifying users.

Methods::
- `void notifyUser(String user, String message)`: Notifies a user with a message.

Annotations::
- `@Service`: Marks the class as a service.

=== TokenBlacklistService

Purpose::
Handles blacklisting of tokens.

Methods::
- `void blacklistToken(String token)`: Adds a token to the blacklist.

Annotations::
- `@Service`: Indicates that this class is a service.

=== UserService

Purpose::
Provides user-related services such as loading user details and registering users.

Methods::
- `UserDetails loadUserByUsername(String username) throws UsernameNotFoundException`: Loads user details by username.
- `User register(User user)`: Registers a new user.

Annotations::
- `@Autowired`: Automatically injects required dependencies.
- `@Override`: Indicates overridden methods.
- `@Service`: Marks the class as a service.

Fields::
- `auditService : AuditService`: Service for auditing.
- `emailService : EmailService`: Service for sending emails.
- `encoder : BCryptPasswordEncoder`: Encoder for password hashing.
- `userRepository : UserRepository`: Repository for user data access.

=== IdentityproviderApplicationTests

Purpose::
Contains tests for the Identity Provider Application.

Annotations::
- `@SpringBootTest`: Indicates that the class should bootstrap the application for integration tests.
- `@Test`: Indicates that the method is a test method.

== Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business flows in the application:

==== User Registration Flow

[plantuml, "user-registration-sequence", png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService

User -> UserController : register(user)
activate UserController

UserController -> UserService : register(user)
activate UserService

UserService -> UserRepository : save(user)
activate UserRepository
UserRepository -> UserRepository : saveUser
deactivate UserRepository

UserService -> EmailService : sendWelcomeEmail(user.email)
activate EmailService
EmailService -> EmailService : sendEmail
deactivate EmailService

UserService -> UserService : return user
deactivate UserService

UserController -> UserController : return user
deactivate UserController
@enduml
----

==== Authentication/Login Flow

[plantuml, "login-sequence", png]
----
@startuml
actor User
participant UserController
participant AuthManager
participant JWTService

User -> UserController : login(authRequest)
activate UserController

UserController -> AuthManager : authenticate(authRequest)
activate AuthManager
AuthManager -> AuthManager : validateCredentials
deactivate AuthManager

UserController -> JWTService : generateToken(user.username)
activate JWTService
JWTService -> JWTService : createJWT
deactivate JWTService

UserController -> UserController : return token
deactivate UserController
@enduml
----

==== JWT Token Validation Flow

[plantuml, "jwt-validation-sequence", png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
activate JwtAuthFilter

JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService
JWTService -> JWTService : checkValidity
deactivate JWTService

JwtAuthFilter -> JwtAuthFilter : proceed(request)
deactivate JwtAuthFilter
@enduml
----

==== Business Process Flow

[plantuml, "business-process-sequence", png]
----
@startuml
actor User
participant UserController
participant UserService
participant AuditService

User -> UserController : performAction()
activate UserController

UserController -> UserService : processAction()
activate UserService

UserService -> AuditService : logEvent("Action performed")
activate AuditService
AuditService -> AuditService : log
deactivate AuditService

UserService -> UserService : return result
deactivate UserService

UserController -> UserController : return response
deactivate UserController
@enduml
----

==== Exception Handling Flow

[plantuml, "exception-handling-sequence", png]
----
@startuml
actor User
participant UserController
participant UserService

User -> UserController : request()
activate UserController

alt success
  UserController -> UserService : processRequest()
  activate UserService
  UserService -> UserService : return data
  deactivate UserService
  UserController -> UserController : return response
else exception
  UserController -> UserController : handleException()
  UserController -> UserController : return errorResponse
end
deactivate UserController
@enduml
----

== Entity Relationship Diagram

[plantuml, "entity-relationship-diagram", png]
----
@startuml
entity User {
  * id : Long
  * username : String
  * passwordHash : String
  * email : String
  --
  * roles : Set<Role>
}

entity Role {
  * id : Long
  * name : String
  --
  * users : Set<User>
}

entity Client {
  * id : Long
  * clientName : String
  * clientSecret : String
  * redirectUri : String
}

entity Token {
  * id : Long
  * accessToken : String
  * refreshToken : String
  --
  * user : User
  * client : Client
}

User "1" -- "0..*" Role : has >
Role "1" -- "0..*" User : has >
User "1" -- "0..*" Token : has >
Client "1" -- "0..*" Token : has >
@enduml
----

Description::
- `User`: Represents a user in the system. Each user has a unique ID, username, password hash, and email. Users are associated with multiple roles.
- `Role`: Represents a security role. Each role has a unique ID and name. Roles are associated with multiple users.
- `Client`: Represents a client application that can request tokens. Each client has a unique ID, name, secret, and redirect URI.
- `Token`: Represents an authentication or refresh token. Each token has a unique ID, access token, and refresh token. Tokens are associated with a user and a client.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- `UserController` interacts with `UserService` to handle user-related operations such as registration and login.
- `UserService` uses `UserRepository` to persist user information to the database.
- `UserService` may also interact with services like `EmailService` to perform operations like sending welcome emails.

=== Data Flow Through Layers

- Data flows from the controllers to services where business logic is applied. Then, data is either persisted or retrieved from the database through repositories. Finally, responses are sent back to the client.

=== Exception Propagation

- Exceptions are typically thrown at the service or repository layers. These exceptions are caught in the controllers where appropriate error responses are generated.

=== Transaction Boundaries

- Transactions are managed at the service layer, ensuring that database operations are completed successfully before committing the transaction.

This detailed design document should provide developers with a clear understanding of the Identity Provider Application's architecture, helping them to maintain and enhance the system effectively.