= Identity Provider Detailed Design Documentation

This document provides a detailed design overview of the Identity Provider application, including class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== IdentityproviderApplication

[source,java]
----
@SpringBootApplication
public class IdentityproviderApplication {
    public static void main(String[] args) {
        SpringApplication.run(IdentityproviderApplication.class, args);
    }
}
----

*Purpose*: This is the main class that boots up the Spring Boot application.

*Annotations*:
- `@SpringBootApplication`: Serves as a convenience annotation that adds all of the following: `@Configuration`, `@EnableAutoConfiguration`, and `@ComponentScan`.

*Methods*:
- `main(String[] args)`: The entry point of the Spring Boot application which starts the application context.

=== JwtAuthFilter

[source,java]
----
@Component
@Slf4j
public class JwtAuthFilter extends OncePerRequestFilter {
    @Autowired
    private UserService userService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException {
        // Implementation details
    }
}
----

*Purpose*: To intercept requests and perform JWT token validation.

*Annotations*:
- `@Component`: Marks this class as a Spring-managed component.
- `@Slf4j`: Lombok annotation to provide `log` object for logging.

*Methods*:
- `doFilterInternal(HttpServletRequest, HttpServletResponse, FilterChain)`: Filters incoming requests and checks for JWT token validity.

*Fields*:
- `userService : UserService`: Autowired service for user-related operations.

=== SecurityConfig

[source,java]
----
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    @Autowired
    private JwtAuthFilter jwtAuthFilter;
    @Autowired
    private UserDetailsService userDetailsService;

    @Bean
    public AuthenticationManager authenticationManager(final AuthenticationConfiguration authConfig) throws Exception {
        return authConfig.getAuthenticationManager();
    }

    @Bean
    public AuthenticationProvider authenticationProvider() {
        // Implementation details
    }

    @Bean
    public SecurityFilterChain securityFilterChain(final HttpSecurity http) throws Exception {
        // Implementation details
    }
}
----

*Purpose*: Configuration for security aspects of the application, such as authentication and authorization.

*Annotations*:
- `@Configuration`: Indicates that the class has @Bean definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Methods*:
- `authenticationManager(AuthenticationConfiguration)`: Provides the authentication manager bean.
- `authenticationProvider()`: Provides the authentication provider bean.
- `securityFilterChain(HttpSecurity)`: Configures the security filter chain.

*Fields*:
- `jwtAuthFilter : JwtAuthFilter`: The JWT authentication filter.
- `userDetailsService : UserDetailsService`: Service to load user-specific data.

=== UserController

[source,java]
----
@RestController
@RequestMapping("/idp/users")
public class UserController {
    @Autowired
    private AuthenticationManager authManager;
    @Autowired
    private JWTService jwtService;
    @Autowired
    private UserService userService;

    @PostMapping("/login")
    public ResponseEntity<Object> login(@RequestBody final Users user) {
        // Implementation details
    }

    @PostMapping("/refreshtoken")
    public ResponseEntity<Object> refreshToken() {
        // Implementation details
    }

    @PostMapping("/register")
    public Users registerUser(@RequestBody final Users user) {
        return userService.register(user);
    }
}
----

*Purpose*: Controller to handle user-related operations such as registration and login.

*Annotations*:
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping("/idp/users")`: Maps HTTP requests to handler methods of MVC and REST controllers.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.

*Methods*:
- `login(Users)`: Authenticates a user and returns a JWT.
- `refreshToken()`: Provides a new JWT to a user with a valid current JWT.
- `registerUser(Users)`: Registers a new user in the system.

*Fields*:
- `authManager : AuthenticationManager`: Manages authentication within the application.
- `jwtService : JWTService`: Service to handle JWT creation and validation.
- `userService : UserService`: Service for user-related data access and business logic.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant JWTService
participant EmailService

User -> UserController : register(userDetails)
activate UserController
UserController -> UserService : register(userDetails)
activate UserService
UserService -> UserRepository : save(user)
activate UserRepository
UserRepository -> UserRepository : saveToDB()
deactivate UserRepository
UserService -> JWTService : generateToken(username)
activate JWTService
JWTService -> JWTService : createJWT()
deactivate JWTService
UserService -> EmailService : sendWelcomeEmail(email)
activate EmailService
EmailService -> EmailService : sendEmail()
deactivate EmailService
deactivate UserService
UserController -> User : return userDetails
deactivate UserController
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant JWTService

User -> UserController : login(credentials)
activate UserController
UserController -> UserService : validateUser(credentials)
activate UserService
UserService -> UserService : checkCredentials()
deactivate UserService
UserController -> JWTService : generateToken(username)
activate JWTService
JWTService -> JWTService : createJWT()
deactivate JWTService
UserController -> User : return token
deactivate UserController
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
activate JwtAuthFilter
JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService
JWTService -> JWTService : checkTokenValidity()
JWTService --> JwtAuthFilter : isValid
deactivate JWTService
deactivate JwtAuthFilter
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "User" as User {
  *id : Long
  *username : String
  *email : String
  *passwordHash : String
  --
  *roles : Set<Role>
}

entity "Role" as Role {
  *id : Long
  *name : String
  --
  *users : Set<User>
}

entity "Client" as Client {
  *id : Long
  *clientName : String
  *clientSecret : String
  *redirectUri : String
}

entity "Token" as Token {
  *id : Long
  *accessToken : String
  *refreshToken : String
  --
  *client : Client
  *user : User
}

User ||--o{ Role : has
Role ||--o{ User : belongs to
User ||--o{ Token : has
Client ||--o{ Token : issued
@enduml
----

*Entities*:
- **User**: Represents the users of the system. Each user has a unique ID, username, email, and password hash. Users are associated with roles and tokens.
- **Role**: Represents roles that can be assigned to users. Each role has a unique ID and name. Roles are associated with multiple users.
- **Client**: Represents client applications that can request tokens. Each client has a unique ID, name, secret, and redirect URI.
- **Token**: Represents access and refresh tokens issued to users. Each token is linked to a user and a client.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

*UserController* -> *UserService*:
- UserController calls UserService to handle user registration, login, and token refresh operations.

*UserService* -> *UserRepository*:
- UserService interacts with UserRepository to retrieve or store user data in the database.

*UserService* -> *JWTService*:
- UserService uses JWTService to generate tokens during the registration and login processes.

=== Data Flow Through Layers

1. **Controller Layer**: Receives HTTP requests and delegates business processing to services.
2. **Service Layer**: Handles business logic and transactions. It communicates with the repository layer for data access.
3. **Repository Layer**: Interacts with the database to perform CRUD operations.

=== Exception Propagation

Exceptions are typically thrown from the repository or service layers and are propagated up to the controller layer where they are handled and appropriate HTTP responses are generated.

=== Transaction Boundaries

Transactions are managed at the service layer, ensuring that database operations are completed successfully before committing the transaction. If an exception occurs, the transaction is rolled back.

This detailed design document provides a comprehensive overview of the Identity Provider application, focusing on its architecture, classes, interactions, and data flows. It serves as a guide for developers to understand and implement the system's functionalities effectively.