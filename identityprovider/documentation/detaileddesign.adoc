= Identity Provider Detailed Design Documentation

This document provides a comprehensive detailed design for the Identity Provider application, focusing on class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== 1.1 IdentityproviderApplication

*Purpose:* Serves as the entry point for the Spring Boot application.

*Methods:*
- `public static void main(String[] args)`: Boots up the Spring Boot application.

*Annotations:*
- `@SpringBootApplication`: Indicates that this class is the primary configuration class and triggers Spring Boot auto-configuration and component scanning.

=== 1.2 JwtAuthFilter

*Purpose:* Filter to manage JWT authentication within the application.

*Methods:*
- `protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)`: Intercepts requests to validate JWT tokens.

*Annotations:*
- `@Autowired`: Automatically injects the required dependencies.
- `@Component`: Marks the filter as a component that is automatically detected during classpath scanning.
- `@Override`: Indicates that a method declaration is intended to override a method declaration in a supertype.
- `@Slf4j`: Provides a logger instance for logging.

*Fields:*
- `userService : UserService`: Used to interact with user data and services.

=== 1.3 SecurityConfig

*Purpose:* Configuration class for security settings of the application.

*Methods:*
- `AuthenticationManager authenticationManager(AuthenticationConfiguration authConfig)`: Configures the authentication manager.
- `AuthenticationProvider authenticationProvider()`: Provides a custom authentication provider.
- `SecurityFilterChain securityFilterChain(HttpSecurity http)`: Defines security rules and paths.

*Annotations:*
- `@Autowired`: Injects other required beans.
- `@Bean`: Indicates that a method produces a bean to be managed by the Spring container.
- `@Configuration`: Indicates that the class has @Bean definition methods.
- `@EnableWebSecurity`: Enables Spring Security's web security support.

*Fields:*
- `jwtAuthFilter : JwtAuthFilter`
- `userDetailsService : UserDetailsService`

=== 1.4 UserController

*Purpose:* Controller to handle user-related operations such as registration, login, and token refresh.

*Methods:*
- `login(Users user)`: Authenticates a user and returns a JWT.
- `refreshToken(Users user)`: Refreshes an existing JWT.
- `registerUser(Users user)`: Registers a new user in the system.

*Annotations:*
- `@Autowired`: Injects dependencies automatically.
- `@PostMapping`: Marks methods as endpoints for POST requests.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the web request.
- `@RequestMapping`: Maps web requests onto methods in request-handling classes.
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.

*Fields:*
- `authManager : AuthenticationManager`
- `jwtService : JWTService`
- `userService : UserService`

=== 1.5 AuthRequest

*Purpose:* DTO to encapsulate authentication request data.

*Annotations:*
- `@Data`: A convenient shortcut annotation that bundles the features of `@ToString`, `@EqualsAndHashCode`, `@Getter`/`@Setter` and `@RequiredArgsConstructor` together.

*Fields:*
- `password : String`
- `username : String`

=== 1.6 AuthResponse

*Purpose:* DTO to encapsulate the response data after authentication.

=== 1.7 UserPrincipal

*Purpose:* Principal object representing a user in the security context.

*Methods:*
- Implements methods from `UserDetails` interface to provide user information to Spring Security.

*Annotations:*
- `@Override`: Indicates overriding a method.

*Fields:*
- `user : final Users`

=== 1.8 Client

*Purpose:* Entity representing an OAuth client.

*Annotations:*
- `@Entity`: Marks the class as a JPA entity.
- `@Table`: Specifies the table in the database with which this entity is mapped.
- `@Id`: Marks a field as the primary key.
- `@GeneratedValue`: Configures the way of increment of the specified column(field).
- `@Column`: Specifies the mapped column for a persistent property or field.
- `@Getter`, `@Setter`: Lombok annotations to generate getters and setters automatically.

*Fields:*
- `clientName : String`
- `clientSecret : String`
- `id : Long`
- `redirectUri : String`

=== 1.9 Role

*Purpose:* Entity representing a security role.

*Methods:*
- Standard getters and setters.

*Annotations:*
- `@Entity`, `@Table`, `@Id`, `@GeneratedValue`, `@Column`, `@ManyToMany`: JPA and Hibernate annotations to define relationships and entity characteristics.

*Fields:*
- `id : Long`
- `name : String`
- `users : Set<User>`

=== 1.10 Token

*Purpose:* Entity representing an authentication token.

*Annotations:*
- `@Entity`, `@Table`, `@Id`, `@GeneratedValue`, `@Column`, `@ManyToOne`, `@JoinColumn`, `@Getter`, `@Setter`: Annotations to define ORM mapping and automatic getters/setters.

*Fields:*
- `accessToken : String`
- `client : Client`
- `id : Long`
- `refreshToken : String`
- `user : User`

=== 1.11 User

*Purpose:* Entity representing a user.

*Annotations:*
- `@Entity`, `@Table`, `@Id`, `@GeneratedValue`, `@Column`, `@ManyToMany`, `@JoinTable`, `@JoinColumn`, `@Data`, `@Getter`, `@Setter`: Annotations for ORM and data handling.

*Fields:*
- `email : String`
- `id : Long`
- `passwordHash : String`
- `roles : Set<Role>`
- `username : String`

=== 1.12 UserRepository

*Purpose:* Repository interface for CRUD operations on the User entity.

*Annotations:*
- `@Repository`: Marks the interface as a Spring Data repository.

=== 1.13 AuditService

*Purpose:* Service for logging audit events.

*Methods:*
- `logEvent(String event)`: Logs an audit event.

*Annotations:*
- `@Service`: Marks the class as a business service facade.

=== 1.14 EmailService

*Purpose:* Service for sending emails.

*Methods:*
- `sendWelcomeEmail(String to)`: Sends a welcome email to a new user.

*Annotations:*
- `@Service`: Marks the class as a business service facade.

*Fields:*
- `notificationService : final NotificationService`

=== 1.15 JWTService

*Purpose:* Service to handle JWT operations.

*Methods:*
- `extractUsername(String token)`: Extracts username from the token.
- `generateToken(String username)`: Generates a new JWT for a given username.
- `validateToken(String token)`: Validates a JWT.
- `invalidateToken(String token)`: Marks a JWT as invalid.

*Annotations:*
- `@Service`, `@Slf4j`: Marks the class as a service and provides logging capability.

*Fields:*
- `auditService : final AuditService`
- `secretKey : final Key`
- `tokenBlacklistService : final TokenBlacklistService`

=== 1.16 NotificationService

*Purpose:* Service for user notifications.

*Methods:*
- `notifyUser(String user, String message)`: Notifies a user with a message.

*Annotations:*
- `@Service`: Indicates that the class is a service component.

=== 1.17 TokenBlacklistService

*Purpose:* Service to handle blacklisting of tokens.

*Methods:*
- `blacklistToken(String token)`: Blacklists a given token.

*Annotations:*
- `@Service`: Indicates that the class is a service component.

=== 1.18 UserService

*Purpose:* Service to handle user-related operations.

*Methods:*
- `loadUserByUsername(String username)`: Loads user details by username.
- `register(Users user)`: Registers a new user.

*Annotations:*
- `@Autowired`, `@Override`, `@Service`: Annotations for dependency injection, method overriding, and marking the class as a service.

*Fields:*
- `auditService : AuditService`
- `emailService : EmailService`
- `encoder : BCryptPasswordEncoder`
- `userRepository : UserRepository`

=== 1.19 IdentityproviderApplicationTests

*Purpose:* Class for application tests.

*Annotations:*
- `@SpringBootTest`: Provides Spring Boot test features.
- `@Test`: Marks methods as test methods.

== 2. Runtime View Diagrams

=== 2.1 User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant UserRepository
participant EmailService

User -> UserController : register(user)
activate UserController

UserController -> UserService : register(user)
activate UserService

UserService -> UserRepository : save(user)
activate UserRepository
UserRepository --> UserService : user
deactivate UserRepository

UserService -> EmailService : sendWelcomeEmail(user.email)
activate EmailService
EmailService --> UserService
deactivate EmailService

UserService --> UserController : user
deactivate UserService

UserController --> User : user
deactivate UserController
@enduml
----

=== 2.2 Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant JWTService

User -> UserController : login(authRequest)
activate UserController

UserController -> UserService : loadUserByUsername(authRequest.username)
activate UserService
UserService --> UserController : userDetails
deactivate UserService

UserController -> JWTService : generateToken(userDetails.username)
activate JWTService
JWTService --> UserController : token
deactivate JWTService

UserController --> User : token
deactivate UserController
@enduml
----

=== 2.3 JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant JwtAuthFilter
participant JWTService

User -> JwtAuthFilter : request(resource)
activate JwtAuthFilter

JwtAuthFilter -> JWTService : validateToken(token)
activate JWTService
JWTService --> JwtAuthFilter : isValid
deactivate JWTService

alt isValid
    JwtAuthFilter --> User : proceed
else
    JwtAuthFilter --> User : unauthorized
end
deactivate JwtAuthFilter
@enduml
----

=== 2.4 Business Process Flows

*Note:* Detailed business process flows would be similar to the above, focusing on specific business rules and interactions.

=== 2.5 Exception Handling Flows

[plantuml, exception-handling-sequence, png]
----
@startuml
actor User
participant UserController
participant UserService
participant "ExceptionHandler"

User -> UserController : request(invalidData)
activate UserController

UserController -> UserService : process(invalidData)
activate UserService
UserService --> UserController : throw new InvalidDataException()
deactivate UserService

UserController --> "ExceptionHandler" : handle(InvalidDataException)
activate "ExceptionHandler"
"ExceptionHandler" --> User : errorResponse
deactivate "ExceptionHandler"

deactivate UserController
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "User" {
  * id : Long
  --
  * username : String
  * email : String
  * passwordHash : String
  --
  * roles : Set<Role>
}

entity "Role" {
  * id : Long
  --
  * name : String
  --
  * users : Set<User>
}

entity "Client" {
  * id : Long
  --
  * clientName : String
  * clientSecret : String
  * redirectUri : String
}

entity "Token" {
  * id : Long
  --
  * accessToken : String
  * refreshToken : String
  --
  * user : User
  * client : Client
}

User ||--o{ Role : has
Role ||--o{ User : belongs to
User ||--o{ Token : has
Client ||--o{ Token : issued
@enduml
----

*User:* Represents a user in the system with fields for identification, credentials, and roles.

*Role:* Represents security roles associated with users.

*Client:* Represents an OAuth client with fields for client identification and authorization details.

*Token:* Represents authentication tokens linked to users and clients, containing access and refresh tokens.

== 4. Detailed Component Interactions

=== 4.1 Controller-Service-Repository Interactions

*UserController* interacts with *UserService* to handle user-related operations. *UserService* uses *UserRepository* for data persistence. *EmailService* is used for sending notifications post-registration.

=== 4.2 Data Flow Through Layers

Data flows from controllers to services where business logic is applied. Services interact with repositories for data persistence. Data then flows back to the controller and finally to the client.

=== 4.3 Exception Propagation

Exceptions are thrown from the service layer and are caught in controllers where they are handled by exception handlers to return appropriate responses.

=== 4.4 Transaction Boundaries

Transactions are managed at the service layer, ensuring that data operations are completed successfully before committing the transaction. If an exception occurs, the transaction is rolled back.

This detailed design document provides a comprehensive overview of the Identity Provider application, ensuring developers have a clear understanding of the components, interactions, and processes within the application.