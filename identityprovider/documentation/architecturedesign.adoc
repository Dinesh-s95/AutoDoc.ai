= Identity Provider Service Architecture Design

This document provides a comprehensive architecture design overview of the Identity Provider Service developed using Java Spring Boot. The design focuses on the service architecture, component descriptions, infrastructure, and system context.

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, diagram-architecture, png]
----
@startuml
package "Identity Provider Application" {
  [IdentityproviderApplication] as app
  [UserController] as controller
  [UserService] as userService
  [JWTService] as jwtService
  [AuditService] as auditService
  [EmailService] as emailService
  [TokenBlacklistService] as tokenBlacklist
  [SecurityConfig] as securityConfig
  [JwtAuthFilter] as jwtFilter
  [UserRepository] as userRepo
}

database "Identity DB" {
  [User]
  [Role]
  [Client]
  [Token]
}

cloud "External Systems" {
  [SMTP Server]
  [Notification Service]
}

app --> controller
controller --> userService
userService --> jwtService
userService --> emailService
userService --> auditService
userService --> userRepo
jwtService --> tokenBlacklist
jwtService --> auditService
emailService --> [SMTP Server]
emailService --> [Notification Service]
jwtFilter --> userService
securityConfig --> jwtFilter

userRepo --> [Identity DB]
[User] ..> [Role] : many-to-many
[User] ..> [Token] : many-to-one
[Token] ..> [Client] : many-to-one

@enduml
----

=== External System Connections and Integrations

- **SMTP Server**: Used by the `EmailService` for sending emails.
- **Notification Service**: Utilized by the `EmailService` to send notifications to users.

=== Component Interaction Overview

- The `UserController` handles all user-related operations and interacts with `UserService` for business logic.
- `UserService` performs user management and interacts with `JWTService` for token management and `EmailService` for sending emails.
- `JWTService` is responsible for JWT token operations and interacts with `TokenBlacklistService` for token invalidation.
- `SecurityConfig` configures security aspects and integrates `JwtAuthFilter` for request filtering based on JWT tokens.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring based Applications.
- **Spring Security**: For authentication and authorization.
- **Spring Data JPA**: For database operations.
- **JWT**: For secure transmission of information between parties as a JSON object.
- **Hibernate**: ORM tool for data manipulation.
- **MySQL**: Database for storing user and authentication data.

== 2. Component Description

=== IdentityproviderApplication

- **Responsibility**: Serves as the entry point of the Spring Boot application.
- **Role**: Initializes the Spring context and launches the application.

=== UserController

- **Responsibility**: Handles HTTP requests related to user operations.
- **Role**: Provides endpoints for user registration, login, and token refresh.
- **Interactions**: Uses `UserService` for user operations and `JWTService` for token handling.

=== UserService

- **Responsibility**: Manages user-related business logic.
- **Role**: Supports user registration and loading user details.
- **Interactions**: Communicates with `UserRepository` for database operations, `AuditService` for logging, and `EmailService` for sending emails.

=== JWTService

- **Responsibility**: Manages JWT token operations.
- **Role**: Generates, validates, extracts, and invalidates JWT tokens.
- **Interactions**: Uses `AuditService` for logging events and `TokenBlacklistService` for blacklisting tokens.

=== SecurityConfig and JwtAuthFilter

- **Responsibility**: Configures security settings and filters HTTP requests.
- **Role**: `SecurityConfig` sets up authentication and authorization configurations. `JwtAuthFilter` filters requests to check for valid JWT tokens.

== 3. Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker, allowing it to be deployed on any Docker-compatible environment, including Kubernetes clusters for better scalability and management.

=== Database Architecture

The application uses MySQL as its database. It stores user information, roles, tokens, and client details. The database schema is managed through Hibernate ORM with Spring Data JPA.

=== Security Architecture

Security is managed using Spring Security, which provides comprehensive authentication and authorization capabilities. Passwords are stored in hashed formats using BCrypt.

=== Network Architecture

The application is deployed within a private network with controlled access. Communication between services and the database is secured using network policies that restrict traffic flow.

== 4. System Context

=== External Systems and Their Interfaces

- **SMTP Server**: Interface for email transmission.
- **Notification Service**: RESTful API for sending notifications.

=== Data Flow Between Systems

1. User data flows from `UserController` to `UserService` and then to `UserRepository` and the MySQL database.
2. Email data flows from `EmailService` to the SMTP server and Notification Service.

=== Authentication and Authorization Flows at System Level

1. User sends login credentials to `UserController`.
2. `UserController` passes credentials to `UserService`, which uses `JWTService` to create tokens.
3. Tokens are sent back to the user, which must be included in subsequent requests.
4. `JwtAuthFilter` validates tokens with each request.

This document outlines the architecture of the Identity Provider Service, detailing the system's components, interactions, and external integrations, providing a clear overview for architects and developers.