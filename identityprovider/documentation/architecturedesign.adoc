= Identity Provider Service Architecture Design

This document provides a comprehensive architecture design for the Identity Provider Service, detailing the service architecture, component descriptions, infrastructure architecture, and system context.

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, diagram-architecture, png]
----
@startuml
package "Identity Provider Application" {
  [IdentityproviderApplication] as App
  [UserController] as Controller
  [UserService] as UserService
  [JWTService] as JWTService
  [SecurityConfig] as SecurityConfig
  [JwtAuthFilter] as JwtAuthFilter
  [UserRepository] as UserRepository
  [AuditService] as AuditService
  [EmailService] as EmailService
  [NotificationService] as NotificationService
  [TokenBlacklistService] as TokenBlacklistService
}

database "Database" {
  [Client]
  [Role]
  [Token]
  [User]
}

App --> Controller
Controller --> UserService
UserService --> UserRepository
UserService --> JWTService
UserService --> AuditService
UserService --> EmailService
JWTService --> AuditService
JWTService --> TokenBlacklistService
JwtAuthFilter --> UserService
SecurityConfig --> JwtAuthFilter
EmailService --> NotificationService
@enduml
----

=== External System Connections and Integrations

- **Email System**: The Identity Provider integrates with an external email system to send notifications and welcome emails through the `EmailService`.
- **Notification System**: Utilizes an external notification service managed by `NotificationService` to send various user notifications.

=== Component Interaction Overview

- **UserController**: Handles HTTP requests for user authentication and registration.
- **UserService**: Manages user data and interactions with the `UserRepository`.
- **JWTService**: Responsible for JWT token management, including creation, extraction, and validation.
- **SecurityConfig and JwtAuthFilter**: Configure and manage security aspects of the application, particularly JWT filtering for protected routes.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring based applications.
- **Spring Security**: Provides authentication and authorization support.
- **Spring Data JPA**: Facilitates database operations on Java Persistence API (JPA) entities.
- **MySQL**: Database for storing user and authentication data.
- **JWT (JSON Web Token)**: Used for securely transmitting information between parties as a JSON object.

== 2. Component Description

=== IdentityproviderApplication

- **Responsibility**: Serves as the entry point for the Spring Boot application.
- **Role**: Initializes the Spring context and launches the application.

=== UserController

- **Responsibility**: Handle all user-related HTTP requests.
- **Role**: Processes login and registration requests and interacts with `UserService` for user authentication and registration.
- **Interactions**: Uses `AuthenticationManager` to authenticate users and `JWTService` for token operations.

=== UserService

- **Responsibility**: Manages business logic related to user operations.
- **Role**: Interacts with `UserRepository` to retrieve and store user data.
- **Interactions**: Utilizes `AuditService` and `EmailService` for auditing actions and sending emails respectively.

=== JWTService

- **Responsibility**: Manages JWT token operations.
- **Role**: Generates, validates, extracts, and invalidates JWT tokens.
- **Interactions**: Interacts with `AuditService` for logging and `TokenBlacklistService` for managing blacklisted tokens.

=== SecurityConfig

- **Responsibility**: Configures security settings for the application.
- **Role**: Sets up authentication manager, authentication provider, and security filters.
- **Interactions**: Integrates `JwtAuthFilter` to apply security filters on HTTP requests.

== 3. Infrastructure Architecture

=== Deployment Architecture

- **Deployment Model**: The application is containerized using Docker, allowing for easy deployment to any environment supporting Docker (e.g., Kubernetes cluster).

=== Database Architecture

- **Database System**: MySQL.
- **Entities**: `User`, `Role`, `Token`, `Client`.
- **Relationships**: Users have roles, tokens are linked to users and clients.

=== Security Architecture

- **Authentication**: Managed via Spring Security with JWT for stateless session management.
- **Authorization**: Role-based access control (RBAC) using user roles.

=== Network Architecture

- **Load Balancer**: Distributes incoming application traffic across multiple instances to ensure reliability and high availability.
- **Firewall**: Protects against unauthorized access.

== 4. System Context

=== External Systems and Their Interfaces

- **Email Provider**: Interface for sending emails through SMTP.
- **Notification Service**: RESTful API for sending real-time notifications to users.

=== Data Flow Between Systems

- User data flows from the `UserController` to `UserService`, then to `UserRepository` and finally to the MySQL database.
- Authentication data flows from `UserController` to `JWTService` for token generation and validation.

=== Authentication and Authorization Flows at System Level

- **Authentication Flow**: Users submit credentials via `UserController`, which are authenticated in `UserService` using `AuthenticationManager`.
- **Authorization Flow**: JWT tokens are used to verify if a user has the necessary permissions to access certain resources, managed by `JwtAuthFilter`.

This architecture documentation provides a clear and comprehensive overview of the Identity Provider Service, ensuring that architects and senior developers can effectively understand and work with the system.