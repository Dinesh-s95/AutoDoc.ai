= Identity Provider System Architecture Design

This document provides a comprehensive architecture design for the Identity Provider system, a Java Spring Boot application designed to handle user authentication and authorization through JWT tokens. The system is structured to support secure login and registration processes, token management, and user role management.

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, "system-architecture", png]
----
@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

LAYOUT_WITH_LEGEND()

Person(user, "User", "Uses the system for authentication and authorization")
System_Boundary(c1, "Identity Provider System") {
    Container(springApp, "Spring Application", "Spring Boot", "Handles all authentication, authorization, and user management")
    ContainerDb(db, "Database", "Relational Database", "Stores user and authentication information")
    Container(services, "Services", "Spring Services", "Includes UserService, JWTService, EmailService, etc.")
}

System_Ext(emailSys, "Email System", "SMTP Server", "Handles sending emails to users")
System_Ext(authSys, "External Auth System", "OAuth/OpenID Connect", "Provides external authentication capabilities")

Rel(user, springApp, "Uses", "HTTPS")
Rel(springApp, db, "Reads/Writes")
Rel(springApp, services, "Uses")
Rel(services, emailSys, "Sends emails")
Rel(springApp, authSys, "Delegates authentication")
@enduml
----

=== External System Connections and Integrations

The Identity Provider system integrates with the following external systems:

- **Email System (SMTP Server):** Used by the `EmailService` to send welcome emails and notifications to users.
- **External Authentication System (OAuth/OpenID Connect):** Provides additional authentication mechanisms and can be used to delegate authentication processes.

=== Component Interaction Overview

[plantuml, "component-interaction", png]
----
@startuml
!includeurl https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml

LAYOUT_WITH_LEGEND()

Container(springApp, "Spring Application", "Spring Boot") {
    Component(userController, "UserController", "REST Controller", "Handles user login and registration requests")
    Component(jwtService, "JWTService", "Service", "Manages JWT creation, validation, and invalidation")
    Component(userService, "UserService", "Service", "Manages user information and interactions")
    Component(securityConfig, "SecurityConfig", "Configuration", "Configures security settings")
    Component(jwtAuthFilter, "JwtAuthFilter", "Filter", "Intercepts requests to manage JWT authentication")
}

ComponentDb(userDb, "User Database", "Stores user credentials and roles")

Rel(userController, jwtService, "Uses")
Rel(userController, userService, "Uses")
Rel(jwtService, userDb, "Reads/Writes")
Rel(userService, userDb, "Reads/Writes")
Rel(springApp, jwtAuthFilter, "Uses")
Rel(jwtAuthFilter, jwtService, "Validates tokens")
@enduml
----

=== Technology Stack and Frameworks Used

- **Programming Language:** Java
- **Framework:** Spring Boot
- **Security:** Spring Security, JWT
- **Database:** Relational Database (e.g., MySQL, PostgreSQL)
- **Other Libraries:** Lombok, JPA (Hibernate)

== 2. Component Description

=== IdentityproviderApplication

- **Responsibility:** Serves as the entry point for the Spring Boot application.
- **Role:** Initializes the Spring context and starts the application.
- **Interactions:** Triggers the loading of all other components.

=== JwtAuthFilter

- **Responsibility:** Filters incoming HTTP requests to validate JWT tokens.
- **Role:** Ensures that each request is authenticated before proceeding to other components.
- **Interactions:** Uses `JWTService` to validate tokens.

=== SecurityConfig

- **Responsibility:** Configures security-related aspects of the application.
- **Role:** Sets up authentication manager, authentication provider, and security filters.
- **Interactions:** Integrates `JwtAuthFilter` into the security chain.

=== UserController

- **Responsibility:** Handles HTTP requests for user authentication and registration.
- **Role:** Processes login and registration requests and interacts with `UserService` and `JWTService`.
- **Interactions:** Directly interacts with `AuthenticationManager` and `JWTService` to authenticate users and issue tokens.

=== UserService

- **Responsibility:** Manages user data and business logic for user operations.
- **Role:** Provides services for user registration, data retrieval, and user updates.
- **Interactions:** Communicates with the `UserRepository` to access and modify user data.

== 3. Infrastructure Architecture

=== Deployment Architecture

The Identity Provider system is containerized using Docker, allowing it to be deployed on any system that supports Docker. Kubernetes is used for orchestration, providing scalability, load balancing, and self-healing capabilities.

=== Database Architecture

The system uses a relational database to store user credentials, roles, and tokens. The database schema includes tables for users, roles, tokens, and their relationships.

=== Security Architecture

Security is enforced through Spring Security, configuring HTTPS, CSRF protection, and CORS policies. JWT tokens are used for stateless authentication. Passwords are stored in hashed form using BCrypt.

=== Network Architecture

The application is deployed within a private subnet with a load balancer distributing incoming traffic. Access to the database is restricted to the application instances.

== 4. System Context

=== External Systems and Their Interfaces

- **Email System:** Interface via SMTP for sending emails.
- **External Auth System:** OAuth2/OpenID Connect endpoints for delegating authentication.

=== Data Flow Between Systems

User data flows from the client to the `UserController`, which interacts with `UserService` and `JWTService` for authentication and token management. Validated requests may trigger interactions with external systems like the Email System.

=== Authentication and Authorization Flows at System Level

Authentication is initiated at the `UserController`, which uses `AuthenticationManager` to validate user credentials. Upon successful authentication, `JWTService` generates a token that is returned to the user for subsequent requests. Authorization is managed via roles stored in the database and verified for each protected resource access.

This architecture document provides a detailed overview of the Identity Provider system, ensuring clarity in design and implementation for development and maintenance teams.