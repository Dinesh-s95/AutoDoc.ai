= Identity Provider Service Architecture Documentation

== 1. Service Architecture Overview

The Identity Provider (IdP) service is designed as a microservice using Spring Boot, focusing on user authentication and authorization. The system allows for user registration, login, and token management.

=== High-level System Architecture Diagram

[plantuml, diagram-arch, png]
....
@startuml
!define SPRING #SpringGreen
!define ENTITY #FFDAC1
!define SERVICE #B0E0E6
!define CONTROLLER #ADD8E6

package "Identity Provider Service" {
  [IdentityproviderApplication] << SPRING >>

  package "Controllers" {
    [UserController] << CONTROLLER >>
  }

  package "Services" {
    [UserService] << SERVICE >>
    [JWTService] << SERVICE >>
    [AuditService] << SERVICE >>
    [EmailService] << SERVICE >>
    [TokenBlacklistService] << SERVICE >>
    [NotificationService] << SERVICE >>
  }

  package "Security" {
    [JwtAuthFilter] << SPRING >>
    [SecurityConfig] << SPRING >>
  }

  package "Persistence" {
    [UserRepository] << SPRING >>
    [Client] << ENTITY >>
    [Role] << ENTITY >>
    [Token] << ENTITY >>
    [User] << ENTITY >>
  }

  [UserController] --> [UserService]
  [UserService] --> [UserRepository]
  [UserService] --> [AuditService]
  [UserService] --> [EmailService]
  [JWTService] --> [AuditService]
  [JWTService] --> [TokenBlacklistService]
  [EmailService] --> [NotificationService]
  [JwtAuthFilter] --> [UserService]
  [SecurityConfig] --> [JwtAuthFilter]
}

@enduml
....

=== External System Connections and Integrations

The Identity Provider service integrates with external systems such as email servers and potentially other microservices for notifications and auditing.

=== Component Interaction Overview

The system is structured around the core Spring Boot application (`IdentityproviderApplication`) which orchestrates various components:

- **Controllers** handle HTTP requests and delegate business logic to services.
- **Services** manage business logic, data validation, and persistence interactions.
- **Security Components** ensure secure communication and user authentication.
- **Persistence Layer** interacts with the database to store and retrieve user data.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring based applications.
- **Spring Security**: For authentication and authorization.
- **JWT (JSON Web Tokens)**: For secure transmission of information between parties.
- **Hibernate**: For ORM and database interaction.
- **MySQL**: As the relational database.
- **JUnit**: For unit testing.

== 2. Component Description

=== IdentityproviderApplication

The entry point of the Spring Boot application, responsible for bootstrapping and launching the application.

=== UserController

Handles all user-related HTTP requests such as login, registration, and token refresh. It interacts with `UserService` for executing business logic.

=== UserService

Manages all user operations including loading user details, registration, and interaction with `UserRepository` for database operations. It uses `AuditService` to log events and `EmailService` for sending notifications.

=== JWTService

Responsible for handling all operations related to JWT including token generation, extraction, validation, and invalidation. It interacts with `AuditService` for logging and `TokenBlacklistService` for managing blacklisted tokens.

=== SecurityConfig

Configures security aspects of the application, such as authentication manager, security filters, and password encoding.

=== UserRepository, Client, Role, Token, User

These components manage the persistence of user and authentication data. `UserRepository` is a Spring Data repository that abstracts the database interactions.

== 3. Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker, allowing it to be deployed on any Docker-compatible environment, including Kubernetes clusters for better scalability and management.

=== Database Architecture

MySQL is used as the database, with entities such as `User`, `Role`, `Token`, and `Client` mapped via Hibernate ORM. The database schema is managed through Liquibase for version control and migrations.

=== Security Architecture

Spring Security is utilized to handle authentication and authorization. Passwords are stored in hashed formats using BCrypt. HTTPS is enforced for all communications.

=== Network Architecture

The service is designed to be deployed within a private subnet with controlled access via API Gateway, ensuring that only authenticated requests reach the service.

== 4. System Context

=== External Systems and Their Interfaces

The system interacts with:
- Email servers for sending notifications.
- Other microservices for distributed functionalities like notification services.

=== Data Flow Between Systems

1. User sends login request.
2. `UserController` captures request and interacts with `UserService`.
3. `UserService` validates credentials and requests `JWTService` to create tokens.
4. Tokens are sent back to the user.

=== Authentication and Authorization Flows at System Level

Authentication is managed via JWT tokens generated by `JWTService`. Authorization is enforced by Spring Security based on roles and permissions associated with the JWT.