= Identity Provider Service Architecture Design

This document provides a comprehensive architecture design for the Identity Provider Service, detailing the service architecture, component descriptions, infrastructure architecture, and system context.

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, diagram-architecture, png]
----
@startuml
package "Spring Boot Application" {
  [IdentityproviderApplication] as App
  [SecurityConfig] as SecConf
  [UserController] as UserCtrl
  [JwtAuthFilter] as JwtFilter
  [UserService] as UserSvc
  [JWTService] as JwtSvc
  [EmailService] as EmailSvc
  [AuditService] as AuditSvc
  [TokenBlacklistService] as TokenBlkSvc
  [NotificationService] as NotifSvc
  [UserRepository] as UserRepo

  App --> SecConf
  SecConf --> JwtFilter
  UserCtrl --> JwtSvc
  UserCtrl --> UserSvc
  JwtFilter --> UserSvc
  UserSvc --> UserRepo
  UserSvc --> AuditSvc
  UserSvc --> EmailSvc
  JwtSvc --> AuditSvc
  JwtSvc --> TokenBlkSvc
  EmailSvc --> NotifSvc
}

database "Database" {
  [User]
  [Role]
  [Token]
  [Client]
}

UserRepo ..> Database
@enduml
----

=== External System Connections and Integrations

The Identity Provider Service integrates with the following external systems:

- **Email System**: For sending notifications and welcome emails.
- **Notification Service**: For general user notifications.

=== Component Interaction Overview

The components interact primarily through service invocations facilitated by Spring's dependency injection. `UserController` handles HTTP requests and interacts with `UserService` for user-related operations. `UserService` uses `UserRepository` to interact with the database. Security is managed by `SecurityConfig`, which integrates `JwtAuthFilter` for JWT-based authentication.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring based applications.
- **Spring Security**: For authentication and authorization.
- **JWT**: For secure transmission of information between parties as a JSON object.
- **Hibernate**: For ORM-based database operations.
- **MySQL**: As the relational database.
- **Maven**: For project management and build.
- **JUnit**: For unit testing.

== 2. Component Description

=== IdentityproviderApplication

- **Responsibility**: Bootstraps the Spring Boot application.
- **Role**: Entry point of the application.
- **Interaction**: Initializes Spring context and configurations.

=== JwtAuthFilter

- **Responsibility**: To intercept requests and perform JWT validation.
- **Role**: Security filter to enforce authentication.
- **Interaction**: Uses `UserService` to load user details during authentication.

=== SecurityConfig

- **Responsibility**: Configuration for security aspects of the application.
- **Role**: Defines beans for authentication and authorization processes.
- **Interaction**: Configures `JwtAuthFilter` and `UserDetailsService`.

=== UserController

- **Responsibility**: Handle all user-related HTTP requests.
- **Role**: Controller to manage registration, login, and token refresh.
- **Interaction**: Interacts with `AuthenticationManager`, `JWTService`, and `UserService`.

=== UserService

- **Responsibility**: Business logic for user management.
- **Role**: Service layer to handle user data operations.
- **Interaction**: Uses `UserRepository` for database operations and `AuditService`, `EmailService` for auxiliary functions.

=== JWTService

- **Responsibility**: Handling of JWT creation, extraction, and validation.
- **Role**: Service to manage JWT tokens.
- **Interaction**: Interacts with `AuditService` and `TokenBlacklistService` for logging and token invalidation.

== 3. Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker, allowing it to be deployed on any Docker-compatible environment, including Kubernetes for orchestration.

=== Database Architecture

The application uses MySQL as a relational database with tables for `Users`, `Roles`, `Tokens`, and `Clients`. Hibernate ORM is used for database interaction.

=== Security Architecture

Security is managed using Spring Security with JWT for stateless authentication. HTTPS is used for secure communication.

=== Network Architecture

The application is deployed within a private subnet with controlled access via load balancers. Only HTTPS traffic is permitted to the services.

== 4. System Context

=== External Systems and Their Interfaces

- **Email System**: Interface via SMTP for sending emails.
- **Notification Service**: REST API for sending notifications.

=== Data Flow Between Systems

1. User data flows from `UserController` to `UserService` and then to `UserRepository`.
2. Authentication data flows from `UserController` to `JWTService` for token generation and validation.

=== Authentication and Authorization Flows at System Level

Authentication is performed via JWT tokens. `JwtAuthFilter` intercepts HTTP requests to validate tokens. `SecurityConfig` configures all security-related aspects, including the authentication manager and security filters.

This architecture document provides a detailed overview of the Identity Provider Service, ensuring clarity for architects and senior developers regarding the system design and operations.