= Identity Provider Service Architecture Design

== Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, "system-overview", png]
....
@startuml

package "Identity Provider Application" {
  [IdentityproviderApplication] as IDPApp
  [UserController] as UserCtrl
  [JwtAuthFilter] as JwtFilter
  [SecurityConfig] as SecConfig
  [UserService] as UserSvc
  [JWTService] as JwtSvc
  [AuditService] as AuditSvc
  [EmailService] as EmailSvc
  [NotificationService] as NotifSvc
  [TokenBlacklistService] as TokenBlkSvc
  [UserRepository] as UserRepo
}

database "Identity DB" {
  [Client]
  [Role]
  [Token]
  [User]
}

cloud "External Systems" {
  [SMTP Server]
  [Authentication API]
}

IDPApp --> UserCtrl
UserCtrl --> JwtFilter
UserCtrl --> UserSvc
UserCtrl --> JwtSvc
JwtFilter --> SecConfig
SecConfig --> UserSvc
UserSvc --> UserRepo
UserSvc --> AuditSvc
UserSvc --> EmailSvc
JwtSvc --> TokenBlkSvc
JwtSvc --> AuditSvc
EmailSvc --> NotifSvc
NotifSvc --> [SMTP Server]
UserRepo --> [Identity DB]
AuditSvc --> [Authentication API]

@enduml
....

=== External System Connections and Integrations

The Identity Provider Application integrates with the following external systems:

- **SMTP Server**: Used by the `NotificationService` to send emails through `EmailService`.
- **Authentication API**: Utilized by `AuditService` for logging and audit purposes.

=== Component Interaction Overview

Components interact primarily through service invocations and data flow between controllers, services, repositories, and external systems. `UserController` manages the API endpoints and orchestrates user authentication and registration processes by interacting with `UserService`, `JWTService`, and directly with security components configured in `SecurityConfig`.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring based applications.
- **Spring Security**: For authentication and access-control features.
- **JWT (JSON Web Token)**: For secure transmission of information between parties as a JSON object.
- **Hibernate**: For ORM-based database operations.
- **MySQL**: As the database for storing user and authentication data.
- **Maven**: For project management and build.
- **JUnit**: For unit testing.

== Component Description

=== IdentityproviderApplication

The entry point of the Spring Boot application. It initializes the Spring context and sets up the application.

=== JwtAuthFilter

A filter that intercepts API requests to check for the presence of a valid JSON Web Token.

=== SecurityConfig

Configures web security, defining authentication managers, authentication providers, and security filters.

=== UserController

Handles all incoming HTTP requests related to user management such as login, registration, and token refresh.

=== UserService

Provides business services related to user management, including loading user details and registering new users.

=== JWTService

Responsible for all operations related to JWT, including token generation, extraction, validation, and invalidation.

=== AuditService, EmailService, NotificationService, TokenBlacklistService

These services handle specific aspects such as auditing actions, sending emails, notifying users, and managing token blacklisting.

=== UserRepository

Interfaces with the database to perform CRUD operations on user data.

== Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker, allowing it to be deployed on any Docker-compatible environment, including Kubernetes clusters for better scalability and management.

=== Database Architecture

MySQL is used as the relational database. Tables include `User`, `Role`, `Token`, and `Client`, with relationships managed via Hibernate.

=== Security Architecture

Utilizes Spring Security for authentication and authorization. Passwords are stored in hashed form using BCrypt. JWTs are used for stateless authentication.

=== Network Architecture

The application is deployed within a VPC with controlled access to the database and external interfaces. Only HTTPS traffic is permitted, ensuring data is encrypted in transit.

== System Context

=== External Systems and Their Interfaces

- **SMTP Server**: Interface via SMTP protocol for sending emails.
- **Authentication API**: RESTful API for audit logging.

=== Data Flow Between Systems

Data flows from `UserController` to `UserService` and `JWTService` for processing. `UserService` interacts with `UserRepository` for database operations. `EmailService` sends notifications through `NotificationService` which uses SMTP for email delivery.

=== Authentication and Authorization Flows at System Level

