= Identity Provider System Architecture Design

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, "system-architecture-diagram", png]
----
@startuml
package "Identity Provider Application" {
  [IdentityproviderApplication] as app
  [UserController] as userCtrl
  [SecurityConfig] as secConfig
  [JwtAuthFilter] as jwtFilter
}

package "Services" {
  [UserService] as userService
  [JWTService] as jwtService
  [AuditService] as auditService
  [EmailService] as emailService
  [TokenBlacklistService] as tokenBlacklist
  [NotificationService] as notificationService
}

package "Data Model" {
  [User] as userEntity
  [Role] as roleEntity
  [Client] as clientEntity
  [Token] as tokenEntity
}

package "Repository" {
  [UserRepository] as userRepo
}

database "Database" {
  [DB]
}

app --> userCtrl : initiates
userCtrl --> secConfig : uses
secConfig --> jwtFilter : configures
userCtrl --> userService : uses
userCtrl --> jwtService : uses
userService --> userRepo : interacts
userService --> auditService : uses
userService --> emailService : uses
jwtService --> tokenBlacklist : uses
emailService --> notificationService : uses
userRepo --> DB : stores/retrieves
@enduml
----

=== External System Connections and Integrations

- **Database**: Connects to a relational database for persisting user data, roles, tokens, and client information.
- **Email System**: Integrates with an external email service for sending notifications and welcome emails.
- **Notification Service**: Optionally integrates with external systems for user notifications.

=== Component Interaction Overview

- **UserController** handles HTTP requests and interacts with services like **UserService** and **JWTService** for authentication and user management.
- **SecurityConfig** sets up security configurations and integrates **JwtAuthFilter** for JWT token handling.
- **UserService** interacts with **UserRepository** for database operations and uses **AuditService** and **EmailService** for logging and email notifications.
- **JWTService** manages token creation, validation, and interacts with **TokenBlacklistService** for token invalidation.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring based applications.
- **Spring Security**: For authentication and access-control features.
- **JWT**: For JSON Web Token handling.
- **Hibernate**: For ORM-based database operations.
- **MySQL**: As the relational database.
- **Maven**: For project management and build.

== 2. Component Description

=== IdentityproviderApplication

- **Responsibility**: Bootstraps the Spring Boot application.
- **Role**: Entry point of the application.

=== UserController

- **Responsibility**: Handles all user-related HTTP requests.
- **Role**: Acts as a controller to manage registration, login, and token refresh endpoints.
- **Interactions**: Uses **UserService** for user operations and **JWTService** for token operations.

=== SecurityConfig

- **Responsibility**: Configures security settings for the application.
- **Role**: Defines beans for authentication and authorization mechanisms.
- **Interactions**: Integrates **JwtAuthFilter** for securing HTTP requests.

=== UserService

- **Responsibility**: Manages all operations related to users.
- **Role**: Service layer that interacts with the **UserRepository** and other services like **AuditService** and **EmailService**.
- **External Dependencies**: Uses **BCryptPasswordEncoder** for password encoding.

=== JWTService

- **Responsibility**: Manages all operations related to JWT including creation, extraction, validation, and invalidation.
- **Role**: Service layer that supports authentication processes.
- **External Dependencies**: Uses **Key** for signing tokens and interacts with **TokenBlacklistService**.

== 3. Infrastructure Architecture

=== Deployment Architecture

- **Deployment Model**: The application is containerized using Docker, facilitating easy deployment and scalability.
- **Load Balancer**: Used to distribute incoming traffic and increase redundancy.

=== Database Architecture

- **Database System**: MySQL.
- **Schema Design**: Includes tables for Users, Roles, Tokens, and Clients with appropriate relationships defined.

=== Security Architecture

- **Authentication**: Managed via Spring Security with JWT for stateless authentication.
- **Authorization**: Role-based access control linked to the User entity.

=== Network Architecture

- **Internal Networking**: Uses internal networking features of Kubernetes if deployed on a cluster, ensuring secure communication between pods.
- **External Access**: Exposed via HTTPS through a load balancer, ensuring encrypted data transmission.

== 4. System Context

=== External Systems and Their Interfaces

- **Email Provider**: Interface for sending emails through SMTP.
- **Notification System**: RESTful API for sending real-time notifications.

=== Data Flow Between Systems

- User data flows from **UserController** to **UserService** and then to **UserRepository** for persistence in the database.
- Authentication data flows from **UserController** to **JWTService** for token generation and validation.

=== Authentication and Authorization Flows at System Level

- **Authentication Flow**: Users submit credentials via **UserController**, which are validated by **UserService** using **UserRepository**. On success, **JWTService** generates a token.
- **Authorization Flow**: Requests with JWT tokens are intercepted by **JwtAuthFilter**, which validates the token and allows access based on configured roles in **SecurityConfig**.