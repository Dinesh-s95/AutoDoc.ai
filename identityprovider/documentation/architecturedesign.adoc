= Identity Provider Service Architecture Design

This document provides a comprehensive architectural overview of the Identity Provider (IDP) service built using Java Spring Boot. The architecture is designed to support secure user authentication and authorization functionalities.

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, "system-architecture", png]
....
@startuml
skinparam componentStyle uml2

package "Identity Provider Application" {
  [IdentityproviderApplication] as IDPApp
  [UserController] as UC
  [JwtAuthFilter] as JAF
  [SecurityConfig] as SC
  [UserService] as US
  [JWTService] as JWS
  [EmailService] as ES
  [AuditService] as AS
  [TokenBlacklistService] as TBS
  [NotificationService] as NS
  [UserRepository] as UR
}

database "Database" {
  [User]
  [Role]
  [Client]
  [Token]
}

IDPApp --> UC
IDPApp --> SC
SC --> JAF
UC --> US
UC --> JWS
US --> UR
US --> AS
US --> ES
JWS --> AS
JWS --> TBS
ES --> NS

@enduml
....

=== External System Connections and Integrations

The Identity Provider interacts with the following external systems:

- **Email System**: For sending out registration and notification emails.
- **Notification System**: For sending real-time user notifications.

=== Component Interaction Overview

Components interact primarily through Spring-managed beans. `UserController` handles all incoming HTTP requests and interacts with `UserService` for user-related operations. `UserService` accesses the database through `UserRepository` and uses `EmailService` and `AuditService` for emailing and logging, respectively.

=== Technology Stack and Frameworks Used

- **Programming Language**: Java
- **Framework**: Spring Boot
- **Security**: Spring Security, JWT
- **Database**: Relational Database (e.g., PostgreSQL)
- **Others**: Hibernate ORM, Spring Data JPA

== 2. Component Description

=== IdentityproviderApplication

- **Responsibility**: Bootstraps the Spring Boot application.
- **Role**: Entry point of the application.

=== JwtAuthFilter

- **Responsibility**: Filters incoming requests to check for valid JWT tokens.
- **Role**: Security filter to enable JWT-based authentication.

=== SecurityConfig

- **Responsibility**: Configuration for security aspects of the application.
- **Role**: Defines beans for authentication and authorization processes.

=== UserController

- **Responsibility**: Manages all user-related endpoints.
- **Role**: Handles registration, login, and token refresh requests.

=== UserService

- **Responsibility**: Business logic for user management.
- **Role**: Interacts with UserRepository and auxiliary services like EmailService.

=== JWTService

- **Responsibility**: Manages JWT token creation and validation.
- **Role**: Ensures that tokens are valid and not blacklisted.

=== EmailService

- **Responsibility**: Sends emails to users.
- **Role**: Uses NotificationService to send out emails.

== 3. Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker and deployed on a Kubernetes cluster to ensure scalability and manageability.

=== Database Architecture

The application uses a relational database with tables for `Users`, `Roles`, `Clients`, and `Tokens`. Hibernate ORM is used for database interaction.

=== Security Architecture

Security is managed using Spring Security, configuring HTTP security, and setting up an authentication manager. JWT tokens are used for stateless authentication.

=== Network Architecture

The application is deployed within a VPC with restricted access to the database and other internal resources. Only HTTP/S traffic is allowed through a load balancer.

== 4. System Context

=== External Systems and Their Interfaces

- **Email System**: Interface for SMTP to send emails.
- **Notification System**: REST API for sending notifications.

=== Data Flow Between Systems

User data flows from the UserController to UserService and then to UserRepository which interacts with the database. Email data flows from UserService to EmailService and then to the external Email System.

=== Authentication and Authorization Flows at System Level

Authentication is performed using JWT tokens. When a user logs in, UserController interacts with UserService to validate credentials and JWTService to generate a token. This token is then used for subsequent requests to authenticate the user.

