= Identity Provider System Architecture Design

== 1. Service Architecture Overview

=== High-level System Architecture Diagram

[plantuml, "system_architecture_diagram", png]
----
@startuml
!define SPRING #SpringGreen
!define ENTITY #MistyRose
!define SERVICE #LightSkyBlue
!define CONTROLLER #Orange

package "Identity Provider Application" {
  [IdentityproviderApplication] << SPRING >>

  package "Web Layer" {
    [UserController] << CONTROLLER >>
  }

  package "Service Layer" {
    [UserService] << SERVICE >>
    [JWTService] << SERVICE >>
    [AuditService] << SERVICE >>
    [EmailService] << SERVICE >>
    [NotificationService] << SERVICE >>
    [TokenBlacklistService] << SERVICE >>
  }

  package "Security" {
    [JwtAuthFilter] << SPRING >>
    [SecurityConfig] << SPRING >>
    [UserPrincipal] << SPRING >>
  }

  package "Data Layer" {
    [UserRepository] << SPRING >>
    [Client] << ENTITY >>
    [Role] << ENTITY >>
    [Token] << ENTITY >>
    [User] << ENTITY >>
  }

  [UserController] --> [UserService]
  [UserController] --> [JWTService]
  [JWTService] --> [AuditService]
  [JWTService] --> [TokenBlacklistService]
  [UserService] --> [EmailService]
  [UserService] --> [UserRepository]
  [EmailService] --> [NotificationService]
  [JwtAuthFilter] --> [UserService]
  [SecurityConfig] --> [JwtAuthFilter]
  [SecurityConfig] --> [UserDetailsService]
}

cloud "External Systems" {
  [SMTP Server]
  [Authentication Database]
}

[UserController] --> [SMTP Server] : Sends Emails
[UserRepository] --> [Authentication Database] : Stores User Data
@enduml
----

=== External System Connections and Integrations

* **SMTP Server**: Used by the `EmailService` to send welcome and notification emails.
* **Authentication Database**: Utilized by `UserRepository` to store and retrieve user data.

=== Component Interaction Overview

* **UserController** interacts directly with `UserService` for user management and `JWTService` for authentication tokens.
* **JWTService** relies on `AuditService` for logging and `TokenBlacklistService` for token management.
* **UserService** uses `EmailService` for sending emails, which in turn uses `NotificationService` for notifications.

=== Technology Stack and Frameworks Used

* **Spring Boot**: Framework for creating stand-alone, production-grade Spring based applications.
* **Spring Security**: For authentication and access-control.
* **JWT (JSON Web Token)**: For secure transmission of information between parties as a JSON object.
* **Hibernate**: For ORM (Object Relational Mapping) to map Java classes to database tables.
* **MySQL**: As the relational database.
* **Maven**: For project management and build.
* **JUnit**: For unit testing.

== 2. Component Description

=== IdentityproviderApplication

* **Responsibility**: Serves as the bootstrap class that runs the Spring Boot application.
* **Role**: Entry point of the Java application.
* **Interactions**: Initializes the Spring context and all the beans.

=== UserController

* **Responsibility**: Handles all user-related HTTP requests.
* **Role**: Acts as the controller in the MVC pattern.
* **Interactions**: Uses `UserService` for business operations and `JWTService` for token operations.

=== UserService

* **Responsibility**: Manages user data and business operations related to users.
* **Role**: Service layer component.
* **Interactions**: Communicates with `UserRepository` for data persistence and `EmailService` for sending emails.

=== JWTService

* **Responsibility**: Manages token creation, validation, and invalidation.
* **Role**: Service layer component.
* **Interactions**: Uses `AuditService` for logging and `TokenBlacklistService` for managing blacklisted tokens.

=== SecurityConfig

* **Responsibility**: Configures security settings, including URL access policies.
* **Role**: Configuration class that integrates Spring Security.
* **Interactions**: Sets up `JwtAuthFilter` and manages authentication.

== 3. Infrastructure Architecture

=== Deployment Architecture

* **Application Server**: Spring Boot application packaged as a JAR running on a Java runtime.
* **Load Balancer**: Distributes incoming application traffic across multiple instances.

=== Database Architecture

* **Database Server**: MySQL database that stores user and authentication data.
* **Entities**: `User`, `Role`, `Token`, `Client`.

=== Security Architecture

* **HTTPS**: All traffic is secured using HTTPS.
* **JWT**: Used for stateless authentication.
* **Spring Security**: Configures endpoint access based on roles.

=== Network Architecture

* **Internal Network**: Communication between application components.
* **External Network**: Exposed only via HTTPS through specific endpoints.

== 4. System Context

=== External Systems and Their Interfaces

* **SMTP Server**: Interface for sending emails using SMTP protocol.
* **Authentication Database**: Accessed via JDBC for user data storage.

=== Data Flow Between Systems

* **User Data**: From `UserController` to `UserService` and stored in `UserRepository`.
* **Authentication Data**: Managed by `JWTService` and stored in `Token` entities.

=== Authentication and Authorization Flows at System Level

* **Login**: User credentials are authenticated using `JWTService`, generating a JWT if valid.
* **Authorization**: JWTs are used to authorize user actions based on roles and permissions configured in `SecurityConfig`.

