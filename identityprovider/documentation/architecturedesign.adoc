= Identity Provider System Architecture Documentation

== 1. Service Architecture Overview

=== High-Level System Architecture Diagram

[plantuml, "system_architecture_diagram", png]
----
@startuml
!define SPRING #SpringGreen
!define ENTITY #MistyRose
!define SERVICE #LightSkyBlue
!define CONTROLLER #Violet

package "Spring Boot Application" {
  [IdentityproviderApplication] << SPRING >>
}

package "Web Layer" {
  [UserController] << CONTROLLER >>
}

package "Security" {
  [JwtAuthFilter] << SPRING >>
  [SecurityConfig] << SPRING >>
}

package "Service Layer" {
  [UserService] << SERVICE >>
  [JWTService] << SERVICE >>
  [AuditService] << SERVICE >>
  [EmailService] << SERVICE >>
  [NotificationService] << SERVICE >>
  [TokenBlacklistService] << SERVICE >>
}

package "Data Access Layer" {
  [UserRepository] << SPRING >>
}

package "Entity Layer" {
  [User] << ENTITY >>
  [Role] << ENTITY >>
  [Client] << ENTITY >>
  [Token] << ENTITY >>
}

IdentityproviderApplication --> UserController
IdentityproviderApplication --> JwtAuthFilter
IdentityproviderApplication --> SecurityConfig
IdentityproviderApplication --> UserService
IdentityproviderApplication --> JWTService
IdentityproviderApplication --> AuditService
IdentityproviderApplication --> EmailService
IdentityproviderApplication --> NotificationService
IdentityproviderApplication --> TokenBlacklistService
IdentityproviderApplication --> UserRepository

UserController --> UserService : uses
UserController --> JWTService : uses

JwtAuthFilter --> UserService : uses

UserService --> UserRepository : uses
UserService --> AuditService : uses
UserService --> EmailService : uses

JWTService --> AuditService : uses
JWTService --> TokenBlacklistService : uses

EmailService --> NotificationService : uses

@enduml
----

=== External System Connections and Integrations

The Identity Provider system integrates with the following external systems:

- **Email System**: For sending emails through `EmailService`.
- **Notification System**: For user notifications via `NotificationService`.

=== Component Interaction Overview

Components interact primarily through service invocations. `UserController` handles incoming HTTP requests, interacting with `UserService` for user-related operations and `JWTService` for authentication and token management. `JwtAuthFilter` is used for securing endpoints and uses `UserService` to load user details.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring based Applications.
- **Spring Security**: For authentication and access-control.
- **Spring Data JPA**: For database operations.
- **JWT**: For handling JSON Web Tokens.
- **Hibernate**: ORM tool for data manipulation.
- **MySQL**: Database for storing user data and tokens.

== 2. Component Description

=== IdentityproviderApplication

**Responsibility**: Bootstraps the Spring Boot application.

**Role**: Entry point of the application.

**Interactions**: Initializes all other components.

=== UserController

**Responsibility**: Handles all user-related HTTP requests.

**Role**: Controller in MVC pattern.

**Interactions**: Uses `UserService` for user registration and login, and `JWTService` for token operations.

=== UserService

**Responsibility**: Manages user data and business logic.

**Role**: Service layer component.

**Interactions**: Interacts with `UserRepository` for database operations and `AuditService` for logging.

=== JWTService

**Responsibility**: Manages JWT creation, validation, and invalidation.

**Role**: Service layer component.

**Interactions**: Uses `AuditService` for logging and `TokenBlacklistService` for managing blacklisted tokens.

=== SecurityConfig

**Responsibility**: Configuration for security settings.

**Role**: Configures authentication manager and security filters.

**Interactions**: Utilizes `JwtAuthFilter` for securing routes.

== 3. Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker, allowing it to be deployed on any Docker-compatible environment, including Kubernetes clusters for better scalability and management.

=== Database Architecture

Uses MySQL as the relational database. Tables include `User`, `Role`, `Client`, and `Token`, with appropriate relationships configured using Hibernate.

=== Security Architecture

Utilizes Spring Security for configuring HTTP security, authentication, and authorization. Passwords are stored in hashed form using BCrypt. JWTs are used for stateless authentication.

=== Network Architecture

The application is deployed within a private subnet with controlled access via load balancers. Communication between services and the database is encrypted using TLS.

== 4. System Context

=== External Systems and Their Interfaces

- **Email System**: Interface via SMTP for sending emails.
- **Notification System**: RESTful API for sending notifications.

=== Data Flow Between Systems

User data flows from the `UserController` to `UserService`, then to `UserRepository` and finally to the MySQL database. Authentication data flows through `JwtAuthFilter` and `JWTService`.

=== Authentication and Authorization Flows at System Level

Authentication is performed using username and password at login, managed by `UserController` and `UserService`. Upon successful authentication, `JWTService` generates a JWT which is used for subsequent requests to authenticate via `JwtAuthFilter`.

This document provides a comprehensive overview for architects and developers to understand and further develop the Identity Provider system.