= Identity Provider System Architecture Design

== Service Architecture Overview

The Identity Provider (IdP) system is designed to manage user authentication and authorization, leveraging JWT for secure token management. Below is the high-level system architecture diagram, illustrating the main components and their interactions.

[plantuml, diagram-arch, png]
----
@startuml
!define SPRING #SpringGreen
!define ENTITY #Magenta
!define SERVICE #Gold
!define CONTROLLER #DeepSkyBlue

package "Identity Provider Application" {
  [IdentityproviderApplication] << SPRING >>

  package "Web Layer" {
    [UserController] << CONTROLLER >>
  }

  package "Service Layer" {
    [UserService] << SERVICE >>
    [JWTService] << SERVICE >>
    [EmailService] << SERVICE >>
    [AuditService] << SERVICE >>
    [NotificationService] << SERVICE >>
    [TokenBlacklistService] << SERVICE >>
  }

  package "Security" {
    [JwtAuthFilter] << SPRING >>
    [SecurityConfig] << SPRING >>
  }

  package "Persistence Layer" {
    [UserRepository] << SPRING >>
    [User] << ENTITY >>
    [Role] << ENTITY >>
    [Client] << ENTITY >>
    [Token] << ENTITY >>
  }

  [UserController] --> [UserService]
  [UserController] --> [JWTService]
  [UserService] --> [UserRepository]
  [UserService] --> [EmailService]
  [UserService] --> [AuditService]
  [JWTService] --> [TokenBlacklistService]
  [JWTService] --> [AuditService]
  [EmailService] --> [NotificationService]
  [JwtAuthFilter] --> [UserService]
  [SecurityConfig] --> [JwtAuthFilter]
}

@enduml
----

=== External System Connections and Integrations

The Identity Provider interacts with the following external systems:
- **Email System**: For sending registration and notification emails.
- **Notification System**: Integrated via `NotificationService` for user notifications.

=== Component Interaction Overview

- **UserController**: Handles HTTP requests for user authentication and management.
- **UserService**: Manages user data and interactions with the `UserRepository`.
- **JWTService**: Responsible for JWT token generation, validation, and management.
- **SecurityConfig**: Configures security aspects including JWT filters and authentication mechanisms.

=== Technology Stack and Frameworks Used

- **Spring Boot**: Framework for creating stand-alone, production-grade Spring based Applications.
- **Spring Security**: Provides authentication and authorization support.
- **JWT**: JSON Web Tokens for secure transmission of information.
- **Hibernate**: ORM framework for data manipulation.
- **MySQL**: Database for storing user and authentication data.

== Component Description

=== IdentityproviderApplication

Main class that boots up the application using Spring Boot.

=== JwtAuthFilter

A filter that intercepts requests to validate JWT tokens.

=== SecurityConfig

Configuration class that sets up authentication and authorization mechanisms, including JWT filters.

=== UserController

REST controller that handles all user-related operations such as login, registration, and token refresh.

=== UserService

Service layer component managing business logic around user data.

=== JWTService

Service handling all operations related to JWT, including creation, extraction, and validation.

=== UserRepository

Spring Data repository for accessing user data stored in the database.

=== User, Role, Client, Token

Entity classes representing the data model.

== Infrastructure Architecture

=== Deployment Architecture

The application is containerized using Docker, facilitating easy deployment and scaling. Kubernetes is used for orchestration.

=== Database Architecture

MySQL database with tables for `Users`, `Roles`, `Clients`, and `Tokens`. Hibernate is used for ORM.

=== Security Architecture

Spring Security for authentication and authorization. Passwords are stored in hashed form using BCrypt.

=== Network Architecture

The application is deployed within a VPC with restricted access. Only HTTP and HTTPS traffic is allowed through a load balancer.

== System Context

=== External Systems and Their Interfaces

- **Email System**: Accessed via SMTP protocol.
- **Notification System**: REST API for sending notifications.

=== Data Flow Between Systems

1. User registration triggers an email via the Email System.
2. Notifications are sent through the Notification System as part of the email service.

=== Authentication and Authorization Flows at System Level

1. User sends login credentials.
2. System validates credentials and issues a JWT.
3. JWT is used for subsequent requests to authenticate and authorize the user.

This document provides a comprehensive overview of the Identity Provider system architecture, designed for secure and efficient user management and authentication.