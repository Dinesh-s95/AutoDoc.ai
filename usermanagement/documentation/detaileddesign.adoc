= User Management System Detailed Design Documentation

This document provides a detailed design analysis of the User Management System, which is implemented using Java Spring Boot. The system is designed to handle user registration, authentication, and vehicle assignment processes.

== 1. Class-by-Class Analysis

=== 1.1 UsermanagementApplication

*Purpose:* This is the main class that bootstraps the Spring Boot application.

*Annotations:*
- `@EnableFeignClients`: Enables the discovery of interfaces that declare they are Feign clients.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods:*
- `public static void main(String[] args)`: The entry point of the Spring Boot application.

=== 1.2 IdentityProviderClient

*Purpose:* Feign client for interacting with an external identity provider service.

*Annotations:*
- `@FeignClient`: Declares that this interface is a Feign client.
- `@PostMapping`: Used to map HTTP POST requests onto specific handler methods.
- `@RequestBody`: Indicates a method parameter should be bound to the body of the HTTP request.

=== 1.3 VehicleManagementClient

*Purpose:* Feign client for interacting with an external vehicle management service.

*Annotations:*
- `@FeignClient`: Declares that this interface is a Feign client.
- `@GetMapping`: Used to map HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== 1.4 UserManagementController

*Purpose:* Acts as the REST controller to handle HTTP requests related to user and vehicle management.

*Annotations:*
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.
- `@RequestMapping`: Provides routing information. It tells Spring that any HTTP request with the specified path should be mapped to the corresponding method.
- `@PostMapping`: Indicates that the following methods handle HTTP POST requests.
- `@RequestParam`: Binds the value of a query string parameter to a method parameter.

*Methods:*
- `public String assignVehicle(@RequestParam String username, @RequestParam String vin, @RequestParam String brand, @RequestParam String country)`: Assigns a vehicle to a user.
- `public String onboardUser(@RequestParam String username, @RequestParam String password)`: Handles the user registration process.

*Fields:*
- `service : UserManagementService`: Autowired service that contains business logic for user and vehicle management.

=== 1.5 MobilityUser

*Purpose:* Entity class representing a user in the mobility system.

*Annotations:*
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Table`: Specifies the table in the database with which this entity is mapped.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to create getters.
- `@Setter`: Lombok annotation to create setters.

*Fields:*
- `id : Long`: The primary key.
- `mobilityUserId : String`: A unique identifier for the user.
- `role : String`: The role of the user within the system.
- `username : String`: The username of the user.
- `vin : String`: The vehicle identification number assigned to the user.

=== 1.6 UserManagementRepository

*Purpose:* Repository interface for CRUD operations on the `MobilityUser` entity.

=== 1.7 UserManagementService

*Purpose:* Service layer that contains business logic for managing users and vehicles.

*Annotations:*
- `@Service`: Indicates that the class provides some business functionalities.

*Methods:*
- `public Optional<MobilityUser> getUserByUsername(String username)`: Retrieves a user by username.
- `public String onboardUser(String username, String password)`: Registers a new user.
- `public void assignVehicleToUser(String username, String vin, String brand, String country)`: Assigns a vehicle to a user.

*Fields:*
- `identityProvider : IdentityProviderClient`: Autowired Feign client for identity management.
- `repo : UserManagementRepository`: Autowired repository for database interactions.
- `vehicleClient : VehicleManagementClient`: Autowired Feign client for vehicle management.

=== 1.8 UsermanagementApplicationTests

*Purpose:* Contains integration tests for the application.

*Annotations:*
- `@SpringBootTest`: Indicates that the class should bootstrap the entire container for integration testing.
- `@Test`: Indicates that the method is a test method.

== 2. Runtime View Diagrams

=== 2.1 User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service
participant "IdentityProviderClient" as IdentityProvider
participant "UserManagementRepository" as Repository

User -> Controller : onboardUser(username, password)
Controller -> Service : onboardUser(username, password)
Service -> IdentityProvider : createIdentity(username, password)
IdentityProvider -> Service : identityResponse
Service -> Repository : save(newUser)
Repository -> Service : userSaved
Service -> Controller : userResponse
Controller -> User : userResponse
@enduml
----

=== 2.2 Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service
participant "IdentityProviderClient" as IdentityProvider

User -> Controller : authenticateUser(username, password)
Controller -> Service : authenticateUser(username, password)
Service -> IdentityProvider : validateCredentials(username, password)
IdentityProvider -> Service : validationResponse
Service -> Controller : token
Controller -> User : token
@enduml
----

=== 2.3 JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service

User -> Controller : request(resource)
Controller -> Service : validateToken(token)
Service -> Service : decodeToken(token)
Service -> Controller : isValid
Controller -> User : resource
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "MobilityUser" {
  *id : Long
  --
  *mobilityUserId : String
  *role : String
  *username : String
  *vin : String
}
@enduml
----

== 4. Detailed Component Interactions

=== 4.1 Controller-Service-Repository Interactions

*Controller -> Service:*
- The controller layer handles incoming HTTP requests, validates input, and passes the request to the service layer.

*Service -> Repository:*
- The service layer contains business logic and calls on the repository layer to access the database.

*Repository -> Database:*
- The repository layer interacts directly with the database through JPA to perform CRUD operations.

=== 4.2 Data Flow Through Layers

*Data flows from the controller to the service, then to the repository, and back to the user.*

=== 4.3 Exception Propagation

*Exceptions are thrown from the repository or service layers and are handled in the controller layer, where appropriate HTTP responses are generated.*

=== 4.4 Transaction Boundaries

*Transactions are typically started at the service layer to ensure data integrity and are committed or rolled back depending on the operation outcome.*

This detailed design document aims to provide developers with a clear understanding of the system's architecture and operations, facilitating easier maintenance and scalability.