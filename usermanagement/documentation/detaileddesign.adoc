=== IdentityProviderClient

Annotations::
- `@FeignClient`: Declares that this interface is a Feign client.
- `@PostMapping`: Indicates that this method of the Feign client would map to an HTTP POST.
- `@RequestBody`: Indicates that a method parameter should be bound to the body of the web request.

=== VehicleManagementClient

Purpose::
Feign client for interacting with an external vehicle management service.

Annotations::
- `@FeignClient`: Declares that this interface is a Feign client.
- `@GetMapping`: Indicates that this method of the Feign client would map to an HTTP GET.
- `@RequestParam`: Indicates that a method parameter should be bound to a web request parameter.

=== UserManagementController

Purpose::
Controller to handle HTTP requests related to user management.

Annotations::
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.
- `@PostMapping`: Mapping HTTP POST requests onto specific handler methods.
- `@RequestMapping`: Provides routing information. It tells Spring that any HTTP request with the path should be mapped to the corresponding method.
- `@RequestParam`: Indicates that a method parameter should be bound to a web request parameter.
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.

Methods::
- `public String assignVehicle(@RequestParam String username, @RequestParam String vin, @RequestParam String brand, @RequestParam String country)`: Assigns a vehicle to a user.
- `public String onboardUser()`: Onboards a user with default parameters.
- `public String onboardUser(@RequestParam String username, @RequestParam String password)`: Onboards a user with specified username and password.

Fields::
- `service : UserManagementService`: Autowired service that contains business logic for user management.

=== MobilityUser

Purpose::
Entity representing a user in the mobility system.

Annotations::
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@GeneratedValue`: Specifies the strategy of generation for the primary key.
- `@Getter`: Lombok annotation to generate getters.
- `@Id`: Specifies the primary key of an entity.
- `@Setter`: Lombok annotation to generate setters.
- `@Table`: Specifies the table in the database with which this entity is mapped.

Fields::
- `id : Long`: The primary key.
- `mobilityUserId : String`: A unique identifier for the user.
- `role : String`: The role of the user in the system.
- `username : String`: The username of the user.
- `vin : String`: The vehicle identification number assigned to the user.

=== UserManagementRepository

Purpose::
Repository for accessing the database table associated with `MobilityUser` entities.

=== UserManagementService

Purpose::
Service containing business logic for managing users.

Annotations::
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.
- `@Service`: Indicates that an annotated class is a "Service", originally defined by Domain-Driven Design (DDD) as "an operation offered as an interface that stands alone in the model, with no encapsulated state."

Methods::
- `public Optional<MobilityUser> getUserByUsername(String username)`: Retrieves a user by username.
- `public String onboardUser(String username, String password)`: Onboards a new user.
- `public void assignVehicleToUser(String username, String vin, String brand, String country)`: Assigns a vehicle to the specified user.

Fields::
- `identityProvider : IdentityProviderClient`: Autowired Feign client for identity management.
- `repo : UserManagementRepository`: Autowired repository for database access.
- `vehicleClient : VehicleManagementClient`: Autowired Feign client for vehicle management.

=== UsermanagementApplicationTests

Purpose::
Class for conducting Spring Boot tests.

Annotations::
- `@SpringBootTest`: Provides Spring Boot test features.
- `@Test`: Marks a method to be tested.

== Runtime View Diagrams

=== Sequence Diagram: User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service
participant "IdentityProviderClient" as IdentityProvider
participant "UserManagementRepository" as Repository

User -> Controller : onboardUser(username, password)
Controller -> Service : onboardUser(username, password)
Service -> IdentityProvider : createIdentity(username, password)
IdentityProvider -> Service : identityResponse
Service -> Repository : save(newUser)
Repository -> Service : userSaved
Service -> Controller : userOnboarded
Controller -> User : response
@enduml
----

=== Sequence Diagram: Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service
participant "IdentityProviderClient" as IdentityProvider

User -> Controller : authenticate(username, password)
Controller -> Service : authenticateUser(username, password)
Service -> IdentityProvider : validateCredentials(username, password)
IdentityProvider -> Service : validationResponse
Service -> Controller : authenticationResult
Controller -> User : token
@enduml
----

=== Sequence Diagram: JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "JWTService" as JWT
participant "UserManagementService" as Service

User -> JWT : validateToken(token)
JWT -> Service : getUserDetails(token)
Service -> JWT : userDetails
JWT -> User : validationStatus
@enduml
----

== Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "MobilityUser" {
  * id : Long
  --
  * mobilityUserId : String
  * role : String
  * username : String
  * vin : String
}
@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserManagementController**:
  - Receives HTTP requests.
  - Delegates business operations to **UserManagementService**.
  - Returns responses based on the results from the Service layer.

- **UserManagementService**:
  - Contains business logic.
  - Interacts with **UserManagementRepository** for database operations.
  - Communicates with external services via **IdentityProviderClient** and **VehicleManagementClient**.

- **UserManagementRepository**:
  - Handles CRUD operations directly with the database.
  - Used by the Service layer to persist and retrieve **MobilityUser** data.

=== Data Flow Through Layers

1. **Controller** receives HTTP request.
2. **Controller** calls appropriate method in **Service**.
3. **Service** performs business logic, possibly interacting with external systems via **Feign clients**.
4. **Service** interacts with **Repository** to persist/retrieve data.
5. Data flows back through the layers to the user.

=== Exception Propagation

- Exceptions are thrown at the Repository or Service layer.
- Handled at the Controller layer where appropriate HTTP status codes are set based on the exception type.

=== Transaction Boundaries

- Defined at the Service layer.
- Methods that modify the database state start and manage transactions.

This detailed design document provides a clear overview of the system architecture, component interactions, and data flow, facilitating development and maintenance activities.