= User Management System Detailed Design Document

This document provides a comprehensive detailed design of the User Management System implemented using Java Spring Boot. The system is designed to handle user registration, authentication, and vehicle assignment processes.

== Class-by-Class Analysis

=== UsermanagementApplication

This is the main class of the application, responsible for bootstrapping the Spring Boot application.

- *Annotations:*
  - `@EnableFeignClients`: Enables Feign support in Spring Boot application.
  - `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

- *Methods:*
  - `public static void main(String[] args)`: The entry point of the Spring Boot application.

=== IdentityProviderClient

A Feign client for interacting with an external identity provider service.

- *Annotations:*
  - `@FeignClient`: Declares that this interface is a Feign client.
  - `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
  - `@RequestBody`: Indicates a method parameter should be bound to the body of the web request.

=== VehicleManagementClient

A Feign client for interacting with an external vehicle management service.

- *Annotations:*
  - `@FeignClient`: Marks this interface as a Feign client.
  - `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
  - `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== UserManagementController

Controller that handles web requests related to user management.

- *Annotations:*
  - `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
  - `@RequestMapping`: Maps web requests onto methods in request-handling classes.
  - `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.

- *Methods:*
  - `public String assignVehicle(@RequestParam String username, @RequestParam String vin, @RequestParam String brand, @RequestParam String country)`: Assigns a vehicle to a user.
  - `public String onboardUser(@RequestParam String username, @RequestParam String password)`: Handles the onboarding of a new user.

- *Fields:*
  - `service : UserManagementService`: Injected service that handles the business logic.

=== MobilityUser

Entity representing a user in the mobility context.

- *Annotations:*
  - `@Entity`: Specifies that the class is an entity.
  - `@Table`: Specifies the primary table for the annotated entity.
  - `@Id`: Specifies the primary key of an entity.
  - `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
  - `@Getter/@Setter`: Lombok annotations to generate getters and setters automatically.

- *Fields:*
  - `id : Long`: The primary key.
  - `mobilityUserId : String`: A unique user identifier.
  - `role : String`: The user's role.
  - `username : String`: The username.
  - `vin : String`: Vehicle Identification Number associated with the user.

=== UserManagementRepository

Repository for accessing user data.

=== UserManagementService

Service layer that handles business logic related to user management.

- *Annotations:*
  - `@Service`: Indicates that an annotated class is a "Service".
  - `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.

- *Methods:*
  - `public Optional<MobilityUser> getUserByUsername(String username)`: Retrieves a user by username.
  - `public String onboardUser(String username, String password)`: Onboards a new user.
  - `public void assignVehicleToUser(String username, String vin, String brand, String country)`: Assigns a vehicle to a user.

- *Fields:*
  - `identityProvider : IdentityProviderClient`: Feign client for interacting with the identity provider.
  - `repo : UserManagementRepository`: Repository for user data access.
  - `vehicleClient : VehicleManagementClient`: Feign client for vehicle management.

=== UsermanagementApplicationTests

Class dedicated to testing the UsermanagementApplication.

- *Annotations:*
  - `@SpringBootTest`: Provides a bridge between Spring Boot test features and JUnit.
  - `@Test`: Denotes that a method is a test method.

== Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business flows in the system.

==== User Registration Flow

[plantuml, user-registration-flow, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service
participant "IdentityProviderClient" as IdentityProvider
participant "UserManagementRepository" as Repository

User -> Controller : onboardUser(username, password)
Controller -> Service : onboardUser(username, password)
Service -> IdentityProvider : createIdentity(username, password)
IdentityProvider -> Service : identityCreated
Service -> Repository : saveUser(userDetails)
Repository -> Service : userSaved
Service -> Controller : userOnboarded
Controller -> User : userOnboarded
@enduml
----

==== Authentication/Login Flow

[plantuml, authentication-flow, png]
----
@startuml
actor User
participant "UserManagementController" as Controller
participant "UserManagementService" as Service
participant "IdentityProviderClient" as IdentityProvider

User -> Controller : authenticateUser(username, password)
Controller -> Service : authenticateUser(username, password)
Service -> IdentityProvider : validateCredentials(username, password)
IdentityProvider -> Service : credentialsValid
Service -> Controller : authenticationSuccess
Controller -> User : authenticationSuccess
@enduml
----

==== JWT Token Validation Flow

[plantuml, jwt-validation-flow, png]
----
@startuml
actor User
participant "SecurityFilter" as Filter
participant "UserManagementService" as Service

User -> Filter : accessResource(token)
Filter -> Service : validateToken(token)
Service -> Filter : tokenValid
Filter -> User : accessGranted
@enduml
----

== Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "MobilityUser" {
  * id : Long
  --
  * mobilityUserId : String
  * role : String
  * username : String
  * vin : String
}

@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **UserManagementController**:
  - Receives HTTP requests and delegates to **UserManagementService** for processing.
  - Uses **@Autowired** to inject **UserManagementService**.

- **UserManagementService**:
  - Handles business logic and interacts with **UserManagementRepository** and external services through **IdentityProviderClient** and **VehicleManagementClient**.
  - Uses **@Autowired** to inject **UserManagementRepository**, **IdentityProviderClient**, and **VehicleManagementClient**.

- **UserManagementRepository**:
  - Interacts with the database to perform CRUD operations on **MobilityUser** entities.

=== Data Flow Through Layers

- Data flows from the controller to the service where business logic is applied. Then, depending on the operation, it might interact with external services or the database through the repository.

=== Exception Propagation

- Exceptions are thrown at the service or repository layers and are propagated up to the controller where they are handled and appropriate HTTP responses are generated.

=== Transaction Boundaries

- Transactions are managed at the service layer, ensuring that database operations are completed successfully before committing the transaction.

This detailed design document provides a clear and comprehensive understanding of the User Management System, facilitating further development, maintenance, and scaling of the application.