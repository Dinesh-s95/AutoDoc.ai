= Detailed Design Documentation for Enrollment Application

This document provides a comprehensive detailed design for the Enrollment Application built using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: This is the main entry point for the Spring Boot application. It initializes and runs the application context.

*Annotations*:
- `@EnableFeignClients`: Enables Feign clients in the application, allowing for declarative REST client creation.
- `@SpringBootApplication`: Signifies the main configuration class that powers up Spring Boot application.

*Methods*:
- `main(String[] args)`: The main method that Spring Boot uses to start the application.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "UserClient", url = "http://usermanagement.com")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose*: Interface for communicating with the User Management microservice using Feign REST client.

*Annotations*:
- `@FeignClient`: Declares a REST client interface. The `name` attribute assigns a name to the client, and `url` specifies the base URL of the called service.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }
}
----

*Purpose*: Provides RESTful web services for enrollment functionalities.

*Annotations*:
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps web requests onto methods in request-handling classes.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.

*Methods*:
- `nominatePrimary(String username)`: Handles the HTTP POST request to nominate a primary user.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: Data Transfer Object (DTO) for user responses.

*Annotations*:
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

*Fields*:
- `mobilityUserId`: Unique identifier for the user.
- `username`: Username of the user.
- `vin`: Vehicle Identification Number associated with the user.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: Represents the enrollment entity in the database.

*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.

*Fields*:
- `id`: Primary key of the enrollment record.
- `role`: Role of the user in the system.
- `username`: Username of the enrolled user.
- `vin`: Vehicle Identification Number associated with the enrollment.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: Repository interface for `Enrollment` entities, extending Spring Data JPA.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(user.getUsername());
        enrollment.setVin(user.getVin());
        enrollment.setRole("Primary");
        repo.save(enrollment);
        return "Nomination Successful";
    }
}
----

*Purpose*: Service layer to handle business logic for user enrollment.

*Annotations*:
- `@Service`: Marks the class as a service provider, used for business logic.

*Methods*:
- `nominatePrimaryUser(String username)`: Nominates a primary user by creating a new enrollment record.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: Test class for the application to ensure the Spring context loads properly.

*Annotations*:
- `@SpringBootTest`: Provides Spring Boot test features.

== Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business processes in the system.

==== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor "User" as user
participant "EnrollmentController" as controller
participant "EnrollmentService" as service
participant "EnrollmentRepository" as repo

user -> controller : nominatePrimary(username)
controller -> service : nominatePrimaryUser(username)
service -> repo : save(enrollment)
repo -> service : return
service -> controller : return "Nomination Successful"
controller -> user : return "Nomination Successful"
@enduml
----

==== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor "User" as user
participant "AuthenticationController" as authController
participant "AuthenticationService" as authService

user -> authController : login(username, password)
authController -> authService : authenticate(username, password)
authService -> authController : return token
authController -> user : return token
@enduml
----

==== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor "User" as user
participant "JWTFilter" as jwtFilter
participant "AuthenticationService" as authService

user -> jwtFilter : accessProtectedResource(token)
jwtFilter -> authService : validateToken(token)
authService -> jwtFilter : return validationStatus
jwtFilter -> user : proceed / error
@enduml
----

== Entity Relationship Diagram

The following diagram illustrates the database schema for the Enrollment Application.

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "Enrollment" {
    *id : Long
    --
    role : String
    username : String
    vin : String
}
@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

The interactions between controllers, services, and repositories are crucial for maintaining clean separation of concerns within the application. Controllers handle HTTP requests, delegate business processing to services, and return responses. Services encapsulate the business logic and call on repositories to access the database.

=== Data Flow Through Layers

Data flows from controllers to services, where business logic is applied before moving to repositories for database operations. Data then flows back to the service and finally to the controller to complete the cycle.

=== Exception Propagation

Exceptions are generated primarily at the service and repository layers and are propagated up to the controllers where they are handled gracefully. This includes custom exceptions for business-specific scenarios.

=== Transaction Boundaries

Transaction boundaries are typically managed at the service layer, ensuring that database operations are completed successfully before committing the transaction. This is crucial for maintaining data integrity and consistency.

== Conclusion

This detailed design document provides a comprehensive overview of the Enrollment Application, including class descriptions, interaction diagrams, and database schema. It serves as a guide for developers to understand and contribute effectively to the project.