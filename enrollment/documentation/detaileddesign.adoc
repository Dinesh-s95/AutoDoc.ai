= Detailed Design Documentation for Enrollment Application

This document provides a comprehensive detailed design analysis of the Enrollment Application, focusing on the Java Spring Boot architecture. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: This is the main class that bootstraps the Spring Boot application. It is responsible for initializing and configuring the Spring context.

*Annotations*:
- `@EnableFeignClients`: Enables the discovery of interfaces that declare they are Feign clients (for making REST calls).
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods*:
- `main(String[] args)`: The entry point of the Spring Boot application.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "userClient", url = "http://usermanagement/")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose*: This interface is used to communicate with the User Management microservice using Feign REST client.

*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client and specifies the name and URL of the service it connects to.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates that a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate-primary")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }
}
----

*Purpose*: This class acts as the REST controller to handle HTTP requests related to enrollment processes.

*Annotations*:
- `@RestController`: Indicates that this class is a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps web requests onto methods in request-handling classes with flexible method signatures.
- `@Autowired`: Marks a constructor, field, setter method, or config method as to be autowired by Spring's dependency injection facilities.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.

*Methods*:
- `nominatePrimary(String username)`: Handles the nomination of a primary user by username.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: This Data Transfer Object (DTO) is used to encapsulate the data of a user and transfer it between processes.

*Annotations*:
- `@Getter`: Lombok annotation to generate getters for all fields.
- `@Setter`: Lombok annotation to generate setters for all fields.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: Represents the enrollment entity in the database.

*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: Repository interface for `Enrollment` that extends Spring Data JPA's `JpaRepository`, providing CRUD operations on `Enrollment` entities.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(username);
        enrollment.setRole("PRIMARY");
        repo.save(enrollment);
        return "User nominated as primary";
    }
}
----

*Purpose*: This service class handles the business logic for enrollment operations.

*Annotations*:
- `@Service`: Indicates that an annotated class is a "Service", originally defined by Domain-Driven Design (DDD) as "an operation offered as an interface that stands alone in the model, with no encapsulated state."

*Methods*:
- `nominatePrimaryUser(String username)`: Nominates a user as the primary user, saves the information in the database, and returns a confirmation message.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: This class contains integration tests to ensure the Spring context loads correctly.

*Annotations*:
- `@SpringBootTest`: Provides support for loading a Spring ApplicationContext and having beans `@Autowired` into your test instance.
- `@Test`: Denotes that a method is a test method.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User as user
participant "EnrollmentController" as controller
participant "EnrollmentService" as service
participant "EnrollmentRepository" as repo

user -> controller : register(username, details)
controller -> service : registerUser(username, details)
service -> repo : save(new Enrollment)
repo --> service : enrollmentSaved
service --> controller : "User registered"
controller --> user : "User registered"
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User as user
participant "AuthenticationController" as authController
participant "AuthenticationService" as authService
participant "UserRepository" as userRepo

user -> authController : login(username, password)
authController -> authService : authenticate(username, password)
authService -> userRepo : findByUsername(username)
userRepo --> authService : user
authService --> authController : token
authController --> user : token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User as user
participant "ResourceController" as resource
participant "JwtFilter" as jwtFilter
participant "AuthenticationService" as authService

user -> resource : accessResource(token)
resource -> jwtFilter : validateToken(token)
jwtFilter -> authService : decodeToken(token)
authService --> jwtFilter : userDetails
jwtFilter --> resource : proceed
resource --> user : resourceData
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "Enrollment" {
    * id : Long
    ---
    role : String
    username : String
    vin : String
}
@enduml
----

*Enrollment*: Represents the enrollment details of a user. It includes fields for user roles, usernames, and vehicle identification numbers (VINs).

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

1. **Controller**: Receives HTTP requests, delegates business processing to services, and returns responses.
2. **Service**: Contains business logic, interacts with repositories to persist data.
3. **Repository**: Abstracts the data store, providing CRUD operations on entities.

=== Data Flow Through Layers

1. **HTTP Request**: Comes into the Controller.
2. **Controller**: Parses the request, calls the appropriate service method.
3. **Service**: Processes the request, interacts with the repository.
4. **Repository**: Performs database operations.
5. **Service**: Processes the data returned by the repository.
6. **Controller**: Sends the response back to the client.

=== Exception Propagation

Exceptions are thrown at the repository or service layer and are propagated up to the controllers where they are handled and an appropriate HTTP response is returned.

=== Transaction Boundaries

Transactions are typically started at the service layer ensuring that all operations within a single service method are completed successfully before the transaction is committed. If an exception occurs, the transaction is rolled back.

This detailed design document provides a comprehensive overview of the Enrollment Application, focusing on its architecture, classes, interactions, and processes. It serves as a guide for developers to understand and work on the application effectively.