= Detailed Design Documentation for Enrollment Application

== Introduction

This document provides a detailed design overview of the Enrollment Application. It covers the class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions. The application is built using Java Spring Boot and utilizes various Spring annotations to manage dependency injection, REST controllers, and service definitions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: Acts as the bootstrap class for the Spring Boot application.
*Annotations*:
- `@EnableFeignClients`: Enables Feign REST clients.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "userClient", url = "http://usermanagement.com")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose*: Defines a Feign client for communicating with the User Management microservice.
*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }
}
----

*Purpose*: Provides RESTful web services for handling enrollment processes.
*Annotations*:
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps web requests onto methods in request-handling classes.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.
*Methods*:
- `nominatePrimary(String username)`: Nominates a primary user.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: Data Transfer Object for user responses.
*Annotations*:
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: Represents the enrollment entity.
*Annotations*:
- `@Entity`: Specifies that the class is an entity.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter` and `@Setter`: Lombok annotations to generate getters and setters.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: Repository interface for `Enrollment` entity, extending Spring Data JPA.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(username);
        enrollment.setRole("PRIMARY");
        repo.save(enrollment);
        return "Nomination Successful";
    }
}
----

*Purpose*: Service class for handling business logic related to enrollment.
*Annotations*:
- `@Service`: Indicates that an annotated class is a "Service".
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.
*Methods*:
- `nominatePrimaryUser(String username)`: Handles the nomination of a primary user.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: Test class for the Enrollment Application.
*Annotations*:
- `@SpringBootTest`: Provides Spring Boot test features.
- `@Test`: Denotes that a method is a test method.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-flow, png]
----
@startuml
actor User
entity UserController
entity UserService
entity UserRepository

User -> UserController : register(user)
UserController -> UserService : saveUser(user)
UserService -> UserRepository : save(user)
UserRepository -> UserService
UserService -> UserController
UserController -> User
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-flow, png]
----
@startuml
actor User
entity AuthController
entity AuthService
database AuthDB

User -> AuthController : login(credentials)
AuthController -> AuthService : authenticate(credentials)
AuthService -> AuthDB : validateUser(credentials)
AuthDB -> AuthService
AuthService -> AuthController : token
AuthController -> User : token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-flow, png]
----
@startuml
actor User
entity AuthController
entity AuthService

User -> AuthController : request(resource)
AuthController -> AuthService : validateToken(token)
AuthService -> AuthController : validationStatus
AuthController -> User : response
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "Enrollment" {
    *id : Long
    --
    role : String
    username : String
    vin : String
}
@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

1. **EnrollmentController**:
   - Receives HTTP requests.
   - Calls **EnrollmentService** methods.
2. **EnrollmentService**:
   - Handles business logic.
   - Interacts with **EnrollmentRepository** to persist data.
   - Communicates with **UserManagementClient** to fetch user details.
3. **EnrollmentRepository**:
   - Extends JpaRepository.
   - Manages database operations for the **Enrollment** entity.

=== Data Flow Through Layers

- **Controller** receives the request.
- **Service** processes business logic and calls **Repository**.
- **Repository** interacts with the database.
- Data flows back through the layers to the user.

=== Exception Propagation

- Exceptions are thrown by the **Repository** or **Service**.
- Caught and handled in the **Controller**.
- Appropriate HTTP status and error message returned to the client.

=== Transaction Boundaries

- Transactions are typically started at the **Service** layer.
- Spring manages transactions based on method annotations like `@Transactional`.

== Conclusion

This detailed design document provides a comprehensive overview of the Enrollment Application's architecture, including class responsibilities, interactions, and data flows. It serves as a guide for developers to understand and contribute effectively to the project.