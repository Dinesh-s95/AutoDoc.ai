= Detailed Design Documentation for Enrollment System

This document provides a comprehensive detailed design of the Enrollment System implemented using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: This is the main class that boots up the Spring Boot application. It is responsible for initializing and configuring the Spring context.

*Annotations*:
- `@EnableFeignClients`: Enables Feign clients in the application, allowing for declarative REST client creation.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods*:
- `main(String[] args)`: The entry point of the Java application which starts the Spring Boot application.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "userClient", url = "http://usermanagement.com")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose*: This interface defines a Feign client for interacting with the User Management microservice.

*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client and specifies the name and URL of the service it connects to.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods. It is used here to define a method for fetching user details by username.
- `@RequestParam`: Indicates that a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }
}
----

*Purpose*: This class acts as the REST controller to handle HTTP requests related to enrollment processes.

*Annotations*:
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps HTTP requests to handler methods of MVC and REST controllers.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@Autowired`: Marks a constructor, field, setter method, or config method as to be autowired by Spring's dependency injection facilities.

*Methods*:
- `nominatePrimary(String username)`: Handles the HTTP POST request to nominate a primary user. It delegates the business logic to the `EnrollmentService`.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: This Data Transfer Object (DTO) class is used to transfer user data between processes.

*Annotations*:
- `@Getter`: Lombok annotation to generate getters for all fields.
- `@Setter`: Lombok annotation to generate setters for all fields.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: This class represents the enrollment entity in the database.

*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
- `@Getter` / `@Setter`: Lombok annotations to generate getters and setters for all fields.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: This interface extends `JpaRepository`, providing CRUD operations for the `Enrollment` entity.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(username);
        enrollment.setRole("PRIMARY");
        repo.save(enrollment);
        return "User nominated as primary";
    }
}
----

*Purpose*: This class provides business logic for enrollment processes.

*Annotations*:
- `@Service`: Indicates that the class is a service provider, used for business logic.
- `@Autowired`: Marks dependency injection for `EnrollmentRepository` and `UserManagementClient`.

*Methods*:
- `nominatePrimaryUser(String username)`: Retrieves user details using the `UserManagementClient`, creates a new `Enrollment` instance, saves it, and returns a confirmation message.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: This class provides integration tests for the application.

*Annotations*:
- `@SpringBootTest`: Provides support for loading a Spring ApplicationContext and having beans `@Autowired` into your test instance.
- `@Test`: Marks a method to be testable.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "EnrollmentController" as Controller
participant "EnrollmentService" as Service
participant "EnrollmentRepository" as Repository

User -> Controller : POST /enrollment/nominate (username)
Controller -> Service : nominatePrimaryUser(username)
Service -> Repository : save(enrollment)
Repository --> Service : enrollmentSaved
Service --> Controller : "User nominated as primary"
Controller --> User : "User nominated as primary"
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "AuthenticationController" as AuthController
participant "AuthenticationService" as AuthService
participant "UserRepository" as UserRepository

User -> AuthController : POST /auth/login (username, password)
AuthController -> AuthService : authenticate(username, password)
AuthService -> UserRepository : findByUsername(username)
UserRepository --> AuthService : user
AuthService --> AuthController : token
AuthController --> User : token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "ResourceController" as Resource
participant "JWTFilter" as Filter
participant "AuthenticationService" as AuthService

User -> Resource : GET /protected/resource
Resource -> Filter : validateToken(token)
Filter -> AuthService : verifyToken(token)
AuthService --> Filter : isValid
Filter --> Resource : proceed if valid
Resource --> User : protected resource
@enduml
----

== Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "Enrollment" {
    * id : Long
    --
    * role : String
    * username : String
    * vin : String
}
@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **EnrollmentController**:
  - Receives HTTP requests and delegates to **EnrollmentService**.
  - Uses `@Autowired` to inject **EnrollmentService**.

- **EnrollmentService**:
  - Handles business logic and interacts with **EnrollmentRepository** and **UserManagementClient**.
  - Uses `@Autowired` to inject **EnrollmentRepository** and **UserManagementClient**.
  - Calls **EnrollmentRepository** to persist `Enrollment` entities.

- **EnrollmentRepository**:
  - Extends `JpaRepository`, providing CRUD operations for `Enrollment` entities.

=== Data Flow Through Layers

1. **Controller** receives HTTP request.
2. **Controller** calls **Service** with parameters from the request.
3. **Service** performs business logic, possibly fetching or storing data via **Repository**.
4. **Repository** interacts with the database and returns data to **Service**.
5. **Service** processes the data and returns a response to **Controller**.
6. **Controller** sends the response back to the client.

=== Exception Propagation

- Exceptions can occur at any layer.
- Service layer typically handles business exceptions, possibly using custom exceptions that are caught and handled in the controllers.
- Controllers can catch exceptions and translate them into appropriate HTTP responses.

=== Transaction Boundaries

- Defined at the service layer.
- Methods in the service layer start and manage transactions.
- Spring manages transactions declaratively when `@Transactional` is used on methods or classes.

This detailed design document provides a thorough overview of the system architecture, helping developers understand and maintain the system effectively.