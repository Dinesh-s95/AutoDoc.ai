= Detailed Design Documentation for Enrollment System

This document provides a comprehensive detailed design for the Enrollment System implemented using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: Serves as the entry point for the Spring Boot application. Initializes the Spring context and all the Spring Boot configurations.

*Annotations*:
- `@EnableFeignClients`: Enables Feign REST clients within the application.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods*:
- `main(String[] args)`: The main method that Spring Boot uses to start the application.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "userClient", url = "http://usermanagement.com")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose*: Defines a Feign client for communicating with the User Management microservice.

*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {

    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate-primary")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }
}
----

*Purpose*: Handles incoming HTTP requests related to enrollments.

*Annotations*:
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.
- `@RequestMapping`: Maps HTTP requests to handler methods of MVC and REST controllers.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.

*Methods*:
- `nominatePrimary(String username)`: Nominates a primary user based on the username.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: Data Transfer Object for user information.

*Annotations*:
- `@Getter`: Lombok annotation to create getters.
- `@Setter`: Lombok annotation to create setters.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: Represents the enrollment entity in the database.

*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: Repository interface for `Enrollment` entities, leveraging Spring Data JPA.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {

    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(user.getUsername());
        enrollment.setVin(user.getVin());
        enrollment.setRole("PRIMARY");
        repo.save(enrollment);
        return "User nominated as primary";
    }
}
----

*Purpose*: Service layer to handle the business logic of enrollment processes.

*Annotations*:
- `@Service`: Indicates that an annotated class is a "Service", originally defined by Domain-Driven Design (DDD) as "an operation offered as an interface that stands alone in the model, with no encapsulated state."

*Methods*:
- `nominatePrimaryUser(String username)`: Retrieves user details from the User Management client and creates a new enrollment as a primary user.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {

    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: Basic integration test to ensure the Spring context loads correctly.

*Annotations*:
- `@SpringBootTest`: Provides a bridge between Spring Boot test features and JUnit. Whenever you are testing Spring Boot applications, this annotation will be useful.

== 2. Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "RegistrationController" as RC
participant "UserService" as US
participant "UserRepository" as UR

User -> RC : register(userDetails)
RC -> US : createUser(userDetails)
US -> UR : save(newUser)
UR --> US : userSaved
US --> RC : userDTO
RC --> User : registrationConfirmation
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "AuthenticationController" as AC
participant "AuthenticationService" as AS
participant "UserRepository" as UR

User -> AC : login(credentials)
AC -> AS : authenticate(credentials)
AS -> UR : findByUsername(username)
UR --> AS : user
AS --> AC : authenticationToken
AC --> User : token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "ResourceController" as RC
participant "JWTService" as JS

User -> RC : request(resource)
RC -> JS : validateToken(token)
JS --> RC : isValid
RC --> User : resource
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "User" {
    * id : Long
    --
    * username : String
    * password : String
}

entity "Enrollment" {
    * id : Long
    --
    * role : String
    * username : String
    * vin : String
}

User ||--o{ Enrollment
@enduml
----

*User*: Represents the users of the system. Each user has a unique username and password.

*Enrollment*: Represents the enrollments of users in the system. Each enrollment records the role, username, and vehicle identification number (VIN) associated with a user.

== 4. Detailed Component Interactions

=== Controller-Service-Repository Interactions

- *EnrollmentController* receives HTTP requests and delegates to *EnrollmentService* for processing.
- *EnrollmentService* interacts with *EnrollmentRepository* to persist data.
- *EnrollmentService* also communicates with *UserManagementClient* to fetch user details.

=== Data Flow Through Layers

- Data flows from controllers to services where business logic is applied. Then, data is either fetched from or persisted to the database through repositories. Data transfer objects (DTOs) are used to transfer data between processes.

=== Exception Propagation

- Exceptions are thrown from the repository or service layers and are caught in the controller layer. Appropriate HTTP responses are generated based on the exception type.

=== Transaction Boundaries

- Transactions are managed at the service layer, ensuring that database operations are completed successfully before committing the transaction. If an exception occurs, the transaction is rolled back.

This detailed design document provides a comprehensive overview of the Enrollment System, enabling developers to understand and work effectively on the project.