= Detailed Design Documentation for Enrollment System

This document provides a comprehensive detailed design of the Enrollment System developed using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== 1.1 EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: This is the main class that boots up the Spring Boot application. It also enables Feign clients for making HTTP requests to other services.

*Annotations*:
- `@EnableFeignClients`: Allows the discovery of interfaces that declare they are Feign clients (for making REST calls).
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods*:
- `main(String[] args)`: The entry point of the Spring Boot application.

=== 1.2 UserManagementClient

[source,java]
----
@FeignClient(name = "UserClient", url = "http://usermanagement.com")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose*: Defines a Feign client for interacting with the User Management service.

*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client and sets the name and URL of the service it communicates with.
- `@GetMapping`: Used to map HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates that a method parameter should be bound to a web request parameter.

=== 1.3 EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate-primary")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }

    @PostMapping("/nominate-secondary")
    public String nominateSecondary(@RequestParam String username) {
        return service.nominateSecondaryUser(username);
    }
}
----

*Purpose*: Provides RESTful web services for enrollment operations.

*Annotations*:
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps HTTP requests to handler methods of MVC and REST controllers.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.

*Methods*:
- `nominatePrimary(String username)`: Nominates a primary user.
- `nominateSecondary(String username)`: Nominates a secondary user.

=== 1.4 UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: Data Transfer Object for user responses.

*Annotations*:
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

=== 1.5 Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: Represents the enrollment entity in the database.

*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter` and `@Setter`: Lombok annotations to generate getters and setters.

=== 1.6 EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: Repository interface for `Enrollment` that extends Spring Data JPA's `JpaRepository`, providing CRUD operations.

=== 1.7 EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        // Implementation details
    }

    public String nominateSecondaryUser(String username) {
        // Implementation details
    }
}
----

*Purpose*: Service layer to handle the business logic of enrollment operations.

*Annotations*:
- `@Service`: Indicates that an annotated class is a "Service", originally defined by Domain-Driven Design (DDD) as "an operation offered as an interface that stands alone in the model, with no encapsulated state."

*Methods*:
- `nominatePrimaryUser(String username)`: Business logic to nominate a primary user.
- `nominateSecondaryUser(String username)`: Business logic to nominate a secondary user.

=== 1.8 EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: Basic Spring Boot test class to ensure the application context loads properly.

*Annotations*:
- `@SpringBootTest`: Provides Spring Boot support for tests with features like loading an `ApplicationContext` and providing beans.
- `@Test`: Denotes that a method is a test method.

== 2. Runtime View Diagrams

=== 2.1 User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "EnrollmentController" as Controller
participant "EnrollmentService" as Service
participant "EnrollmentRepository" as Repository

User -> Controller : register(username, details)
Controller -> Service : registerUser(username, details)
Service -> Repository : save(new Enrollment)
Repository --> Service : enrollmentSaved
Service --> Controller : "User Registered"
Controller --> User : "User Registered"
@enduml
----

=== 2.2 Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "AuthenticationController" as Controller
participant "AuthenticationService" as Service
participant "UserRepository" as Repository

User -> Controller : login(username, password)
Controller -> Service : authenticate(username, password)
Service -> Repository : findByUsername(username)
Repository --> Service : user
Service --> Controller : generateToken(user)
Controller --> User : token
@enduml
----

=== 2.3 JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "JWTFilter" as Filter
participant "TokenService" as TokenService

User -> Filter : request(resource)
Filter -> TokenService : validateToken(token)
TokenService --> Filter : isValid
Filter --> User : proceed / error
@enduml
----

=== 2.4 Business Process Flow

[plantuml, business-process-sequence, png]
----
@startuml
actor User
participant "BusinessController" as Controller
participant "BusinessService" as Service
participant "BusinessRepository" as Repository

User -> Controller : performAction(data)
Controller -> Service : processAction(data)
Service -> Repository : updateEntity(entity)
Repository --> Service : updatedEntity
Service --> Controller : result
Controller --> User : result
@enduml
----

=== 2.5 Exception Handling Flow

[plantuml, exception-handling-sequence, png]
----
@startuml
actor User
participant "EnrollmentController" as Controller
participant "EnrollmentService" as Service
participant "ExceptionHandler" as Handler

User -> Controller : action(data)
Controller -> Service : process(data)
Service -> Controller : throw new EnrollmentException("Error")
Controller -> Handler : handleException(EnrollmentException)
Handler --> User : "Error occurred: Error"
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "Enrollment" {
    * id : Long
    --
    * role : String
    * username : String
    * vin : String
}

entity "User" {
    * id : Long
    --
    * username : String
    * password : String
}

Enrollment ||..|| User : "maps to"
@enduml
----

*Enrollment*: Represents the enrollment details of a user. Each enrollment is uniquely identified by an `id`. It includes the user's role, username, and vehicle identification number (VIN).

*User*: Represents a user in the system. Each user is uniquely identified by an `id` and has a `username` and `password`.

*Relationship*: Each enrollment maps to a user, indicating which user is enrolled.

== 4. Detailed Component Interactions

=== 4.1 Controller-Service-Repository Interactions

*Controller*: Handles incoming HTTP requests, delegates business processing to the service layer, and responds back to the client.

*Service*: Contains core business logic and calls on the repository layer for data access.

*Repository*: Interface to the database, handling all data persistence and retrieval operations.

=== 4.2 Data Flow Through Layers

1. **Controller**: Receives and validates HTTP request data.
2. **Service**: Processes business logic, may call external services or other domain services.
3. **Repository**: Performs CRUD operations on the database.

=== 4.3 Exception Propagation

1. **Service Layer**: Business exceptions are thrown.
2. **Controller Layer**: Catches and handles exceptions, possibly translating them into user-friendly messages or error responses.

=== 4.4 Transaction Boundaries

Transactions are typically started at the service layer to ensure data consistency during business operations. Spring manages transaction boundaries using the `@Transactional` annotation, which can be applied at the class or method level.

This document provides a detailed overview of the system's design and should serve as a comprehensive guide for developers involved in the project.