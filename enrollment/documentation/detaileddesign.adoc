= Detailed Design Documentation for Enrollment System

This document provides a comprehensive detailed design of the Enrollment System implemented using Java Spring Boot. The document includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

==== Purpose
The `EnrollmentApplication` class serves as the entry point for the Spring Boot application.

==== Annotations
- `@EnableFeignClients`: Enables Feign clients in the application, allowing for declarative REST client creation.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

==== Methods
- `public static void main(String[] args)`: The main method that launches the Spring Boot application.

=== UserManagementClient

==== Purpose
The `UserManagementClient` class is a Feign client used to interact with external user management services.

==== Annotations
- `@FeignClient`: Declares that this interface is a Feign client and specifies the service it connects to.
- `@GetMapping`: Used within the interface to bind HTTP GET requests to specific methods.
- `@RequestParam`: Indicates method parameter should be bound to a web request parameter.

=== EnrollmentController

==== Purpose
The `EnrollmentController` handles incoming HTTP requests related to user enrollment processes.

==== Annotations
- `@Autowired`: Marks the automatic injection of the `EnrollmentService`.
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.
- `@RequestMapping`: Maps HTTP requests to handler methods of MVC and REST controllers.
- `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.

==== Methods
- `public String nominatePrimary(@RequestParam String username)`: Nominates a primary user.
- `public String nominateSecondaryUser(@RequestParam String username)`: Nominates a secondary user.

=== UserResponseDTO

==== Purpose
The `UserResponseDTO` is a Data Transfer Object class used to encapsulate user data as a response.

==== Annotations
- `@Getter`: Lombok annotation to generate getters for all fields.
- `@Setter`: Lombok annotation to generate setters for all fields.

==== Fields
- `mobilityUserId : String`
- `username : String`
- `vin : String`

=== Enrollment

==== Purpose
The `Enrollment` class represents the enrollment entity in the database.

==== Annotations
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Id`: Specifies the primary key of an entity.
- `@Getter`: Generates getters for all fields.
- `@Setter`: Generates setters for all fields.

==== Fields
- `id : Long`
- `role : String`
- `username : String`
- `vin : String`

=== EnrollmentRepository

==== Purpose
The `EnrollmentRepository` provides CRUD operations for `Enrollment` entities.

=== EnrollmentService

==== Purpose
The `EnrollmentService` contains business logic for nominating users and interacts with `EnrollmentRepository` and `UserManagementClient`.

==== Annotations
- `@Autowired`: Marks the automatic injection of the `EnrollmentRepository` and `UserManagementClient`.
- `@Service`: Indicates that the class holds business logic.

==== Methods
- `public String nominatePrimaryUser(String username)`: Business logic to nominate a primary user.
- `public String nominateSecondaryUser(String username)`: Business logic to nominate a secondary user.

=== EnrollmentApplicationTests

==== Purpose
The `EnrollmentApplicationTests` class is used to perform integration tests on the Enrollment Application.

==== Annotations
- `@SpringBootTest`: Provides Spring Boot test features.
- `@Test`: Denotes that a method is a test method.

== Runtime View Diagrams

=== Sequence Diagrams

==== User Registration Flow

[plantuml, user-registration-sequence, png]
....
@startuml
actor User
participant "EnrollmentController" as Controller
participant "EnrollmentService" as Service
participant "EnrollmentRepository" as Repository

User -> Controller : register(username, details)
Controller -> Service : registerUser(username, details)
Service -> Repository : save(newUser)
Repository --> Service : userSaved
Service --> Controller : registrationSuccess
Controller --> User : registrationDetails
@enduml
....

==== Authentication/Login Flow

[plantuml, authentication-sequence, png]
....
@startuml
actor User
participant "AuthenticationController" as AuthController
participant "AuthenticationService" as AuthService
participant "UserRepository" as UserRepo

User -> AuthController : login(username, password)
AuthController -> AuthService : authenticate(username, password)
AuthService -> UserRepo : findByUsername(username)
UserRepo --> AuthService : user
AuthService --> AuthController : token
AuthController --> User : tokenDetails
@enduml
....

==== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
....
@startuml
actor User
participant "TokenValidationController" as TokenController
participant "TokenService" as TokenSvc

User -> TokenController : validate(token)
TokenController -> TokenSvc : checkTokenValidity(token)
TokenSvc --> TokenController : isValid
TokenController --> User : validationStatus
@enduml
....

== Entity Relationship Diagram

[plantuml, er-diagram, png]
....
@startuml
entity "Enrollment" {
  * id : Long
  ---
  role : String
  username : String
  vin : String
}

entity "User" {
  * id : Long
  ---
  username : String
  password : String
}

Enrollment ||--o{ User : "nominates"
@enduml
....

=== Detailed Description of Entities

==== Enrollment
The `Enrollment` entity represents the enrollment records in the system. Each enrollment is uniquely identified by an `id`. It contains the `role`, `username`, and `vin` of the enrolled user.

==== User
The `User` entity represents users in the system. Each user has a unique `id`, a `username`, and a `password`.

=== Detailed Component Interactions

==== Controller-Service-Repository Interactions

- **EnrollmentController**:
  - Receives HTTP requests and delegates to **EnrollmentService**.
  - Handles response formation based on the results from the service layer.

- **EnrollmentService**:
  - Contains business logic and interacts with **EnrollmentRepository** to persist data.
  - Communicates with external services via **UserManagementClient**.

- **EnrollmentRepository**:
  - Provides CRUD operations directly on the database via Spring Data JPA.

==== Data Flow Through Layers

1. **Controller** receives HTTP request.
2. **Service** processes business logic.
3. **Repository** interacts with the database.
4. Data flows back through the layers to the user.

==== Exception Propagation

Exceptions are thrown by the Repository or Service layers and are propagated up to the Controllers where they are handled and appropriate HTTP responses are generated.

==== Transaction Boundaries

Transactions are typically started at the Service layer ensuring that all database operations performed within a service method are completed successfully before committing the transaction.

This detailed design document provides a comprehensive overview of the Enrollment System, ensuring developers have a clear understanding of the system's architecture and operations.