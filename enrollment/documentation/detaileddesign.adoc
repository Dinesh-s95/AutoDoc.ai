= Detailed Design Documentation: Enrollment System

This document provides a comprehensive detailed design of the Enrollment System developed using Java Spring Boot. It covers class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@SpringBootApplication
@EnableFeignClients
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose:* This is the main class that bootstraps the Spring Boot application. It also enables Feign clients for making HTTP requests to other services.

*Annotations:*
- `@SpringBootApplication`: Marks this class as a Spring Boot application.
- `@EnableFeignClients`: Allows the application to use Feign clients.

*Methods:*
- `main(String[] args)`: The entry point of the application.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "userClient")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose:* This interface defines a Feign client for interacting with the user management service.

*Annotations:*
- `@FeignClient`: Declares this interface as a Feign client.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }
}
----

*Purpose:* This class handles HTTP requests related to enrollments.

*Annotations:*
- `@RestController`: Marks this class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps web requests onto methods in request-handling classes.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.

*Methods:*
- `nominatePrimary(String username)`: Nominates a primary user based on the username.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose:* This class serves as a Data Transfer Object for user responses.

*Annotations:*
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose:* Represents the enrollment entity in the database.

*Annotations:*
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose:* Repository interface for `Enrollment` that extends Spring Data JPA's `JpaRepository`, providing CRUD operations.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(username);
        enrollment.setRole("Primary");
        repo.save(enrollment);
        return "User nominated as primary";
    }
}
----

*Purpose:* This class provides business services related to enrollments.

*Annotations:*
- `@Service`: Marks the class as a service provider, used for business logic.
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.

*Methods:*
- `nominatePrimaryUser(String username)`: Nominates a user as primary by creating an enrollment record.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose:* This class contains integration tests for the Enrollment Application.

*Annotations:*
- `@SpringBootTest`: Provides Spring Boot support for integration tests.
- `@Test`: Marks a method to be testable.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-flow, png]
----
@startuml
actor "User" as user
participant "EnrollmentController" as controller
participant "EnrollmentService" as service
participant "EnrollmentRepository" as repo

user -> controller : register(username)
controller -> service : nominatePrimaryUser(username)
service -> repo : save(enrollment)
repo -> service : return
service -> controller : return "User nominated as primary"
controller -> user : return "User nominated as primary"
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-flow, png]
----
@startuml
actor "User" as user
participant "AuthenticationController" as authController
participant "AuthenticationService" as authService

user -> authController : login(username, password)
authController -> authService : authenticate(username, password)
authService -> authController : return token
authController -> user : return token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-flow, png]
----
@startuml
actor "User" as user
participant "JWTFilter" as jwtFilter
participant "AuthenticationService" as authService

user -> jwtFilter : accessResource(token)
jwtFilter -> authService : validateToken(token)
authService -> jwtFilter : return isValid
jwtFilter -> user : proceed if valid
@enduml
----

== Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "Enrollment" {
    * id : Long
    --
    * role : String
    * username : String
    * vin : String
}

@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

1. *Controller to Service:*
   - The controller receives the HTTP request and delegates the business processing to the service layer.

2. *Service to Repository:*
   - The service layer interacts with the repository for data persistence.

3. *Repository to Database:*
   - The repository layer communicates with the database to perform CRUD operations.

=== Data Flow Through Layers

1. *Data Flow:*
   - Data flows from the controller to the service, then to the repository, and finally to the database.

=== Exception Propagation

1. *Exception Handling:*
   - Exceptions are thrown by the repository or service layers and are propagated up to the controller where they are handled and an appropriate response is returned to the client.

=== Transaction Boundaries

1. *Transaction Management:*
   - Transactions are managed at the service layer, ensuring that database operations are completed successfully before committing the transaction.

This detailed design document provides a comprehensive overview of the Enrollment System, facilitating developers in understanding and maintaining the system.