= Detailed Design Documentation for Enrollment System

This document provides a comprehensive detailed design of the Enrollment System developed using Java Spring Boot. It covers the class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

The `EnrollmentApplication` class is the entry point of the Spring Boot application.

- *Annotations*:
  - `@EnableFeignClients`: Enables Feign REST clients.
  - `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

- *Methods*:
  - `public static void main(String[] args)`: The main method that Spring Boot uses to start the application.

=== UserManagementClient

The `UserManagementClient` is a Feign client used to communicate with external user management services.

- *Annotations*:
  - `@FeignClient`: Declares that this interface is a Feign client.
  - `@GetMapping`: Used on the interface methods to bind them to HTTP GET requests.
  - `@RequestParam`: Indicates method parameter should be bound to a web request parameter.

=== EnrollmentController

The `EnrollmentController` handles incoming HTTP requests related to user enrollment.

- *Annotations*:
  - `@Autowired`: Marks a field to be autowired by Spring's dependency injection facilities.
  - `@PostMapping`: Annotation for mapping HTTP POST requests onto specific handler methods.
  - `@RequestMapping`: Annotation for mapping web requests onto specific handler methods.
  - `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.

- *Methods*:
  - `public String nominatePrimary(@RequestParam String username)`: Nominates a primary user.
  - `public String nominateSecondaryUser(@RequestParam String username)`: Nominates a secondary user.

- *Fields*:
  - `service : EnrollmentService`: Injected service layer that handles the business logic.

=== UserResponseDTO

The `UserResponseDTO` is a Data Transfer Object used to encapsulate user data.

- *Annotations*:
  - `@Getter`: Lombok annotation to generate getters.
  - `@Setter`: Lombok annotation to generate setters.

- *Fields*:
  - `mobilityUserId : String`
  - `username : String`
  - `vin : String`

=== Enrollment

The `Enrollment` class is an entity representing the enrollment data.

- *Annotations*:
  - `@Entity`: Specifies that the class is an entity.
  - `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
  - `@Id`: Specifies the primary key of an entity.
  - `@Getter`: Lombok annotation to generate getters.
  - `@Setter`: Lombok annotation to generate setters.

- *Fields*:
  - `id : Long`: The primary key.
  - `role : String`: The role of the user in the enrollment.
  - `username : String`: The username of the user.
  - `vin : String`: The vehicle identification number associated with the user.

=== EnrollmentRepository

The `EnrollmentRepository` is the repository layer that handles data persistence.

=== EnrollmentService

The `EnrollmentService` handles the business logic of the enrollment process.

- *Annotations*:
  - `@Autowired`: Marks a field to be autowired by Spring's dependency injection facilities.
  - `@Service`: Indicates that an annotated class is a "Service".

- *Methods*:
  - `public String nominatePrimaryUser(String username)`: Business logic to nominate a primary user.
  - `public String nominateSecondaryUser(String username)`: Business logic to nominate a secondary user.

- *Fields*:
  - `repo : EnrollmentRepository`: Injected repository for database operations.
  - `userClient : UserManagementClient`: Injected Feign client for external user management operations.

=== EnrollmentApplicationTests

The `EnrollmentApplicationTests` class contains the unit tests for the application.

- *Annotations*:
  - `@SpringBootTest`: Provides Spring Boot support for tests.
  - `@Test`: Marks a method to be tested.

== Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business flows within the system.

==== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml User Registration Sequence
actor User
participant EnrollmentController
participant EnrollmentService
participant EnrollmentRepository

User -> EnrollmentController: Request to register
EnrollmentController -> EnrollmentService: initiateRegistration()
EnrollmentService -> EnrollmentRepository: saveUserDetails()
EnrollmentRepository -> EnrollmentService: UserDetailsSaved
EnrollmentService -> EnrollmentController: RegistrationComplete
EnrollmentController -> User: RegistrationResponse
@enduml
----

==== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml Authentication Sequence
actor User
participant "Login Controller" as Login
participant "Authentication Service" as AuthService

User -> Login: LoginRequest(username, password)
Login -> AuthService: authenticate(username, password)
AuthService -> Login: AuthenticationResult
Login -> User: LoginResponse
@enduml
----

==== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml JWT Validation Sequence
actor User
participant "Security Filter" as Security
participant "Authentication Service" as AuthService

User -> Security: Request with JWT
Security -> AuthService: validateToken(JWT)
AuthService -> Security: ValidationResult
Security -> User: AccessDecision
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml ER Diagram
entity "Enrollment" as Enrollment {
  * id : Long
  ---
  role : String
  username : String
  vin : String
}

@enduml
----

=== Detailed Description of Entities

- *Enrollment*: Represents the enrollment of a user. It includes fields for the user's role, username, and vehicle identification number (VIN). The `id` field is the primary key.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **EnrollmentController**:
  - Receives HTTP requests and delegates to **EnrollmentService** for processing.
  - Uses **@Autowired** to inject **EnrollmentService**.

- **EnrollmentService**:
  - Handles business logic and interacts with **EnrollmentRepository** to perform data operations.
  - Uses **@Autowired** to inject **EnrollmentRepository** and **UserManagementClient**.

- **EnrollmentRepository**:
  - Interface to the database, handling CRUD operations for the **Enrollment** entity.

=== Data Flow Through Layers

1. **Controller** receives HTTP request.
2. **Service** layer processes business logic.
3. **Repository** layer interacts with the database.
4. Data flows back through the layers to the user.

=== Exception Propagation

- Exceptions are thrown by the **Repository** or **Service** layers.
- Handled globally by an exception handling mechanism in the **Controller** layer.

=== Transaction Boundaries

- Transactions are typically started at the **Service** layer to ensure data integrity and are committed or rolled back based on the operation outcome.

This document provides a detailed overview of the system architecture, component interactions, and data flow, serving as a comprehensive guide for developers and stakeholders involved in the project.