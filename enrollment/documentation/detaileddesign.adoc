= Detailed Design Documentation for Enrollment System

This document provides a comprehensive detailed design of the Enrollment System developed using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose:* Entry point for the Spring Boot application. It initializes the Spring context and all the beans.

*Annotations:*
- `@EnableFeignClients`: Enables the discovery of interfaces that can be used to make REST calls via Feign.
- `@SpringBootApplication`: Denotes the main configuration class that powers up Spring Boot auto-configuration and component scanning.

*Methods:*
- `main(String[] args)`: The main method which Spring Boot uses to start the application.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "UserClient", url = "http://usermanagement.com")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose:* Defines a Feign client for interacting with the User Management microservice.

*Annotations:*
- `@FeignClient`: Declares that this interface is a Feign client and sets the name and URL of the service it connects to.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate-primary")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }
}
----

*Purpose:* Provides web endpoints for handling enrollment-related requests.

*Annotations:*
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps web requests onto methods in request-handling classes.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.

*Methods:*
- `nominatePrimary(String username)`: Handles the nomination of a primary user by delegating to the `EnrollmentService`.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose:* Data Transfer Object (DTO) for transferring user data.

*Annotations:*
- `@Getter`: Lombok annotation to generate getters for all fields.
- `@Setter`: Lombok annotation to generate setters for all fields.

*Fields:*
- `mobilityUserId`: Identifier for the user in the mobility system.
- `username`: Username of the user.
- `vin`: Vehicle Identification Number associated with the user.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose:* Represents the enrollment entity in the database.

*Annotations:*
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter` and `@Setter`: Lombok annotations to generate getters and setters for all fields.

*Fields:*
- `id`: Unique identifier for the enrollment.
- `role`: Role of the user in the system.
- `username`: Username of the user.
- `vin`: Vehicle Identification Number associated with the user.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose:* Repository interface for `Enrollment` entities, allowing basic CRUD operations and queries.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(username);
        enrollment.setVin(user.getVin());
        repo.save(enrollment);
        return "Nomination Successful";
    }
}
----

*Purpose:* Service layer to handle business logic for enrollment operations.

*Annotations:*
- `@Service`: Marks the class as a service provider, which holds business logic.
- `@Autowired`: Autowires the `EnrollmentRepository` and `UserManagementClient` to interact with the database and external services respectively.

*Methods:*
- `nominatePrimaryUser(String username)`: Retrieves user details from the User Management Client, creates a new enrollment, and saves it to the database.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose:* Contains integration tests to ensure the Spring context loads correctly.

*Annotations:*
- `@SpringBootTest`: Provides support for loading a Spring ApplicationContext and having beans `@Autowired` into your test instance.
- `@Test`: Marks a method to be testable.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-flow, png]
----
@startuml
actor User
participant "EnrollmentController" as Controller
participant "EnrollmentService" as Service
participant "EnrollmentRepository" as Repository

User -> Controller : register(username, details)
Controller -> Service : registerNewUser(username, details)
Service -> Repository : save(new Enrollment)
Repository --> Service : enrollmentSaved
Service --> Controller : registrationSuccess
Controller --> User : registrationSuccessMessage
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-flow, png]
----
@startuml
actor User
participant "AuthenticationController" as AuthController
participant "AuthenticationService" as AuthService
participant "UserRepository" as UserRepo

User -> AuthController : login(username, password)
AuthController -> AuthService : authenticate(username, password)
AuthService -> UserRepo : findByUsername(username)
UserRepo --> AuthService : user
AuthService --> AuthController : authenticationResult
AuthController --> User : authenticationToken
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-flow, png]
----
@startuml
actor User
participant "JWTFilter" as Filter
participant "TokenProvider" as TokenProvider

User -> Filter : request(resource)
Filter -> TokenProvider : validateToken(token)
TokenProvider --> Filter : isValid
Filter --> User : proceed / error
@enduml
----

=== Business Process Flow

[plantuml, business-process-flow, png]
----
@startuml
actor User
participant "BusinessProcessController" as BPC
participant "BusinessProcessService" as BPS
participant "BusinessProcessRepository" as BPR

User -> BPC : initiateProcess(data)
BPC -> BPS : startProcess(data)
BPS -> BPR : save(processData)
BPR --> BPS : processSaved
BPS --> BPC : processStarted
BPC --> User : processStatus
@enduml
----

=== Exception Handling Flow

[plantuml, exception-handling-flow, png]
----
@startuml
actor User
participant "Controller" as C
participant "Service" as S
participant "Repository" as R

User -> C : request(action)
C -> S : performAction()
S -> R : save(data)
R --> S : saveError
S --> C : handleException
C --> User : errorMessage
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "Enrollment" {
    * id : Long
    --
    * role : String
    * username : String
    * vin : String
}

entity "User" {
    * username : String
    --
    * password : String
    * email : String
}

Enrollment ||..|| User : "has"
@enduml
----

*Enrollment:* Represents the enrollment details of a user. Each enrollment is uniquely identified by an `id`. It contains the `role`, `username`, and `vin` of the enrolled user.

*User:* Represents a user in the system. Each user is uniquely identified by a `username`. It contains the `password` and `email` of the user.

*Relationships:*
- Each `Enrollment` is associated with one `User`. This is a one-to-one relationship where each enrollment record is linked to a specific user.

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

1. **Controller Layer:** Handles HTTP requests, delegates business processing to the service layer, and returns the response.
2. **Service Layer:** Contains business logic, interacts with the repository layer for data access, and handles business exceptions.
3. **Repository Layer:** Provides data access functionalities, typically by extending `JpaRepository`.

*Data Flow:*
- The controller receives the request, calls the appropriate service method.
- The service performs the business logic and interacts with the repository for data persistence.
- The repository interacts with the database and returns data to the service.
- The service may handle exceptions and return control to the controller.
- The controller sends the response back to the client.

*Exception Propagation:*
- Exceptions can occur at the repository level (e.g., database errors) and are propagated to the service layer.
- The service layer can catch these exceptions, possibly perform some custom handling, and rethrow them or return error messages to the controller.
- The controller catches exceptions and formats them into user-readable messages or error responses.

*Transaction Boundaries:*
- Transactions are typically started at the service layer. This ensures that all operations performed within a single service method are part of the same transaction context.
- Spring manages transaction boundaries using the `@Transactional` annotation.

This detailed design document provides a thorough overview of the system architecture, data flow, and interactions within the Enrollment System. It serves as a guide for developers to understand and implement the system's functionalities effectively.