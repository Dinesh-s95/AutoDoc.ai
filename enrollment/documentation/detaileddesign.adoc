= Detailed Design Documentation for Enrollment System

This document provides a comprehensive detailed design of the Enrollment System developed using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Annotations:*
- `@EnableFeignClients`: Enables the discovery of interfaces that can be used to make REST calls via Feign.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods:*
- `main(String[] args)`: The main method which launches the Spring Boot application.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "userClient", url = "http://usermanagement.com")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose:* Defines a Feign client for interacting with the User Management microservice.

*Annotations:*
- `@FeignClient`: Declares that this interface is a Feign client and sets its configuration.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate-primary")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }

    @PostMapping("/nominate-secondary")
    public String nominateSecondary(@RequestParam String username) {
        return service.nominateSecondaryUser(username);
    }
}
----

*Purpose:* Handles incoming HTTP requests related to enrollment operations.

*Annotations:*
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps HTTP requests to handler methods of MVC and REST controllers.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.

*Methods:*
- `nominatePrimary(String username)`: Nominates a primary user.
- `nominateSecondary(String username)`: Nominates a secondary user.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose:* Data Transfer Object for user information.

*Annotations:*
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose:* Represents the enrollment entity in the database.

*Annotations:*
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose:* Repository interface for `Enrollment` entity, leveraging Spring Data JPA.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        // Implementation details
    }

    public String nominateSecondaryUser(String username) {
        // Implementation details
    }
}
----

*Purpose:* Service layer to handle the business logic of enrollment operations.

*Annotations:*
- `@Service`: Indicates that an annotated class is a "Service", originally defined by Domain-Driven Design (DDD) as "an operation offered as an interface that stands alone in the model, with no encapsulated state."

*Methods:*
- `nominatePrimaryUser(String username)`: Business logic to nominate a primary user.
- `nominateSecondaryUser(String username)`: Business logic to nominate a secondary user.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose:* Test class for the Enrollment application to ensure context loading.

*Annotations:*
- `@SpringBootTest`: Provides a bridge between Spring Boot test features and JUnit.
- `@Test`: Denotes that a method is a test method.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "EnrollmentController" as Controller
participant "EnrollmentService" as Service
participant "EnrollmentRepository" as Repository

User -> Controller : register(username, details)
Controller -> Service : registerUser(username, details)
Service -> Repository : save(new Enrollment())
Repository --> Service : enrollment
Service --> Controller : "Registration Successful"
Controller --> User : "Registration Successful"
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "AuthController" as Controller
participant "AuthService" as Service
participant "UserRepository" as Repository

User -> Controller : login(username, password)
Controller -> Service : authenticate(username, password)
Service -> Repository : findByUsername(username)
Repository --> Service : user
Service --> Controller : generateToken(user)
Controller --> User : token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "AuthController" as Controller
participant "AuthService" as Service

User -> Controller : request(resource)
Controller -> Service : validateToken(token)
Service --> Controller : user_details
Controller --> User : resource
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "Enrollment" {
    * id : Long
    --
    * role : String
    * username : String
    * vin : String
}
@enduml
----

*Enrollment*: Represents the enrollment details of a user. It includes fields for user identification, role, and vehicle identification number (VIN).

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

*EnrollmentController* -> *EnrollmentService*:
- The controller receives HTTP requests and delegates business processing to the service layer.

*EnrollmentService* -> *EnrollmentRepository*:
- The service layer interacts with the repository to perform CRUD operations on the database.

=== Data Flow Through Layers

1. HTTP Request -> Controller
2. Controller -> Service (Business Logic)
3. Service -> Repository (Data Access)
4. Repository -> Database
5. Database -> Repository
6. Repository -> Service
7. Service -> Controller
8. Controller -> HTTP Response

=== Exception Propagation

Exceptions are thrown at the repository or service layer and are propagated up to the controller where they are handled and an appropriate response is sent back to the client.

=== Transaction Boundaries

Transactions are typically started at the service layer to ensure data consistency during business operations. Spring manages transactions declaratively using the `@Transactional` annotation.

This detailed design document provides an in-depth view of the system architecture, facilitating a clear understanding for developers involved in the project.