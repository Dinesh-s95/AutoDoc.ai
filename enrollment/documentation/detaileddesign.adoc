= Detailed Design Documentation for Enrollment System

This document provides a comprehensive detailed design of the Enrollment System. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== EnrollmentApplication

*Purpose*: Acts as the entry point of the Spring Boot application.

*Annotations*:
- `@EnableFeignClients`: Enables Feign REST clients.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods*:
- `public static void main(String[] args)`: The main method that Spring Boot uses to start the application.

=== UserManagementClient

*Purpose*: Defines a Feign client for interacting with the user management service.

*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client.
- `@GetMapping`: Used on methods to handle HTTP GET requests.
- `@RequestParam`: Indicates method parameter should be bound to a web request parameter.

=== EnrollmentController

*Purpose*: Handles incoming HTTP requests related to enrollment operations.

*Annotations*:
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.
- `@Autowired`: Marks a constructor, field, setter method, or config method as to be autowired by Spring's dependency injection facilities.
- `@PostMapping`: Used on methods to handle HTTP POST requests.
- `@RequestMapping`: Provides routing information. It tells Spring that any HTTP request with the path should be mapped to the corresponding method.

*Methods*:
- `nominatePrimary(String username)`: Nominates a primary user.
- `nominateSecondary(String username)`: Nominates a secondary user.

*Fields*:
- `service: EnrollmentService`: Injected service layer that handles business logic.

=== UserResponseDTO

*Purpose*: Data Transfer Object for user responses.

*Annotations*:
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

*Fields*:
- `mobilityUserId: String`
- `username: String`
- `vin: String`

=== Enrollment

*Purpose*: Represents the enrollment entity in the database.

*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

*Fields*:
- `id: Long`: The primary key.
- `role: String`: The role of the user in the system.
- `username: String`: The username of the user.
- `vin: String`: Vehicle identification number associated with the user.

=== EnrollmentRepository

*Purpose*: Interface for database operations related to `Enrollment` entities.

=== EnrollmentService

*Purpose*: Service layer to handle business logic for enrollment operations.

*Annotations*:
- `@Service`: Indicates that an annotated class is a "Service", originally defined by Domain-Driven Design (DDD) as "an operation offered as an interface that stands alone in the model, with no encapsulated state."

*Methods*:
- `nominatePrimaryUser(String username)`: Business logic to nominate a primary user.
- `nominateSecondaryUser(String username)`: Business logic to nominate a secondary user.

*Fields*:
- `repo: EnrollmentRepository`: Injected repository for database operations.
- `userClient: UserManagementClient`: Injected Feign client for external user management service.

=== EnrollmentApplicationTests

*Purpose*: Contains integration tests for the application.

*Annotations*:
- `@SpringBootTest`: Provides Spring Boot test features.
- `@Test`: Marks a method as a test method.

== 2. Runtime View Diagrams

=== Sequence Diagrams

The following sequence diagrams illustrate key business flows:

==== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "EnrollmentController" as Controller
participant "EnrollmentService" as Service
participant "EnrollmentRepository" as Repository

User -> Controller : register(username, details)
Controller -> Service : registerUser(username, details)
Service -> Repository : save(new Enrollment)
Repository --> Service : enrollmentSaved
Service --> Controller : return "Success"
Controller --> User : "User Registered Successfully"
@enduml
----

==== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "AuthenticationController" as AuthController
participant "AuthenticationService" as AuthService
participant "UserRepository" as UserRepo

User -> AuthController : login(username, password)
AuthController -> AuthService : authenticate(username, password)
AuthService -> UserRepo : findByUsername(username)
UserRepo --> AuthService : user
AuthService --> AuthController : token
AuthController --> User : token
@enduml
----

==== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "ResourceController" as Resource
participant "JWTService" as JWT

User -> Resource : request(resource)
Resource -> JWT : validate(token)
JWT --> Resource : isValid
Resource --> User : resourceData
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "Enrollment" {
  *id : Long
  ---
  role : String
  username : String
  vin : String
}

@enduml
----

=== Detailed Description of Entities

*Enrollment*: Represents the enrollment of a user, storing their role, username, and vehicle identification number (VIN). The `id` field is the primary key.

== 4. Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **EnrollmentController** receives HTTP requests and delegates to **EnrollmentService** for processing.
- **EnrollmentService** performs business logic and interacts with **EnrollmentRepository** to perform CRUD operations on the database.

=== Data Flow Through Layers

- Data flows from controllers to services where business logic is applied. Then data is persisted or retrieved from the database through repositories.

=== Exception Propagation

- Exceptions are thrown by the repositories or services and are caught in controllers where appropriate HTTP responses are generated.

=== Transaction Boundaries

- Transactions are managed at the service layer, ensuring that database operations are completed successfully before returning a response.

This document provides a detailed view of the system's architecture and should serve as a guide for development and maintenance.