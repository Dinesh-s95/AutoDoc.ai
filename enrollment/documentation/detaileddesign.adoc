= Enrollment System Detailed Design Document

This document provides a detailed design analysis for the Enrollment System, designed using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: Serves as the entry point for the Spring Boot application. Initializes and runs the application context.

*Annotations*:
- `@EnableFeignClients`: Enables Feign clients in the application, allowing for declarative REST client creation.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods*:
- `main(String[] args)`: The main method that Spring Boot uses to start the application.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "userClient", url = "http://usermanagement.com")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose*: Defines a Feign client for interacting with the User Management microservice.

*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client and specifies the service name and URL.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }

    @GetMapping("/greet")
    public String greet() {
        return "Hello, welcome to the enrollment system!";
    }
}
----

*Purpose*: Handles incoming HTTP requests related to enrollments.

*Annotations*:
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps HTTP requests to handler methods of MVC and REST controllers.
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.

*Methods*:
- `nominatePrimary(String username)`: Nominates a primary user based on the provided username.
- `greet()`: Returns a greeting message.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: Data Transfer Object (DTO) for transferring user data.

*Annotations*:
- `@Getter`: Lombok annotation to generate getters for all fields.
- `@Setter`: Lombok annotation to generate setters for all fields.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: Represents the Enrollment entity in the database.

*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter` and `@Setter`: Auto-generate getters and setters.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: Repository interface for `Enrollment` entities, leveraging Spring Data JPA.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(username);
        enrollment.setRole("Primary");
        repo.save(enrollment);
        return "User nominated as primary";
    }
}
----

*Purpose*: Provides business services for enrollment operations.

*Annotations*:
- `@Service`: Indicates that the class provides some business functionalities.
- `@Autowired`: Injects object dependency implicitly.

*Methods*:
- `nominatePrimaryUser(String username)`: Nominates a user as primary by saving an enrollment record.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {

    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: Provides integration tests for the Enrollment Application.

*Annotations*:
- `@SpringBootTest`: Provides support for loading a Spring ApplicationContext and having beans `@Autowired` into your test instance.
- `@Test`: Denotes that a method is a test method.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-flow, png]
----
@startuml
actor User
User -> EnrollmentController: POST /register (username, password)
EnrollmentController -> EnrollmentService: registerUser(username, password)
EnrollmentService -> UserRepository: save(newUser)
UserRepository --> EnrollmentService: userSaved
EnrollmentService --> EnrollmentController: registrationSuccess
EnrollmentController --> User: Registration Successful
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-flow, png]
----
@startuml
actor User
User -> EnrollmentController: POST /login (username, password)
EnrollmentController -> AuthenticationService: authenticate(username, password)
AuthenticationService -> UserRepository: findUser(username)
UserRepository --> AuthenticationService: userFound
AuthenticationService --> EnrollmentController: authenticationSuccess
EnrollmentController --> User: Login Successful
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-flow, png]
----
@startuml
actor Client
Client -> APIGateway: Request with JWT
APIGateway -> JWTService: validateToken(JWT)
JWTService -> APIGateway: isValid
APIGateway --> Client: Proceed if valid
@enduml
----

=== Exception Handling Flow

[plantuml, exception-handling-flow, png]
----
@startuml
actor User
User -> EnrollmentController: POST /nominate (username)
EnrollmentController -> EnrollmentService: nominatePrimaryUser(username)
alt username not found
    EnrollmentService -> EnrollmentController: throw UsernameNotFoundException
    EnrollmentController --> User: Error - Username not found
else other error
    EnrollmentService -> EnrollmentController: throw GenericException
    EnrollmentController --> User: Error - Operation failed
end
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "Enrollment" {
    *id : Long
    --
    *role : String
    *username : String
    *vin : String
}

@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **EnrollmentController**:
  - Receives HTTP requests.
  - Calls **EnrollmentService** methods based on the request.
- **EnrollmentService**:
  - Contains business logic.
  - Interacts with **EnrollmentRepository** to persist data.
- **EnrollmentRepository**:
  - Extends JpaRepository, interfacing directly with the database.

=== Data Flow Through Layers

1. **Controller** receives the HTTP request.
2. **Service** layer processes the request, applying business rules.
3. **Repository** layer interacts with the database.
4. Data is sent back up through the layers to the user.

=== Exception Propagation

- Exceptions are thrown by the **Service** layer.
- Caught by the **Controller**, which then translates them into appropriate HTTP responses.

=== Transaction Boundaries

- Defined at the **Service** layer, ensuring that database operations are completed successfully before committing the transaction.

This detailed design document provides a comprehensive overview of the Enrollment System, ensuring developers have a clear understanding of the architecture and can maintain or extend the system effectively.