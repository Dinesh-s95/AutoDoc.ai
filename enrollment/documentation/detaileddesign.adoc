= Detailed Design Documentation for Enrollment Application

This document provides a comprehensive detailed design overview of the Enrollment Application, focusing on its Java Spring Boot implementation. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: Serves as the entry point for the Spring Boot application. Initializes the application context and all Spring-managed beans.

*Annotations*:
- `@EnableFeignClients`: Enables the discovery of interfaces that declare they are Feign clients.
- `@SpringBootApplication`: Serves as a convenience annotation that adds all of the following:
  - `@Configuration`: Tags the class as a source of bean definitions.
  - `@EnableAutoConfiguration`: Tells Spring Boot to start adding beans based on classpath settings, other beans, and various property settings.
  - `@ComponentScan`: Tells Spring to scan the package of the annotated class for Spring components.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "user-service")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose*: Defines a Feign client for interacting with an external user management service.

*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client and specifies the service it connects to.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates that a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }
}
----

*Purpose*: Handles all web requests related to enrollments.

*Annotations*:
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps web requests onto methods in request-handling classes with flexible method signatures.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@Autowired`: Marks a constructor, field, setter method, or config method as to be autowired by Spring's dependency injection facilities.

*Methods*:
- `nominatePrimary(String username)`: Delegates to the `EnrollmentService` to process the nomination of a primary user.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: Data Transfer Object (DTO) for user information.

*Annotations*:
- `@Getter`: Lombok annotation to generate getters for all fields.
- `@Setter`: Lombok annotation to generate setters for all fields.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: Represents the enrollment entity in the database.

*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: Repository interface for `Enrollment` entities, leveraging Spring Data JPA.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(username);
        enrollment.setRole("PRIMARY");
        enrollment.setVin(user.getVin());
        repo.save(enrollment);
        return "Nomination successful";
    }
}
----

*Purpose*: Contains business logic for nominating a primary user.

*Annotations*:
- `@Service`: Indicates that the class holds business logic.

*Methods*:
- `nominatePrimaryUser(String username)`: Handles the logic for nominating a primary user by interacting with the `UserManagementClient` and `EnrollmentRepository`.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: Provides basic integration tests to ensure the Spring context loads correctly.

*Annotations*:
- `@SpringBootTest`: Provides support for loading a Spring ApplicationContext and having beans `@Autowired` into your test instance.
- `@Test`: Marks a method to be testable.

== Runtime View Diagrams

=== Sequence Diagram: User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "EnrollmentController" as Controller
participant "EnrollmentService" as Service
participant "EnrollmentRepository" as Repo

User -> Controller : nominatePrimary(username)
Controller -> Service : nominatePrimaryUser(username)
Service -> Repo : save(enrollment)
Repo -> Service : return
Service -> Controller : return "Nomination successful"
Controller -> User : return "Nomination successful"
@enduml
----

=== Sequence Diagram: Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "AuthenticationController" as AuthController
participant "AuthenticationService" as AuthService
participant "UserRepository" as UserRepo

User -> AuthController : login(username, password)
AuthController -> AuthService : authenticate(username, password)
AuthService -> UserRepo : findByUsername(username)
UserRepo -> AuthService : return user
AuthService -> AuthController : return token
AuthController -> User : return token
@enduml
----

=== Sequence Diagram: JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "TokenValidationController" as TokenController
participant "TokenService" as TokenService

User -> TokenController : validateToken(token)
TokenController -> TokenService : verifyToken(token)
TokenService -> TokenController : return isValid
TokenController -> User : return isValid
@enduml
----

== Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "Enrollment" {
    * id : Long
    ---
    role : String
    username : String
    vin : String
}

note right of "Enrollment" : Primary key is "id"
@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- **EnrollmentController**:
  - Receives HTTP requests.
  - Delegates business logic execution to **EnrollmentService**.
  - Returns response based on the outcome provided by the service layer.

- **EnrollmentService**:
  - Handles business logic.
  - Interacts with **EnrollmentRepository** to persist data.
  - Communicates with external services through **UserManagementClient**.

- **EnrollmentRepository**:
  - Provides data access functionalities.
  - Extends `JpaRepository`, benefiting from CRUD operations and JPA optimizations.

=== Data Flow Through Layers

1. **Controller** receives a request.
2. **Service** layer processes the request, performing business logic.
3. **Repository** layer interacts with the database.
4. Data flows back through the layers to the user.

=== Exception Propagation

- Exceptions are thrown by the repository or service layers.
- Handled globally by an exception handling component (`@ControllerAdvice`), which catches and formats them before sending to the client.

=== Transaction Boundaries

- Defined at the service layer (`@Transactional`), ensuring that database operations either complete entirely or roll back in case of an error.

This detailed design document should provide developers with a clear understanding of the implementation and operation of the Enrollment Application.