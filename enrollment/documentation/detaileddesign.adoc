= Enrollment System Detailed Design Documentation

This document provides a detailed design overview of the Enrollment System implemented using Java Spring Boot. It includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== 1. Class-by-Class Analysis

=== 1.1 EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: This is the main class that bootstraps the Spring Boot application. It also enables the discovery of Feign clients for microservices communication.

*Annotations*:
- `@EnableFeignClients`: Allows the discovery of interfaces that declare they are Feign clients.
- `@SpringBootApplication`: Denotes the main configuration class that combines `@Configuration`, `@EnableAutoConfiguration`, and `@ComponentScan` annotations.

*Methods*:
- `main(String[] args)`: The entry point of the Spring Boot application.

=== 1.2 UserManagementClient

[source,java]
----
@FeignClient(name = "UserManagement")
public interface UserManagementClient {
    @GetMapping("/users/{username}")
    UserResponseDTO getUserByUsername(@RequestParam String username);
}
----

*Purpose*: This interface defines a Feign client for communicating with the User Management microservice.

*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client and specifies the name of the service it connects to.
- `@GetMapping`: Used on methods to define the HTTP GET mapping between a method and a URL endpoint.
- `@RequestParam`: Indicates that a method parameter should be bound to a web request parameter.

=== 1.3 EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate-primary")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }
}
----

*Purpose*: Provides RESTful web services for enrollment operations.

*Annotations*:
- `@RestController`: Indicates that the data returned by each method will be written straight into the response body instead of rendering a template.
- `@RequestMapping`: Declares that all APIs in this controller are prefixed with `/enrollment`.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.

*Methods*:
- `nominatePrimary(String username)`: Nominates a primary user by username.

=== 1.4 UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: Data Transfer Object (DTO) for transferring user data.

*Annotations*:
- `@Getter`: Lombok annotation to generate getters for all fields.
- `@Setter`: Lombok annotation to generate setters for all fields.

=== 1.5 Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: Represents the enrollment entity stored in the database.

*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Marks the id field as the primary key.
- `@GeneratedValue`: Specifies the strategy for generating the primary key values.
- `@Getter` and `@Setter`: Auto-generate getters and setters.

=== 1.6 EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: Repository interface for `Enrollment` entity, leveraging Spring Data JPA.

=== 1.7 EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(username);
        enrollment.setRole("PRIMARY");
        repo.save(enrollment);
        return "User nominated as primary";
    }
}
----

*Purpose*: Service layer to handle the business logic of enrollment processes.

*Annotations*:
- `@Service`: Indicates that the class provides some business functionalities.
- `@Autowired`: Marks a dependency which Spring resolves and injects automatically.

*Methods*:
- `nominatePrimaryUser(String username)`: Handles the nomination of a primary user.

=== 1.8 EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: Basic Spring Boot test to ensure the application context loads properly.

*Annotations*:
- `@SpringBootTest`: Used to provide a bridge between Spring Boot test features and JUnit.

== 2. Runtime View Diagrams

=== 2.1 User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User
participant "RegistrationController" as RC
participant "UserService" as US
participant "UserRepository" as UR

User -> RC : register(userDetails)
RC -> US : createUser(userDetails)
US -> UR : save(newUser)
UR --> US : userSaved
US --> RC : userDTO
RC --> User : registrationConfirmation
@enduml
----

=== 2.2 Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User
participant "AuthController" as AC
participant "AuthService" as AS
participant "UserRepository" as UR

User -> AC : login(credentials)
AC -> AS : authenticate(credentials)
AS -> UR : findByUsername(username)
UR --> AS : user
AS --> AC : authToken
AC --> User : authToken
@enduml
----

=== 2.3 JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User
participant "AuthController" as AC
participant "JWTService" as JS

User -> AC : request(accessToken)
AC -> JS : validateToken(accessToken)
JS --> AC : isValid
AC --> User : accessGranted
@enduml
----

== 3. Entity Relationship Diagram

[plantuml, er-diagram, png]
----
@startuml
entity "User" {
    * id : Long
    --
    * username : String
    * password : String
    * email : String
}

entity "Enrollment" {
    * id : Long
    --
    * role : String
    * username : String
    * vin : String
}

User ||--o{ Enrollment : "has"
@enduml
----

*Entities*:
- **User**: Represents a user in the system with attributes such as username, password, and email.
- **Enrollment**: Represents an enrollment record linked to a user, containing attributes like role, username, and vehicle identification number (VIN).

*Relationships*:
- A **User** can have multiple **Enrollments**.

== 4. Detailed Component Interactions

=== 4.1 Controller-Service-Repository Interactions

*EnrollmentController* -> *EnrollmentService*:
- The controller receives HTTP requests and delegates business processing to the service layer.

*EnrollmentService* -> *EnrollmentRepository*:
- The service layer interacts with the repository to perform CRUD operations on the database.

=== 4.2 Data Flow Through Layers

1. **Controller**: Receives and handles HTTP request.
2. **Service**: Executes business logic.
3. **Repository**: Performs database operations.

=== 4.3 Exception Propagation

Exceptions are thrown from the repository or service layers and are caught in the controllers where appropriate HTTP responses are generated.

=== 4.4 Transaction Boundaries

Transactions are managed at the service layer, ensuring that database operations are completed successfully before committing the transaction.

This detailed design document should assist developers in understanding and implementing the specified functionalities in the Enrollment System.