= Detailed Design Documentation for Enrollment Application

This document provides a comprehensive detailed design of the Enrollment Application, which is built using Java Spring Boot. The document includes class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose:* Serves as the entry point for the Spring Boot application. Initializes the application context and all Spring Boot components.

*Annotations:*
- `@EnableFeignClients`: Enables the discovery of interfaces that declare they are Feign clients (for making REST calls).
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

*Methods:*
- `main(String[] args)`: The main method which Spring Boot uses to start the application.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "userClient", url = "http://usermanagement/")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose:* Defines a Feign client for interacting with the User Management microservice.

*Annotations:*
- `@FeignClient`: Declares that this interface is a Feign client with a specific name and URL.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {
    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }

    @GetMapping("/greet")
    public String greet() {
        return "Hello, welcome to the Enrollment service!";
    }
}
----

*Purpose:* Acts as the REST controller to handle HTTP requests related to enrollments.

*Annotations:*
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps web requests onto methods in request-handling classes.
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.

*Methods:*
- `nominatePrimary(String username)`: Nominates a primary user based on the username.
- `greet()`: Provides a greeting message.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose:* Data Transfer Object (DTO) for user responses.

*Annotations:*
- `@Getter`: Lombok annotation to generate getters for all fields.
- `@Setter`: Lombok annotation to generate setters for all fields.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose:* Represents the Enrollment entity in the database.

*Annotations:*
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides the specification of generation strategies for the values of primary keys.
- `@Getter`, `@Setter`: Lombok annotations to generate getters and setters for all fields.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose:* Repository interface for `Enrollment` entities, extending Spring Data JPA.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {
    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(user.getUsername());
        enrollment.setVin(user.getVin());
        enrollment.setRole("Primary");
        repo.save(enrollment);
        return "User nominated as primary";
    }
}
----

*Purpose:* Service class to handle business logic for enrollment operations.

*Annotations:*
- `@Service`: Indicates that an annotated class is a "Service", originally defined by Domain-Driven Design (DDD) as "an operation offered as an interface that stands alone in the model, with no encapsulated state."
- `@Autowired`: Marks a constructor, field, setter method, or config method to be autowired by Spring's dependency injection facilities.

*Methods:*
- `nominatePrimaryUser(String username)`: Nominates a primary user by creating an enrollment record.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {
    @Test
    public void contextLoads() {
    }
}
----

*Purpose:* Test class for the Enrollment Application to ensure the Spring context loads properly.

*Annotations:*
- `@SpringBootTest`: Provides support for loading a Spring ApplicationContext and having beans `@Autowired` into your test instance.
- `@Test`: Marks a method to be testable with JUnit.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-sequence, png]
----
@startuml
actor User as user
participant "EnrollmentController" as controller
participant "EnrollmentService" as service
participant "EnrollmentRepository" as repo

user -> controller : nominatePrimary(username)
controller -> service : nominatePrimaryUser(username)
service -> repo : save(enrollment)
repo -> service : return
service -> controller : return "User nominated as primary"
controller -> user : return "User nominated as primary"
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-sequence, png]
----
@startuml
actor User as user
participant "AuthenticationController" as authController
participant "AuthenticationService" as authService
participant "UserRepository" as userRepo

user -> authController : login(username, password)
authController -> authService : authenticate(username, password)
authService -> userRepo : findByUsername(username)
userRepo -> authService : return user
authService -> authController : return token
authController -> user : return token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-sequence, png]
----
@startuml
actor User as user
participant "JWTFilter" as jwtFilter
participant "JWTUtil" as jwtUtil

user -> jwtFilter : request(resource)
jwtFilter -> jwtUtil : validateToken(token)
jwtUtil -> jwtFilter : return validationStatus
jwtFilter -> user : proceed / error
@enduml
----

== Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "Enrollment" {
    *id : Long
    ---
    role : String
    username : String
    vin : String
}

@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

1. **Controller to Service:**
   - The `EnrollmentController` receives HTTP requests and delegates business logic execution to the `EnrollmentService`.
   - Methods like `nominatePrimary()` in the controller call corresponding methods in the service.

2. **Service to Repository:**
   - The `EnrollmentService` interacts with the `EnrollmentRepository` to persist and retrieve data.
   - Operations like `save(enrollment)` are typical interactions where the service layer communicates with the database layer through the repository.

=== Data Flow Through Layers

- Data flows from the controllers to services where business logic is applied. Then, data is persisted or updated in the database through repositories. Data then flows back to the user as HTTP responses.

=== Exception Propagation

- Exceptions can occur at any layer (controller, service, or repository).
- Spring's `@ControllerAdvice` can be used to handle exceptions globally and return proper error responses.

=== Transaction Boundaries

- Transactions are typically started at the service layer using `@Transactional`. This ensures that database operations either complete successfully or rollback entirely in case of an error.

This detailed design document aims to provide developers with a clear understanding of the application's architecture, flow, and interactions. It serves as a guide for further development, maintenance, and troubleshooting of the Enrollment Application.