= Enrollment System Detailed Design Documentation

== Introduction

This document provides a detailed design overview of the Enrollment System, developed using Java Spring Boot. It outlines the system architecture, including class-by-class analysis, runtime view diagrams, entity relationship diagrams, and detailed component interactions.

== Class-by-Class Analysis

=== EnrollmentApplication

[source,java]
----
@EnableFeignClients
@SpringBootApplication
public class EnrollmentApplication {
    public static void main(String[] args) {
        SpringApplication.run(EnrollmentApplication.class, args);
    }
}
----

*Purpose*: Acts as the bootstrap class for the Spring Boot application.
*Annotations*:
- `@EnableFeignClients`: Enables Feign REST clients.
- `@SpringBootApplication`: Indicates a configuration class that declares one or more `@Bean` methods and also triggers auto-configuration and component scanning.

=== UserManagementClient

[source,java]
----
@FeignClient(name = "userClient", url = "http://usermanagement.com")
public interface UserManagementClient {
    @GetMapping("/users")
    UserResponseDTO getUserByUsername(@RequestParam("username") String username);
}
----

*Purpose*: Defines a Feign client for communicating with the User Management service.
*Annotations*:
- `@FeignClient`: Declares that this interface is a Feign client.
- `@GetMapping`: Maps HTTP GET requests onto specific handler methods.
- `@RequestParam`: Indicates a method parameter should be bound to a web request parameter.

=== EnrollmentController

[source,java]
----
@RestController
@RequestMapping("/enrollment")
public class EnrollmentController {

    @Autowired
    private EnrollmentService service;

    @PostMapping("/nominate")
    public String nominatePrimary(@RequestParam String username) {
        return service.nominatePrimaryUser(username);
    }

    @GetMapping("/greet")
    public String greet() {
        return "Hello, welcome to the Enrollment System!";
    }
}
----

*Purpose*: Provides web endpoints for enrollment operations.
*Annotations*:
- `@RestController`: Marks the class as a controller where every method returns a domain object instead of a view.
- `@RequestMapping`: Maps web requests onto methods in request-handling classes.
- `@PostMapping`: Maps HTTP POST requests onto specific handler methods.
- `@Autowired`: Marks a constructor, field, or setter method to be autowired by Spring's dependency injection facilities.

=== UserResponseDTO

[source,java]
----
@Getter
@Setter
public class UserResponseDTO {
    private String mobilityUserId;
    private String username;
    private String vin;
}
----

*Purpose*: Data Transfer Object for user information.
*Annotations*:
- `@Getter`: Lombok annotation to generate getters.
- `@Setter`: Lombok annotation to generate setters.

=== Enrollment

[source,java]
----
@Entity
@Getter
@Setter
public class Enrollment {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String role;
    private String username;
    private String vin;
}
----

*Purpose*: Represents the enrollment entity.
*Annotations*:
- `@Entity`: Specifies that the class is an entity and is mapped to a database table.
- `@Id`: Specifies the primary key of an entity.
- `@GeneratedValue`: Provides for the specification of generation strategies for the values of primary keys.
- `@Getter` / `@Setter`: Lombok annotations to generate getters and setters.

=== EnrollmentRepository

[source,java]
----
public interface EnrollmentRepository extends JpaRepository<Enrollment, Long> {
}
----

*Purpose*: Repository interface for `Enrollment` entity, leveraging Spring Data JPA.

=== EnrollmentService

[source,java]
----
@Service
public class EnrollmentService {

    @Autowired
    private EnrollmentRepository repo;
    @Autowired
    private UserManagementClient userClient;

    public String nominatePrimaryUser(String username) {
        UserResponseDTO user = userClient.getUserByUsername(username);
        Enrollment enrollment = new Enrollment();
        enrollment.setUsername(user.getUsername());
        enrollment.setVin(user.getVin());
        enrollment.setRole("Primary");
        repo.save(enrollment);
        return "User nominated as primary";
    }
}
----

*Purpose*: Service layer to handle the business logic of enrollment.
*Annotations*:
- `@Service`: Indicates that an annotated class is a "Service", originally defined by Domain-Driven Design (DDD) as "an operation offered as an interface that stands alone in the model, with no encapsulated state."
- `@Autowired`: Marks a constructor, field, or setter method to be autowired by Spring's dependency injection facilities.

=== EnrollmentApplicationTests

[source,java]
----
@SpringBootTest
public class EnrollmentApplicationTests {

    @Test
    public void contextLoads() {
    }
}
----

*Purpose*: Basic integration test to check the Spring Application context loads correctly.
*Annotations*:
- `@SpringBootTest`: Provides a bridge between Spring Boot test features and JUnit.
- `@Test`: Denotes that a method is a test method.

== Runtime View Diagrams

=== User Registration Flow

[plantuml, user-registration-flow, png]
----
@startuml
actor User
participant "EnrollmentController" as Controller
participant "EnrollmentService" as Service
participant "EnrollmentRepository" as Repository

User -> Controller : nominatePrimary(username)
Controller -> Service : nominatePrimaryUser(username)
Service -> Repository : save(enrollment)
Repository --> Service : enrollmentSaved
Service --> Controller : "User nominated as primary"
Controller --> User : "User nominated as primary"
@enduml
----

=== Authentication/Login Flow

[plantuml, authentication-flow, png]
----
@startuml
actor User
participant "AuthenticationController" as AuthController
participant "AuthenticationService" as AuthService
participant "UserRepository" as UserRepo

User -> AuthController : login(username, password)
AuthController -> AuthService : authenticate(username, password)
AuthService -> UserRepo : findByUsername(username)
UserRepo --> AuthService : user
AuthService --> AuthController : token
AuthController --> User : token
@enduml
----

=== JWT Token Validation Flow

[plantuml, jwt-validation-flow, png]
----
@startuml
actor User
participant "JWTFilter" as Filter
participant "TokenProvider" as TokenProvider

User -> Filter : request(resource)
Filter -> TokenProvider : validateToken(token)
TokenProvider --> Filter : isValid
Filter --> User : proceed / error
@enduml
----

== Entity Relationship Diagram

[plantuml, entity-relationship-diagram, png]
----
@startuml
entity "Enrollment" {
    *id : Long
    --
    *username : String
    *role : String
    *vin : String
}
@enduml
----

== Detailed Component Interactions

=== Controller-Service-Repository Interactions

- `EnrollmentController` receives HTTP requests and delegates to `EnrollmentService`.
- `EnrollmentService` handles business logic and interacts with `EnrollmentRepository` for data persistence.
- `EnrollmentRepository` extends `JpaRepository`, providing CRUD operations on `Enrollment` entities.

=== Data Flow Through Layers

- Data flows from Controllers to Services where business logic is applied.
- Services interact with Repositories to fetch or persist data.
- Data then flows back to the controller and finally to the client.

=== Exception Propagation

- Exceptions are thrown by Repositories or Services when data constraints are violated or data is not found.
- Controllers handle these exceptions and translate them into appropriate HTTP responses.

=== Transaction Boundaries

- Transactions are typically started at the service layer.
- `@Transactional` annotation ensures that the operations within a service method are completed successfully before the transaction is committed.

== Conclusion

This detailed design document provides a comprehensive overview of the Enrollment System, designed to aid developers in understanding the implementation and facilitating future maintenance and scalability.